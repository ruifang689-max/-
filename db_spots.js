/**
 * db_spots.js - æ™¯é»èˆ‡è·¯ç·šè³‡æ–™åº« (v300)
 * åŒ…å«ï¼šå…¨åŸŸè®Šæ•¸åˆå§‹å€¼ã€æ™¯é»åº§æ¨™ã€ç†±é–€è·¯ç·šè¨­å®š
 */

// =========================================
// 1. å…¨åŸŸè®Šæ•¸åˆå§‹é…ç½® (Global State)
// =========================================
var targetSpot = null; 
var currentRoute = null; 
var userPos = null; 
var userMarker = null; 
var currentEditingSpotName = "";
var navMode = 'driving'; 
var tourModeInterval = null; 

// å¾ LocalStorage è®€å–ä½¿ç”¨è€…è³‡æ–™
var myFavs = JSON.parse(localStorage.getItem('ruifang_favs')) || []; 
var savedCustomSpots = JSON.parse(localStorage.getItem('ruifang_custom_spots')) || []; 
var searchHistory = JSON.parse(localStorage.getItem('ruifang_search_history')) || []; 

// =========================================
// 2. æ™¯é»è³‡æ–™åº« (Spots Database)
// =========================================
const spots = [
    // --- ç‘èŠ³å¸‚å€ ---
    { name: "ç‘èŠ³ç«è»Šç«™", wikiTitle: "ç‘èŠ³è»Šç«™", lat: 25.108, lng: 121.805, tags: ["äº¤é€š", "ç¾é£Ÿ"], keywords: ["è»Šç«™", "é¾é³³è…¿", "èƒ¡æ¤’é¤…"], highlights: "äº¤é€šè½‰é‹æ¨ç´", food: "é¾é³³è…¿ã€èƒ¡æ¤’é¤…", history: "å¹³æºªç·šèˆ‡ä¹ä»½çš„é€²å‡ºé–€æˆ¶ã€‚", transport: "å°éµç‘èŠ³ç«™", heat: 0.6 },
    { name: "ç‘èŠ³è€è¡—", wikiTitle: "ç‘èŠ³è€è¡—", lat: 25.10958, lng: 121.80656, tags: ["æ­·å²", "ç¾é£Ÿ"], keywords: ["ä¿é›²èŠ‹åœ“", "è€è¡—", "å¤å"], highlights: "å¾Œç«™å¤åç¾¤", food: "ä¿é›²èŠ‹åœ“", history: "æ¸…é ˜æ™‚æœŸå•†åº—åŒ¯é›†è™•ï¼Œæ—©æœŸç¤¦å·¥èšé›†åœ°ã€‚", transport: "ç‘èŠ³è»Šç«™å¾Œç«™æ­¥è¡Œ", heat: 0.5 },
    { name: "ç‘èŠ³ç¾é£Ÿå»£å ´", wikiTitle: "", lat: 25.10685, lng: 121.80567, tags: ["ç¾é£Ÿ"], keywords: ["å®¤å…§", "å°åƒ"], highlights: "åœ¨åœ°ç¾é£ŸåŒ¯é›†", food: "èƒ¡æ¤’é¤…ã€ç‰›è‚‰éºµ", history: "ç‘èŠ³å®¤å…§ç¾é£Ÿå¤©å ‚ã€‚", transport: "ç‘èŠ³è»Šç«™æ­¥è¡Œ3åˆ†", heat: 0.9 },
    
    // --- å››è…³äº­ ---
    { name: "å››è…³äº­", wikiTitle: "å››è…³äº­è»Šç«™", lat: 25.10439, lng: 121.76272, tags: ["å¤é“", "æ­·å²"], keywords: ["ç ²å°", "å¤é“"], highlights: "å››è…³äº­ç ²å°", food: "æ©‹é ­æ’éª¨éºµ", history: "æ—©æœŸé€šå¾€å®œè˜­çš„é‡è¦å¤é“æ“šé»ï¼Œæ“æœ‰æœ€å¤§å…§é™¸é˜²ç¦¦ç ²å°ã€‚", transport: "å°éµå››è…³äº­ç«™", heat: 0.4 },

    // --- çŒ´ç¡åœ°å€ ---
    { name: "çŒ´ç¡è»Šç«™", wikiTitle: "çŒ´ç¡è»Šç«™", lat: 25.08732, lng: 121.82704, tags: ["äº¤é€š", "æ­·å²"], keywords: ["éµé“", "ç…¤ç¤¦"], highlights: "è²“å’ªèˆ‡éµé“", food: "ç¤¦å·¥éºµ", history: "æ˜”æ—¥ç”¢ç…¤ç¬¬ä¸€é®ã€‚", transport: "å°éµçŒ´ç¡ç«™", heat: 0.8 },
    { name: "çŒ´ç¡è²“æ‘", wikiTitle: "çŒ´ç¡è²“æ‘", lat: 25.08721, lng: 121.8268, tags: ["ç†±é–€æ‰“å¡"], keywords: ["è²“", "ç™‚ç™’"], highlights: "è¦ªè¿‘è²“å’ª", food: "è²“å’ªå’–å•¡", history: "ä»¥è²“å’ªèˆ‡å·¥æ¥­éºè·¡ä¿®å¾©èåçš„ç™‚ç™’è²“è¡—ã€‚", transport: "çŒ´ç¡è»Šç«™å¤©æ©‹éå¾Œ", heat: 0.9 },
    { name: "ç‘ä¸‰é‘›æ¥­æ•´ç…¤å ´", wikiTitle: "ç‘ä¸‰é‘›æ¥­", lat: 25.08649, lng: 121.82758, tags: ["å¤è¹Ÿ"], keywords: ["ç…¤ç¤¦", "éºå€"], highlights: "æ•´ç…¤æ­·å²", food: "ç„¡", history: "å…¨å°æœ€å¤§é¸ç…‰ç…¤éºå€ã€‚", transport: "çŒ´ç¡è»Šç«™å‡ºå£å³é”", heat: 0.9 },
    { name: "çŒ´ç¡ç…¤ç¤¦åšç‰©åœ’å€", wikiTitle: "çŒ´ç¡ç…¤ç¤¦åšç‰©åœ’å€", lat: 25.08666, lng: 121.82781, tags: ["æ­·å²"], keywords: ["å°è¦½", "ç¤¦å‘"], highlights: "ç¤¦å‘å°è¦½", food: "ç„¡", history: "ä¿å­˜ç¤¦å·¥ç”Ÿæ´»è¶³è·¡ã€‚", transport: "çŒ´ç¡è»Šç«™æ­¥è¡Œ", heat: 0.7 },
    { name: "çŒ´ç¡èˆŠéš§é“ç¾¤", wikiTitle: "", lat: 25.09095, lng: 121.83089, tags: ["éºè·¡"], keywords: ["éš§é“", "éµé“"], highlights: "éš§é“å…‰å½±", food: "ç„¡", history: "éµé“èˆŠç·šéš§é“ã€‚", transport: "çŒ´ç¡å¾€ä¸‰è²‚å¶ºæ­¥è¡Œ", heat: 0.5 },

    // --- ä¸‰è²‚å¶ºåœ°å€ ---
    { name: "ä¸‰è²‚å¶ºè»Šç«™", wikiTitle: "ä¸‰è²‚å¶ºè»Šç«™", lat: 25.06066, lng: 121.82264, tags: ["ç§˜å¢ƒ", "äº¤é€š"], keywords: ["éµé“", "æ·±å±±"], highlights: "éµé“æ‹æ”", food: "åœ¨åœ°éºµé£Ÿ", history: "å…¨å°å”¯ä¸€ç«è»Šç„¡æ³•ç›´é”çš„è»Šç«™(å‡ºç«™ç„¡å…¬è·¯)ã€‚", transport: "å°éµä¸‰è²‚å¶ºç«™", heat: 0.7 },
    { name: "ä¸‰è²‚å¶ºç€‘å¸ƒç¾¤", wikiTitle: "ä¸‰è²‚å¶ºç€‘å¸ƒç¾¤", lat: 25.06157, lng: 121.81184, tags: ["è‡ªç„¶", "ç™»å±±"], keywords: ["ç€‘å¸ƒ", "æ­¥é“"], highlights: "å¤šå±¤ç€‘å¸ƒ", food: "ç„¡", history: "å£¯é—Šçš„åŸå§‹æ£®æ—ç€‘å¸ƒï¼Œé€£çµä¸‰è²‚å¶ºèˆ‡çŒ´ç¡ã€‚", transport: "ä¸‰è²‚å¶ºç«™æ­¥è¡Œèµ·é»", heat: 0.8 },
    { name: "ä¸‰è²‚å¶ºéš§é“è‡ªè¡Œè»Šé“", wikiTitle: "ä¸‰è²‚å¶ºéš§é“", lat: 25.06452, lng: 121.8231, tags: ["ä¼‘é–’", "éš§é“"], keywords: ["å–®è»Š", "ç”Ÿæ…‹"], highlights: "èˆŠç·šé‡å•Ÿ", food: "ç„¡", history: "ç™¾å¹´éš§é“æ”¹å»ºä¹‹ç’°ä¿è‡ªè¡Œè»Šé“ã€‚", transport: "ä¸‰è²‚å¶ºç«™æ­¥è¡Œ/å–®è»Š", heat: 0.7 },

    // --- ä¹ä»½å•†åœˆ ---
    { name: "ä¹ä»½è€è¡—", wikiTitle: "ä¹ä»½", lat: 25.10988, lng: 121.84523, tags: ["ç†±é–€æ‰“å¡", "æ­·å²"], keywords: ["åŸºå±±è¡—", "å¤œæ™¯"], highlights: "é»ƒé‡‘å±±åŸ", food: "è‰ä»”ç²¿ã€é­šä¸¸æ¹¯", history: "æ¡é‡‘æ™‚æœŸçš„ç¹è¯å±±åŸï¼Œå»ºç¯‰ä¾å±±è€Œå»ºã€‚", transport: "ç‘èŠ³è½‰å®¢é‹ 788/965", heat: 1.0 },
    { name: "æ˜‡å¹³æˆ²é™¢", wikiTitle: "æ˜‡å¹³æˆ²é™¢", lat: 25.10862, lng: 121.84337, tags: ["å¤è¹Ÿ"], keywords: ["é›»å½±", "æ‡·èˆŠ"], highlights: "æ‡·èˆŠæˆ²é™¢", food: "ç„¡", history: "æ›¾ç‚ºå…¨å°æœ€å¤§æˆ²é™¢ï¼Œè¦‹è­‰ä¹ä»½ç¹è¯ã€‚", transport: "ä¹ä»½è€è¡—æ­¥è¡Œ", heat: 0.7 },
    { name: "é˜¿å¦¹èŒ¶æ¨“", wikiTitle: "", lat: 25.10856, lng: 121.8436, tags: ["åœ°æ¨™", "ç¾é£Ÿ"], keywords: ["ç´…ç‡ˆç± ", "èŒ¶"], highlights: "ç´…ç‡ˆç± æ™¯è§€", food: "èŒ¶é£²", history: "ä¹ä»½æ¥µå…·ä»£è¡¨æ€§çš„åœ°æ™¯å»ºç¯‰ã€‚", transport: "è±å´è·¯éšæ¢¯æ—", heat: 1.0 },
    { name: "é˜¿æŸ‘å§¨èŠ‹åœ“", wikiTitle: "", lat: 25.10765, lng: 121.84365, tags: ["ç¾é£Ÿ"], keywords: ["èŠ‹åœ“", "æµ·æ™¯"], highlights: "æ™¯è§€åº§ä½å€", food: "èŠ‹åœ“", history: "ä¹ä»½ä»£è¡¨æ€§ç¾é£Ÿã€‚", transport: "ä¹ä»½è€è¡—ä¸Šæ–¹", heat: 0.9 },
    { name: "é‡‘æç´…ç³Ÿè‚‰åœ“", wikiTitle: "", lat: 25.10855, lng: 121.84391, tags: ["ç¾é£Ÿ"], keywords: ["è‚‰åœ“", "è€åº—"], highlights: "å‚³çµ±ç¾é£Ÿ", food: "ç´…ç³Ÿè‚‰åœ“", history: "è€è¡—å¿…åƒè€åº—ã€‚", transport: "ä¹ä»½è€è¡—å…§", heat: 0.8 },

    // --- é‡‘ç“œçŸ³åœ°å€ ---
    { name: "é‡‘ç“œçŸ³é»ƒé‡‘åšç‰©é¤¨", wikiTitle: "æ–°åŒ—å¸‚ç«‹é»ƒé‡‘åšç‰©é¤¨", lat: 25.10617, lng: 121.85961, tags: ["æ­·å²", "ç¤¦æ¥­"], keywords: ["é‡‘ç¤¦", "æœ¬å±±äº”å‘"], highlights: "æ‘¸å¤§é‡‘ç£š", food: "ç¤¦å·¥ä¾¿ç•¶", history: "äºæ´²ç¬¬ä¸€é‡‘ç¤¦å±±ï¼Œå±•ç¤ºæ¡é‡‘æ­·å²éºå€ã€‚", transport: "å®¢é‹ 788/856", heat: 0.9 },
    { name: "ç¥ˆå ‚è€è¡—", wikiTitle: "", lat: 25.1095, lng: 121.85868, tags: ["è€è¡—"], keywords: ["å½©è™¹éšæ¢¯", "æ–‡é’"], highlights: "å½©è™¹éšæ¢¯", food: "è€è¡—å’–å•¡", history: "é‡‘ç“œçŸ³æ—©æœŸå•†æ¥­ä¸­å¿ƒã€‚", transport: "é»ƒé‡‘åšç‰©é¤¨é™„è¿‘æ­¥è¡Œ", heat: 0.7 },
    { name: "ç„¡è€³èŒ¶å£ºå±±", wikiTitle: "ç„¡è€³èŒ¶å£ºå±±", lat: 25.10637, lng: 121.86596, tags: ["è‡ªç„¶", "ç™»å±±"], keywords: ["æµ·æ™¯", "èŠ’è‰"], highlights: "çµ•ç¾æµ·æ™¯", food: "ç„¡", history: "å› ç‹€ä¼¼ç„¡è€³èŒ¶å£ºè€Œå¾—åã€‚", transport: "å‹¸æ¿Ÿå ‚æ­¥è¡Œç™»å±±", heat: 0.8 },
    { name: "å ±æ™‚å±±æ­¥é“", wikiTitle: "", lat: 25.1118, lng: 121.8587, tags: ["è‡ªç„¶", "ä¼‘é–’"], keywords: ["è§€æ™¯å°", "æ­¥é“"], highlights: "æœ€è¼•é¬†çœ‹æµ·æ­¥é“", food: "ç„¡", history: "æ—¥æ²»æ™‚æœŸè¨­æœ‰è­¦å ±å™¨ã€‚", transport: "å‹¸æ¿Ÿå ‚æ­¥è¡Œ", heat: 0.8 },

    // --- æ°´æ¹³æ´èˆ‡æµ·å²¸ç·š ---
    { name: "æ°´æ¹³æ´é™°é™½æµ·", wikiTitle: "é™°é™½æµ·", lat: 25.12295, lng: 121.86411, tags: ["è‡ªç„¶", "å¥‡æ™¯"], keywords: ["æµ·æ™¯", "é›™è‰²"], highlights: "é»ƒè—äº¤éŒ¯æµ·æ™¯", food: "ç„¡", history: "å¤©ç„¶ç¤¦ç‰©é›¢å­æ°§åŒ–å½¢æˆçš„è‡ªç„¶å¥‡è§€ã€‚", transport: "å®¢é‹ 856 / å°2ç·š", heat: 0.8 },
    { name: "åä¸‰å±¤éºå€", wikiTitle: "æ°´æ¹³æ´é¸ç…‰å» éºå€", lat: 25.11826, lng: 121.86465, tags: ["å·¥æ¥­éºå€"], keywords: ["é»ç‡ˆ", "é¾è²åŸ"], highlights: "å°ç‰ˆå¤©ç©ºä¹‹åŸ", food: "ç„¡", history: "æ°´æ¹³æ´é¸ç…‰å» éºå€ã€‚", transport: "é•·ä»ç¤¾å€é™„è¿‘ / å®¢é‹æ°´æ¹³æ´ç«™", heat: 0.9 },
    { name: "é»ƒé‡‘ç€‘å¸ƒ", wikiTitle: "é»ƒé‡‘ç€‘å¸ƒ", lat: 25.11713, lng: 121.86148, tags: ["è‡ªç„¶", "åœ°æ¨™"], keywords: ["ç€‘å¸ƒ", "é‡‘é»ƒå²©çŸ³"], highlights: "é‡‘é»ƒå²©çŸ³", food: "ç„¡", history: "ç¤¦é«”èˆ‡åœ°ä¸‹æ°´ä½œç”¨å½¢æˆã€‚", transport: "å®¢é‹ 856 / 886", heat: 0.9 },
    { name: "é•·ä»äº­", wikiTitle: "", lat: 25.11918, lng: 121.86606, tags: ["è§€æ™¯å°"], keywords: ["ä¿¯ç°", "æ”å½±"], highlights: "ä¿¯ç°åä¸‰å±¤", food: "ç„¡", history: "æœ€ä½³åä¸‰å±¤æ”å½±é»ã€‚", transport: "é•·ä»ç¤¾å€æ­¥è¡Œ", heat: 0.6 },
    { name: "æ°´æ¹³æ´é•·éšæ¢¯", wikiTitle: "", lat: 25.12187, lng: 121.86056, tags: ["æ‰“å¡"], keywords: ["éšæ¢¯", "æ—¥ç³»"], highlights: "æ—¥ç³»ç¾ç…§é»", food: "ç„¡", history: "æ¿‚æ´åœ‹å°æ—éšæ¢¯ã€‚", transport: "æ°´æ¹³æ´æ­¥è¡Œ", heat: 0.7 },

    // --- æ·±æ¾³èˆ‡é¼»é ­è§’ ---
    { name: "æ·±æ¾³éµé“è‡ªè¡Œè»Š", wikiTitle: "æ·±æ¾³ç·š", lat: 25.12901, lng: 121.81439, tags: ["ä¼‘é–’", "äº¤é€š"], keywords: ["å–®è»Š", "æµ·æ™¯"], highlights: "éš§é“å…‰å½±", food: "ç„¡", history: "å»¢æ£„éµé“æ”¹å»ºï¼Œæœ€å—æ­¡è¿çš„æµ·æ™¯Rail Bikeã€‚", transport: "ç‘èŠ³ç«™è½‰ä¹˜å®¢é‹/å…¬è»Š", heat: 0.8 },
    { name: "æ·±æ¾³è±¡é¼»å²©", wikiTitle: "è±¡é¼»å²©", lat: 25.133, lng: 121.824, tags: ["è‡ªç„¶æ™¯è§€"], keywords: ["æµ·è•", "å¥‡å²©"], highlights: "æµ·è•å¥‡å²©", food: "å°å·ç±³ç²‰ã€é¯Šé­šç¾¹", history: "æ›¾ç‚ºé‡è¦ç…¤ç¤¦è¼¸å‡ºæ¸¯ï¼Œç¾ä»¥æµ·è•åœ°å½¢èåã€‚", transport: "ç‘èŠ³ç«™è½‰å…¬è»ŠT99ã€791", heat: 0.8 },
    { name: "é¼»é ­è§’æ­¥é“", wikiTitle: "é¼»é ­è§’", lat: 25.12588, lng: 121.92028, tags: ["è‡ªç„¶æ™¯è§€", "ä¼‘é–’"], keywords: ["çœ‹æµ·", "ç¨œè°·"], highlights: "å°ç‰ˆè¬é‡Œé•·åŸ", food: "å‘¨é‚Šæµ·ç”¢", history: "ç‘èŠ³æ±åŒ—è§’çš„å²¬è§’ã€‚", transport: "å®¢é‹ 856 / 886", heat: 0.7 },
    { name: "é¼»é ­è§’ç‡ˆå¡”", wikiTitle: "é¼»é ­è§’ç‡ˆå¡”", lat: 25.12877, lng: 121.92346, tags: ["åœ°æ¨™"], keywords: ["ç‡ˆå¡”", "æµ·æ™¯"], highlights: "ç‡ˆå¡”æµ·æ™¯", food: "ç„¡", history: "å»ºæ–¼1896å¹´ï¼Œå®ˆè­·åŒ—å°ç£æµ·åŸŸã€‚", transport: "æ­¥è¡Œè‡ªé¼»é ­è§’æ­¥é“", heat: 0.8 }
];

// =========================================
// 3. ç†±é–€è·¯ç·šè³‡æ–™ (Routes Data)
// ğŸŒŸ é…åˆæ–°åº§æ¨™ï¼Œé‡æ–°å°é½Šè·¯ç·šç¶“éçš„ç¶“ç·¯åº¦ï¼
// =========================================
const routesData = {
    'history': { 
        name: "ğŸ›ï¸ æ­·å²æ‡·èˆŠç·š", 
        desc: "ç‘èŠ³è»Šç«™ â” å¾Œç«™è€è¡— â” ä¹ä»½è€è¡— â” é»ƒé‡‘åšç‰©é¤¨", 
        coords: [[25.108, 121.805], [25.10958, 121.80656], [25.10988, 121.84523], [25.10617, 121.85961]], 
        color: '#8e44ad' 
    },
    'nature': { 
        name: "â›°ï¸ å±±æµ·è‡ªç„¶ç·š", 
        desc: "ç‘èŠ³è»Šç«™ â” çŒ´ç¡è²“æ‘ â” å ±æ™‚å±±æ­¥é“ â” é™°é™½æµ·", 
        coords: [[25.108, 121.805], [25.08721, 121.8268], [25.1118, 121.8587], [25.12295, 121.86411]], 
        color: '#27ae60' 
    },
    'food': { 
        name: "ğŸœ é¥•å®¢ç¾é£Ÿç·š", 
        desc: "ç‘èŠ³ç¾é£Ÿå»£å ´ â” é˜¿æŸ‘å§¨èŠ‹åœ“ â” ç¤¦å·¥ä¾¿ç•¶", 
        coords: [[25.10685, 121.80567], [25.10765, 121.84365], [25.10617, 121.85961]], 
        color: '#d35400' 
    }
};

const themeRouteCoords = routesData['history'].coords;
