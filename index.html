<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <title>ç‘èŠ³å°è¦½åœ°åœ– App</title>

    <meta property="og:title" content="ç‘èŠ³å°è¦½åœ°åœ–" />
    <meta property="og:description" content="æ¢ç´¢ç‘èŠ³ç§˜å¢ƒã€åœ¨åœ°ç¾é£Ÿèˆ‡æ™‚ç©ºæ—…äººè·¯ç·šçš„å°ˆå±¬æ™ºæ…§åœ°åœ–ï¼" />
    <meta property="og:type" content="website" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#f39c12">
    <link rel="apple-touch-icon" href="./icon-192.png">

    <link rel="stylesheet" href="./style.css">
</head>
<body id="main-body">

    <div id="splash-screen">
        <div class="logo-anim">ç‘</div>
        <h2 class="title-text" style="letter-spacing: 2px;">ç‘èŠ³å°è¦½</h2>
    </div>

    <div id="startup-screen">
        <div class="content-wrapper">
            <div class="logo-static">ç‘</div>
            <h1 class="title-text" data-i18n="splash_title">ç‘èŠ³å°è¦½ App</h1>
            <p style="text-align: center; color: var(--text-sub); line-height: 1.6; max-width: 300px;" data-i18n="splash_desc">
                è‡´åŠ›æ–¼æä¾›ç‘èŠ³åœ°å€æœ€ç²¾æº–çš„åœ¨åœ°å°è¦½ï¼Œå¸¶é ˜æ‚¨æ·±åº¦æ¢ç´¢å±±åŸä¹‹ç¾ã€‚
            </p>
            
            <div style="margin-top: 20px; width: 100%; max-width: 300px;">
                <label style="font-weight: bold; display: block; margin-bottom: 10px; color: var(--primary);" data-i18n="lang">èªè¨€ / Language</label>
                <select id="lang-select-startup" onchange="applyLanguage(this.value)" class="modal-select">
                    <option value="zh">ç¹é«”ä¸­æ–‡</option>
                    <option value="en">English</option>
                    <option value="ja">æ—¥æœ¬èª</option>
                </select>
            </div>

            <div style="margin-top: 30px; text-align: left; width: 100%; max-width: 300px; font-size: 14px; color: var(--text-main);">
                <h3 style="border-bottom: 1px solid var(--primary); padding-bottom: 8px; margin-bottom: 10px; color: var(--primary);" data-i18n="ui_guide">ä»‹é¢åŠŸèƒ½èªªæ˜</h3>
                <ul style="list-style: none; padding: 0; color: var(--text-sub);">
                    <li style="margin: 12px 0;">ğŸ” <b style="color: var(--text-main);">æœå°‹èˆ‡æ¨™ç±¤</b>ï¼šä¸Šæ–¹å¯å¿«é€Ÿå°‹æ‰¾èˆ‡ç¯©é¸ã€‚</li>
                    <li style="margin: 12px 0;">ğŸ“ <b style="color: var(--text-main);">é•·æŒ‰æ–°å¢</b>ï¼šåœ°åœ–é•·æŒ‰å¯æ–°å¢ç§æˆ¿æ™¯é»ã€‚</li>
                    <li style="margin: 12px 0;">ğŸŒ¡ï¸ <b style="color: var(--text-main);">å¤©æ°£è³‡è¨Š</b>ï¼šå³ä¸Šæ–¹é¡¯ç¤ºå³æ™‚æ°£æº«ã€‚</li>
                    <li style="margin: 12px 0;"><span style="color: var(--primary);">â—</span> <b style="color: var(--text-main);">åˆ†äº«éµ</b>ï¼šè—è‰²ï¼Œå¿«é€Ÿåˆ†äº«æ™¯é»ã€‚</li>
                    <li style="margin: 12px 0;"><span style="color: var(--success);">â—</span> <b style="color: var(--text-main);">æŒ‡åŒ—é‡</b>ï¼šç¶ è‰²ï¼ŒæŒ‡å¼•å‰é€²æ–¹å‘ã€‚</li>
                </ul>
            </div>

            <button class="btn-start" onclick="closeStartup()" data-i18n="start_btn">é–‹å§‹æ¢ç´¢</button>

            <div style="margin-top: 30px; margin-bottom: 40px; text-align: center;">
                <span style="font-size: 12px; color: var(--text-sub);" data-i18n="contact">è¯çµ¡é–‹ç™¼åœ˜éšŠ</span><br>
                <a href="mailto:ruifang689@gmail.com" style="color: var(--primary); font-size: 14px; text-decoration: none; font-weight: bold;">
                    ğŸ“§ ruifang689@gmail.com
                </a>
            </div>
        </div>
    </div>

    <div id="weather-box" title="å³æ™‚å¤©æ°£"><i class="fas fa-spinner fa-spin" style="color:#ccc"></i><span id="weather-temp">--</span></div>

    <div id="top-ui">
        <input id="search" placeholder="ğŸ” æœå°‹æ™¯é»æˆ–é•·æŒ‰åœ°åœ–æ¨™è¨˜..." data-i18n="search_ph">
        
        <div id="category-chips">
            <div class="chip active" onclick="filterSpots('all', this)">ğŸŒŸ å…¨éƒ¨</div>
            <div class="chip" onclick="filterSpots('ç¾é£Ÿ', this)">ğŸœ ç¾é£Ÿ</div>
            <div class="chip" onclick="filterSpots('æ­·å²', this)">ğŸ›ï¸ æ­·å²</div>
            <div class="chip" onclick="filterSpots('è‡ªç„¶', this)">â›°ï¸ è‡ªç„¶æ™¯è§€</div>
            <div class="chip" onclick="filterSpots('è‡ªè¨‚', this)">ğŸ“ æˆ‘çš„æ¨™è¨˜</div>
        </div>

        <div id="map-center-panel">
            <i class="fas fa-map-marker-alt" style="color:var(--primary)"></i>
            <span id="addr-text" data-i18n="locating">å®šä½ä¸­...</span>
        </div>
        <div id="suggest"></div>
    </div>

    <div id="route-info-panel">
        <i class="fas fa-car" style="font-size:20px; color:var(--primary);"></i>
        <div class="route-data">
            <span id="route-time" class="route-time">-- åˆ†é˜</span>
            <span id="route-dist" class="route-dist">-- km</span>
        </div>
        <i class="fas fa-times-circle route-close" onclick="closeNav()"></i>
    </div>

    <div class="map-controls">
        <div class="control-btn" onclick="openSettings()" title="è¨­å®š"><i class="fas fa-cog"></i></div>
        <div class="control-btn compass-btn" onclick="resetNorth()" title="å›åˆ°å…¨æ™¯"><i class="fas fa-compass"></i></div>
        <div class="control-btn route-btn" onclick="drawThemeRoute()" title="æ™‚ç©ºæ—…äººè·¯ç·š"><i class="fas fa-route"></i></div>
        <div class="control-btn fav-btn" onclick="toggleFavList()" title="æˆ‘çš„æ”¶è—"><i class="fas fa-folder-open"></i></div>
        <div class="control-btn station-btn" onclick="goToStation()" title="å›åˆ°ç‘èŠ³ä¸­å¿ƒ"><span class="rui-icon">ç‘</span></div>
        <div class="control-btn" id="layer-btn" onclick="toggleLayer()" title="åˆ‡æ›åº•åœ–"><i class="fas fa-map"></i></div>
        <div class="control-btn active" onclick="goToUser()" title="æˆ‘çš„ä½ç½®"><i class="fas fa-location-crosshairs" style="color: var(--primary);"></i></div>
    </div>

    <div id="fav-list-panel"></div>
    <div id="gps-val-text">GPS: å®šä½ä¸­...</div>
    <div id="map"></div>

    <div id="card">
        <div class="close-bar" onclick="closeCard()"></div>
        <div class="card-header-row">
            <h2 id="title"></h2>
            <div class="card-header-icons">
                <i id="card-share-icon" class="fas fa-share-nodes" onclick="shareSpot()"></i>
                <i id="card-fav-icon" class="fas fa-heart" onclick="toggleCurrentFav()"></i>
            </div>
        </div>
        <div id="card-tags"></div>
        <img id="img">
        <div class="info-section"><span class="info-label"><i class="fas fa-utensils"></i> <span data-i18n="food">åœ¨åœ°é£²é£Ÿ</span></span><span id="card-food" class="info-text"></span></div>
        <div class="info-section"><span class="info-label"><i class="fas fa-star"></i> <span data-i18n="highlights">æ¨è–¦äº®é»</span></span><span id="card-highlights" class="info-text"></span></div>
        <div class="info-section"><span class="info-label"><i class="fas fa-history"></i> <span data-i18n="history">ç°¡ä»‹æ­·å²</span></span><span id="card-history" class="info-text"></span></div>
        <div class="info-section"><span class="info-label"><i class="fas fa-bus"></i> <span data-i18n="transport">äº¤é€šæ–¹å¼</span></span><span id="card-transport" class="info-text"></span></div>
        <div class="btn-group" id="card-btn-group"></div>
    </div>

    <div id="settings-modal-overlay" class="modal-overlay">
        <div class="modal-box">
            <h2 data-i18n="settings"><i class="fas fa-cog"></i> ç³»çµ±è¨­å®š</h2>
            
            <h3 data-i18n="lang"><i class="fas fa-globe"></i> èªè¨€ / Language</h3>
            <select id="lang-select-settings" onchange="applyLanguage(this.value)" class="modal-select">
                <option value="zh">ç¹é«”ä¸­æ–‡</option>
                <option value="en">English</option>
                <option value="ja">æ—¥æœ¬èª</option>
            </select>

            <h3 style="margin-top:10px;"><i class="fas fa-envelope"></i> è¯çµ¡åœ˜éšŠ</h3>
            <a href="mailto:ruifang689@gmail.com" style="color: var(--primary); text-decoration: none; font-weight: bold; font-size: 16px; text-align: center; display: block; padding: 10px; background: rgba(243, 156, 18, 0.1); border-radius: 12px;">
                ruifang689@gmail.com
            </a>

            <button id="install-btn" style="display: none; margin-top: 10px; background-color: var(--success);" class="modal-save" onclick="installPWA()">
                â¬‡ï¸ å°‡ App å®‰è£è‡³æ¡Œé¢
            </button>

            <div class="modal-btns">
                <button class="modal-cancel" onclick="closeSettings()" data-i18n="close">é—œé–‰</button>
            </div>
        </div>
    </div>

    <div id="edit-modal-overlay" class="modal-overlay">
        <div class="modal-box">
            <h3><i class="fas fa-edit"></i> ç·¨è¼¯è‡ªè¨‚æ¨™è¨˜</h3>
            <input type="text" id="edit-name" class="modal-input" placeholder="åç¨±å¿…å¡«">
            <input type="text" id="edit-highlights" class="modal-input" placeholder="æ¨è–¦äº®é»">
            <textarea id="edit-history" class="modal-textarea" placeholder="æ­·å²ç°¡ä»‹..."></textarea>
            <label class="modal-file-label"><i class="fas fa-camera"></i> <span>ä¸Šå‚³ç…§ç‰‡</span><input type="file" id="edit-image" accept="image/*" style="display:none;"></label>
            <img id="edit-image-preview">
            <div class="modal-btns">
                <button class="modal-cancel" onclick="closeEditModal()">å–æ¶ˆ</button>
                <button class="modal-save" onclick="saveEditSpot()">å„²å­˜</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

    <script>
        // =========================================
        // 0. PWA è¨»å†Šèˆ‡å®‰è£é‚è¼¯
        // =========================================
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').catch(err => console.log('SW æœªè¨»å†Š'));
            });
        }

        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault(); deferredPrompt = e;
            const installBtn = document.getElementById('install-btn');
            if(installBtn) installBtn.style.display = 'block';
        });

        function installPWA() {
            if (!deferredPrompt) return;
            document.getElementById('install-btn').style.display = 'none';
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then((choiceResult) => { deferredPrompt = null; });
        }

        // =========================================
        // 1. æœ¬åœ°å¤šåœ‹èªè¨€å­—å…¸ (i18n)
        // =========================================
        const translations = {
            'zh': {
                splash_title: "ç‘èŠ³å°è¦½ App", splash_desc: "è‡´åŠ›æ–¼æä¾›ç‘èŠ³åœ°å€æœ€ç²¾æº–çš„åœ¨åœ°å°è¦½ï¼Œå¸¶é ˜æ‚¨æ·±åº¦æ¢ç´¢å±±åŸä¹‹ç¾ã€‚", lang: "èªè¨€ / Language", ui_guide: "ä»‹é¢åŠŸèƒ½èªªæ˜", start_btn: "é–‹å§‹æ¢ç´¢", contact: "è¯çµ¡é–‹ç™¼åœ˜éšŠ", settings: "ç³»çµ±è¨­å®š", close: "é—œé–‰",
                search_ph: "ğŸ” æœå°‹æ™¯é»æˆ–é•·æŒ‰æ–°å¢...", locating: "å®šä½ä¸­...", food: "åœ¨åœ°é£²é£Ÿ", highlights: "æ¨è–¦äº®é»", history: "ç°¡ä»‹æ­·å²", transport: "äº¤é€šæ–¹å¼", nav: " å°èˆª", ai: " è¡Œç¨‹è¦åŠƒ"
            },
            'en': {
                splash_title: "Ruifang Guide", splash_desc: "Dedicated to providing the most accurate local guide in Ruifang.", lang: "Language", ui_guide: "UI Guide", start_btn: "Start", contact: "Contact Team", settings: "Settings", close: "Close",
                search_ph: "ğŸ” Search or long press...", locating: "Locating...", food: "Food", highlights: "Highlights", history: "History", transport: "Transport", nav: " Navigate", ai: " Plan Trip"
            },
            'ja': {
                splash_title: "ç‘èŠ³(ãƒ«ã‚¤ãƒ•ã‚¡ãƒ³)ã‚¬ã‚¤ãƒ‰", splash_desc: "ç‘èŠ³ã‚¨ãƒªã‚¢ã®æ­£ç¢ºãªãƒ­ãƒ¼ã‚«ãƒ«ã‚¬ã‚¤ãƒ‰ã‚’æä¾›ã—ã€å±±ã®ç¾ã—ã•ã‚’æ¢ç´¢ã—ã¾ã™ã€‚", lang: "è¨€èª / Language", ui_guide: "UIã‚¬ã‚¤ãƒ‰", start_btn: "é–‹å§‹ã™ã‚‹", contact: "ãŠå•ã„åˆã‚ã›", settings: "è¨­å®š", close: "é–‰ã˜ã‚‹",
                search_ph: "ğŸ” æ¤œç´¢ã¾ãŸã¯é•·æŠ¼ã—...", locating: "ä½ç½®å–å¾—ä¸­...", food: "åœ°å…ƒã‚°ãƒ«ãƒ¡", highlights: "è¦‹ã©ã“ã‚", history: "æ­´å²", transport: "ã‚¢ã‚¯ã‚»ã‚¹", nav: " ãƒŠãƒ“", ai: " ãƒ«ãƒ¼ãƒˆè¨ˆç”»"
            }
        };

        let currentLang = localStorage.getItem('ruifang_lang') || 'zh';

        function applyLanguage(lang) {
            currentLang = lang; localStorage.setItem('ruifang_lang', lang);
            const t = translations[lang]; if(!t) return;
            
            document.getElementById('search').placeholder = t.search_ph;
            document.getElementById('addr-text').innerText = t.locating;
            
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (t[key]) {
                    if(el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') el.placeholder = t[key];
                    else el.innerHTML = el.innerHTML.replace(/<i class=".*"><\/i>/, match => match + " ") ? el.innerHTML.replace(/(<i class=".*"><\/i>).*/, `$1 ${t[key]}`) : t[key];
                }
            });
            document.getElementById('lang-select-startup').value = lang;
            document.getElementById('lang-select-settings').value = lang;
            if(targetSpot && document.getElementById("card").classList.contains("open")) renderCardButtons(targetSpot, t);
        }

        function closeStartup() {
            const startupScreen = document.getElementById('startup-screen');
            startupScreen.style.transition = "opacity 0.4s ease";
            startupScreen.style.opacity = "0";
            setTimeout(() => { startupScreen.style.display = 'none'; }, 400); 
            localStorage.setItem('ruifang_welcomed', 'true');
        }

        function openSettings() { document.getElementById('settings-modal-overlay').style.display = 'flex'; }
        function closeSettings() { document.getElementById('settings-modal-overlay').style.display = 'none'; }

        // =========================================
        // 2. å¤©æ°£èˆ‡åœ°åœ–åˆå§‹åŒ–
        // =========================================
        async function fetchWeather() {
            try {
                const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=25.108&longitude=121.805&current_weather=true&timezone=Asia%2FTaipei');
                const data = await res.json();
                const temp = Math.round(data.current_weather.temperature);
                const code = data.current_weather.weathercode;
                let iconClass = 'fa-cloud-sun'; let iconColor = '#f39c12'; 
                if(code === 0) { iconClass = 'fa-sun'; iconColor = '#f1c40f'; } else if(code <= 3) { iconClass = 'fa-cloud-sun'; iconColor = '#f39c12'; } else if(code <= 67 || (code >= 80 && code <= 82)) { iconClass = 'fa-cloud-rain'; iconColor = '#3498db'; } 
                document.getElementById('weather-temp').innerText = `${temp}Â°C`;
                const iconEl = document.querySelector('#weather-box i'); iconEl.className = `fas ${iconClass}`; iconEl.style.color = iconColor;
            } catch (e) { document.getElementById('weather-temp').innerText = "--"; }
        }

        const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([25.1032, 121.8224], 14);
        const mapLayers = [
            { url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', name: 'è¡—é“', icon: 'fa-map', dark: false },
            { url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', name: 'ç­‰é«˜ç·š', icon: 'fa-mountain', dark: false },
            { url: 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', name: 'å¤œé–“', icon: 'fa-moon', dark: true }
        ];
        let currentLayerIdx = 0, currentTileLayer = L.tileLayer(mapLayers[0].url).addTo(map);
        L.control.scale({ metric: true, imperial: false, position: 'bottomright' }).addTo(map);

        function toggleLayer() {
            currentLayerIdx = (currentLayerIdx + 1) % mapLayers.length; const c = mapLayers[currentLayerIdx];
            map.removeLayer(currentTileLayer); currentTileLayer = L.tileLayer(c.url).addTo(map);
            document.querySelector('#layer-btn i').className = `fas ${c.icon}`;
            if (c.dark) document.body.classList.add("dark-mode"); else document.body.classList.remove("dark-mode");
        }

        map.on('click', () => { closeCard(); document.getElementById("suggest").style.display = "none"; });

        let userPos = null;
        const userPulseIcon = L.divIcon({ className: 'user-pulse-icon', html: '<div class="pulse"></div><div class="dot"></div>', iconSize: [40, 40], iconAnchor: [20, 20] });
        map.locate({setView: false, watch: true}); 
        map.on('locationfound', e => {
            userPos = e.latlng; document.getElementById("gps-val-text").innerText = `GPS: ${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)}`;
            if(!window.userMarker) window.userMarker = L.marker(userPos, { icon: userPulseIcon }).addTo(map); else window.userMarker.setLatLng(userPos);
        });

        map.on('moveend', function() {
            const center = map.getCenter();
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${center.lat}&lon=${center.lng}&zoom=18&addressdetails=1&accept-language=zh-TW`)
            .then(res => res.json()).then(data => {
                if (data && data.address) { const a = data.address; document.getElementById("addr-text").innerText = ((a.city||a.town||a.county||"") + (a.suburb||a.district||"") + (a.village||a.neighbourhood||a.road||"")) || "æ¢ç´¢ç‘èŠ³ä¸­..."; }
            }).catch(()=>{}); 
        });

        // =========================================
        // 3. æ™¯é»èˆ‡ Firebase è¨­å®š
        // =========================================
        const spots = [
            { name: "ç‘èŠ³", lat: 25.108, lng: 121.805, tags: ["äº¤é€š", "ç¾é£Ÿ"], keywords: ["ç«è»Šç«™", "é¾é³³è…¿", "èƒ¡æ¤’é¤…"], highlights: "ç‘èŠ³ç¾é£Ÿå»£å ´", food: "é¾é³³è…¿ã€èƒ¡æ¤’é¤…ã€ç‰›è‚‰éºµ", history: "é€²å…¥ä¹ä»½èˆ‡å¹³æºªç·šé–€æˆ¶ã€‚", transport: "å°éµç‘èŠ³ç«™" },
            { name: "ç‘èŠ³å¾Œç«™è€è¡—", lat: 25.109, lng: 121.806, tags: ["æ­·å²", "ç¾é£Ÿ"], keywords: ["ä¿é›²èŠ‹åœ“", "è€è¡—"], highlights: "ç‘èŠ³å‰µå§‹èŠ‹åœ“", food: "ä¿é›²èŠ‹åœ“", history: "æ—©æœŸç¤¦å·¥çš„èšé›†åœ°ã€‚", transport: "ç‘èŠ³ç«è»Šç«™å¾Œç«™" },
            { name: "ä¹ä»½è€è¡—", lat: 25.1099, lng: 121.8452, tags: ["æ­·å²", "ç¾é£Ÿ"], keywords: ["é˜¿å¦¹èŒ¶æ¨“", "èŠ‹åœ“", "å±±åŸ"], highlights: "é˜¿å¦¹èŒ¶æ¨“ã€è±å´è·¯", food: "é˜¿æŸ‘å§¨èŠ‹åœ“ã€è‰ä»”ç²¿", history: "é»ƒé‡‘å±±åŸã€‚", transport: "å®¢é‹ 788/965" },
            { name: "çŒ´ç¡è²“æ‘", lat: 25.086, lng: 121.828, tags: ["æ­·å²"], keywords: ["è²“", "ç‘ä¸‰æ•´ç…¤å» "], highlights: "è²“å’ªç™‚ç™’ã€æ•´ç…¤å» éºè·¡", food: "ç¤¦å·¥éºµ", history: "æ›¾ç‚ºå…¨å°ç…¤ç¤¦ç”¢é‡ç¬¬ä¸€ã€‚", transport: "å°éµçŒ´ç¡ç«™" },
            { name: "é‡‘ç“œçŸ³é»ƒé‡‘åšç‰©é¤¨", lat: 25.1091, lng: 121.8576, tags: ["æ­·å²"], keywords: ["é‡‘ç“œçŸ³", "ç¤¦å·¥ä¾¿ç•¶"], highlights: "å¤§é‡‘ç£šã€é»ƒé‡‘ç¥ç¤¾", food: "ç¤¦å·¥ä¾¿ç•¶", history: "æ˜”æ—¥äºæ´²ç¬¬ä¸€é‡‘ç¤¦å±±ã€‚", transport: "å®¢é‹ 788/856" },
            { name: "ç„¡è€³èŒ¶å£ºå±±", lat: 25.1063, lng: 121.8659, tags: ["è‡ªç„¶"], keywords: ["æµ·æ™¯", "çˆ¬å±±"], highlights: "çµ•ç¾æµ·æ™¯", food: "ç„¡", history: "å› å±±å½¢ç‹€ä¼¼ç„¡è€³èŒ¶å£ºå¾—åã€‚", transport: "é‡‘ç“œçŸ³æ­¥è¡Œç™»å±±" },
            { name: "æ·±æ¾³éµé“è‡ªè¡Œè»Š", lat: 25.133, lng: 121.824, tags: ["è‡ªç„¶"], keywords: ["è‡ªè¡Œè»Š", "æµ·æ™¯"], highlights: "æµ·æ™¯éµé“èˆ‡å…‰é›•éš§é“", food: "å°å·ç±³ç²‰", history: "æ˜”æ—¥é‹ç…¤éµè·¯è½‰å‹ã€‚", transport: "å…¬è»ŠT99" },
            { name: "ä¸å­äº­", lat: 25.0895, lng: 121.8473, tags: ["è‡ªç„¶"], keywords: ["å¯‚å¯å…¬è·¯", "102ç¸£é“"], highlights: "å¯‚å¯å…¬è·¯", food: "ç„¡", history: "åå­—å–è‡ªæç™½è©©å¥ã€‚", transport: "è‡ªè¡Œé–‹è»Š" }
        ];

        let targetSpot = null; let currentRoute = null;
        let myFavs = JSON.parse(localStorage.getItem('ruifang_favs')) || []; 
        let savedCustomSpots = JSON.parse(localStorage.getItem('ruifang_custom_spots')) || []; 
        let searchHistory = JSON.parse(localStorage.getItem('ruifang_search_history')) || []; 
        const themeRouteCoords = [[25.108, 121.805], [25.086, 121.828], [25.0606, 121.8226], [25.1091, 121.8576]];

        // å¡«å…¥æ‚¨æä¾›çš„ Firebase è³‡è¨Š
        const firebaseConfig = {
            apiKey: "è«‹è‡³Firebaseå¾Œå°å–å¾— Web API Key", 
            authDomain: "ruifang689-max.firebaseapp.com",
            projectId: "ruifang689-max",
            storageBucket: "ruifang689-max.appspot.com",
            messagingSenderId: "29945788628",
            appId: "è«‹è‡³Firebaseå¾Œå°å–å¾— App ID" 
        };
        let db = null; const userId = "user_default";

        if (firebaseConfig.apiKey !== "è«‹è‡³Firebaseå¾Œå°å–å¾— Web API Key") {
            import("https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js").then(module => {
                const app = module.initializeApp(firebaseConfig);
                import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js").then(fs => { db = fs.getFirestore(app); console.log("Firebase å·²å•Ÿç”¨"); });
            }).catch(e => console.log(e));
        }

        async function saveFavToCloud() {
            if (!db) return; 
            try { const { doc, setDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"); await setDoc(doc(db, "users", userId), { favorites: myFavs }, { merge: true }); } catch(e) {}
        }

        // =========================================
        // 4. åœ–é‡˜ã€å¡ç‰‡èˆ‡åœ°åœ–æ“ä½œ
        // =========================================
        const cluster = L.markerClusterGroup(); map.addLayer(cluster);
        function calculateWalk(lat, lng) { if(!userPos) return "--"; const mins = Math.round(map.distance(userPos, [lat, lng]) / 80); return mins < 1 ? "1åˆ†å…§" : `ç´„ ${mins} åˆ†`; }
        const createCustomPin = (tags) => { let cls = 'fa-map-marker-alt', col = '#ea4335'; if (tags.includes('ç¾é£Ÿ')) { cls = 'fa-utensils'; col = '#f39c12'; } else if (tags.includes('æ­·å²')) { cls = 'fa-landmark'; col = '#7f8c8d'; } else if (tags.includes('è‡ªç„¶')) { cls = 'fa-leaf'; col = '#2ecc71'; } else if (tags.includes('è‡ªè¨‚')) { cls = 'fa-star'; col = '#f1c40f'; } return L.divIcon({ className: 'custom-pin-wrap', html: `<div class="gmap-pin" style="background-color:${col}"><i class="fas ${cls}"></i></div>`, iconSize: [32,32], iconAnchor: [16,38], popupAnchor: [0,-38] }); };

        function addMarkerToMap(s) {
            if (!s.tags.includes('è‡ªè¨‚') && !s.wikiImg) fetch(`https://zh.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(s.name)}`).then(r=>r.json()).then(d=>{s.wikiImg=d.thumbnail?.source;}).catch(()=>{});
            const m = L.marker([s.lat, s.lng], { icon: createCustomPin(s.tags) });
            m.bindPopup(() => {
                const img = s.wikiImg || 'https://via.placeholder.com/260x130/f39c12/ffffff?text=Ruifang';
                return `<div class="preview-card" onclick="openCardByName('${s.name}')"><img class="preview-img" src="${img}"><div class="preview-info"><div class="preview-header"><span class="preview-title">${s.name}</span><span class="walk-badge"><i class="fas fa-walking"></i> ${calculateWalk(s.lat, s.lng)}</span></div><div class="preview-tag-box">${s.tags.map(t=>`<span class="mini-tag">${t}</span>`).join('')}</div></div></div>`;
            }, { closeButton: false });
            m.on('mouseover', function() { this.openPopup(); }); m.on('click', (e) => { L.DomEvent.stopPropagation(e); showCard(s); });
            s.markerObj = m; cluster.addLayer(m);
        }
        spots.forEach(addMarkerToMap); savedCustomSpots.forEach(s => { spots.push(s); addMarkerToMap(s); });

        function filterSpots(category, element) {
            if(element) { document.querySelectorAll('.chip').forEach(c => c.classList.remove('active')); element.classList.add('active'); }
            cluster.clearLayers(); const filteredSpots = category === 'all' ? spots : spots.filter(s => s.tags.includes(category)); filteredSpots.forEach(addMarkerToMap); closeCard();
        }

        map.on('contextmenu', function(e) {
            const spotName = prompt("ğŸ“ æ–°å¢è‡ªè¨‚æ¨™è¨˜\nè«‹ç‚ºåœ°é»å‘½åï¼š", "æˆ‘çš„æ™¯é»");
            if (!spotName) return; 
            const newSpot = { name: spotName, lat: e.latlng.lat, lng: e.latlng.lng, tags: ["è‡ªè¨‚"], highlights: "é»æ“Šä¸‹æ–¹ç·¨è¼¯...", food: "--", history: "è‡ªè¨‚æ¨™è¨˜", transport: "è‡ªè¡Œå‰å¾€", wikiImg: "" };
            spots.push(newSpot); addMarkerToMap(newSpot); savedCustomSpots.push(newSpot); localStorage.setItem('ruifang_custom_spots', JSON.stringify(savedCustomSpots)); showCard(newSpot);
        });

        function renderCardButtons(s, t = translations[currentLang]) {
            const btnGroup = document.getElementById("card-btn-group");
            if (s.tags.includes('è‡ªè¨‚')) { btnGroup.innerHTML = `<button onclick="startNav()" style="flex: 1.2;"><i class="fas fa-location-arrow"></i> ${t.nav}</button><button class="edit-btn" onclick="openEditModal('${s.name}')"><i class="fas fa-edit"></i></button><button class="danger" onclick="deleteCustomSpot('${s.name}')"><i class="fas fa-trash-alt"></i></button>`; } 
            else { btnGroup.innerHTML = `<button onclick="startNav()"><i class="fas fa-location-arrow"></i> ${t.nav}</button><button class="secondary" onclick="aiTrip()"><i class="fas fa-magic"></i> ${t.ai}</button>`; }
        }

        function showCard(s) {
            targetSpot = s; document.getElementById("card-fav-icon").className = myFavs.includes(s.name) ? "fas fa-heart active" : "fas fa-heart";
            document.getElementById("title").innerText = s.name; document.getElementById("img").src = s.wikiImg || 'https://via.placeholder.com/400x200/f39c12/ffffff?text=Ruifang';
            document.getElementById("card-tags").innerHTML = s.tags.map(t => `<span class="mini-tag">${t}</span>`).join('');
            document.getElementById("card-food").innerText = s.food || "--"; document.getElementById("card-highlights").innerText = s.highlights || "æš«ç„¡ä»‹ç´¹";
            document.getElementById("card-history").innerText = s.history || "ç„¡"; document.getElementById("card-transport").innerText = s.transport || "è‡ªè¡Œå‰å¾€";
            renderCardButtons(s); document.getElementById("card").classList.add("open"); document.getElementById("card").style.transform = '';
        }
        function openCardByName(name) { const s = spots.find(x => x.name === name); if(s) showCard(s); }
        function closeCard() { document.getElementById("card").classList.remove("open"); document.getElementById("card").style.transform = ''; }
        function closeNav() { if(currentRoute) map.removeLayer(currentRoute); document.getElementById('route-info-panel').style.display = 'none'; }

        function startNav() {
            if(!userPos || !targetSpot) return alert("è«‹é–‹å•Ÿ GPS å®šä½"); closeCard(); document.getElementById('route-time').innerText = "è¨ˆç®—ä¸­..."; document.getElementById('route-dist').innerText = ""; document.getElementById('route-info-panel').style.display = 'flex';
            fetch(`https://router.project-osrm.org/route/v1/driving/${userPos.lng},${userPos.lat};${targetSpot.lng},${targetSpot.lat}?overview=full&geometries=geojson`)
            .then(r => r.json()).then(data => { if(currentRoute) map.removeLayer(currentRoute); const route = data.routes[0]; const coords = route.geometry.coordinates.map(c => [c[1], c[0]]); currentRoute = L.polyline(coords, {color: '#f39c12', weight: 8}).addTo(map); map.fitBounds(currentRoute.getBounds(), {padding: [80, 80]}); document.getElementById('route-time').innerText = `${Math.round(route.duration / 60)} åˆ†é˜`; document.getElementById('route-dist').innerText = `${(route.distance / 1000).toFixed(1)} km`; }).catch(() => { document.getElementById('route-time').innerText = "è¦åŠƒå¤±æ•—"; });
        }

        // =========================================
        // 5. æœå°‹èˆ‡å·¥å…·
        // =========================================
        const searchInput = document.getElementById("search"); const sugBox = document.getElementById("suggest");
        searchInput.addEventListener('focus', () => { if(!searchInput.value.trim()) renderDefaultSearch(); });
        function saveSearchHistory(name) { searchHistory = searchHistory.filter(h => h !== name); searchHistory.unshift(name); if(searchHistory.length > 5) searchHistory.pop(); localStorage.setItem('ruifang_search_history', JSON.stringify(searchHistory)); }
        function renderDefaultSearch() { sugBox.innerHTML = ""; if(searchHistory.length > 0) { sugBox.innerHTML += `<div class="search-section-title">ğŸ•’ æ­·å²æœå°‹</div>`; searchHistory.forEach(h => { sugBox.innerHTML += `<div class="list-item" onclick="triggerSearch('${h}')"><span><i class="fas fa-history" style="color:#aaa;"></i> ${h}</span></div>`; }); } sugBox.innerHTML += `<div class="search-section-title">â­ æ¨è–¦æ™¯é»</div>`; ["ä¹ä»½è€è¡—", "çŒ´ç¡è²“æ‘", "ç„¡è€³èŒ¶å£ºå±±"].forEach(r => { sugBox.innerHTML += `<div class="list-item" onclick="triggerSearch('${r}')"><span><i class="fas fa-fire" style="color:#e74c3c;"></i> ${r}</span></div>`; }); sugBox.style.display = "block"; }
        function triggerSearch(name) { searchInput.value = name; sugBox.style.display = "none"; const s = spots.find(x => x.name === name); if(s) { map.flyTo([s.lat, s.lng], 16); setTimeout(() => showCard(s), 800); } }
        searchInput.oninput = function() { const k = this.value.trim(); if(!k) { renderDefaultSearch(); return; } sugBox.innerHTML = ""; const matches = spots.filter(s => { return s.name.includes(k) || s.tags.some(t => t.includes(k)) || (s.keywords && s.keywords.some(kw => kw.includes(k))); }); if(matches.length > 0) { sugBox.style.display = "block"; matches.forEach(s => { const div = document.createElement("div"); div.className = "list-item"; div.innerHTML = `<span><i class="fas fa-map-marker-alt" style="color:var(--primary)"></i> ${s.name}</span>`; div.onclick = () => { saveSearchHistory(s.name); triggerSearch(s.name); }; sugBox.appendChild(div); }); } else { sugBox.style.display = "none"; } };

        function toggleCurrentFav() { if(!targetSpot) return; const idx = myFavs.indexOf(targetSpot.name); if(idx === -1) myFavs.push(targetSpot.name); else myFavs.splice(idx, 1); localStorage.setItem('ruifang_favs', JSON.stringify(myFavs)); document.getElementById("card-fav-icon").className = myFavs.includes(targetSpot.name) ? "fas fa-heart active" : "fas fa-heart"; saveFavToCloud(); }
        function toggleFavList() { const p = document.getElementById("fav-list-panel"); if(p.style.display === "block") { p.style.display = "none"; } else { p.innerHTML = ""; if(myFavs.length === 0) { p.innerHTML = `<div style="padding:15px; text-align:center; color:#888; font-size:13px;">å°šç„¡æ”¶è—æ™¯é»<br>é»æ“Šå¡ç‰‡æ„›å¿ƒåŠ å…¥ï¼</div>`; } else { myFavs.forEach(name => { const div = document.createElement("div"); div.className = "list-item"; div.innerHTML = `<span><i class="fas fa-heart" style="color:var(--danger); margin-right:5px;"></i> ${name}</span>`; div.onclick = () => triggerSearch(name); p.appendChild(div); }); } p.style.display = "block"; } }
        function shareSpot() { if(!targetSpot) return; const spotUrl = new URL(window.location.href); spotUrl.searchParams.set('spot', targetSpot.name); const shareData = { title: `ç‘èŠ³å°è¦½åœ°åœ– - ${targetSpot.name}`, text: `æˆ‘åœ¨ç‘èŠ³åœ°åœ–ä¸Šç™¼ç¾äº†ã€Œ${targetSpot.name}ã€ï¼\nè¶•å¿«é»æ“Šé€£çµæŸ¥çœ‹ï¼š`, url: spotUrl.toString() }; if (navigator.share) navigator.share(shareData).catch(()=>{}); else navigator.clipboard.writeText(`${shareData.text}\n${shareData.url}`).then(() => alert('âœ… å·²è¤‡è£½æ™¯é»è³‡è¨Šèˆ‡é€£çµï¼')); }
        function resetNorth() { map.flyTo([25.1032, 121.8224], 14); } function goToUser() { if(userPos) map.flyTo(userPos, 16); } function drawThemeRoute() { if(currentRoute) map.removeLayer(currentRoute); currentRoute = L.polyline(themeRouteCoords, { color: '#8e44ad', weight: 6, dashArray: '10, 10' }).addTo(map); map.fitBounds(currentRoute.getBounds(), { padding: [50, 50] }); closeCard(); alert("ğŸš€ æ¨è–¦è·¯ç·šå·²è¼‰å…¥ï¼"); } function goToStation() { map.flyTo([25.108, 121.805], 16); closeCard(); } function aiTrip() { if(!userPos) return alert("ç­‰å¾… GPS å®šä½..."); const sorted = [...spots].sort((a,b) => map.distance(userPos,[a.lat,a.lng]) - map.distance(userPos,[b.lat,b.lng])); alert("ğŸ¤– AI æ¨è–¦æœ€è¿‘æ™¯é»ï¼š\n" + sorted.slice(0,5).map((s,i) => `${i+1}. ${s.name}`).join("\n")); }

        const cardEl = document.getElementById("card"); let touchStartY = 0, isSwiping = false; cardEl.addEventListener('touchstart', (e) => { if(cardEl.scrollTop===0){ touchStartY=e.touches[0].clientY; isSwiping=true; cardEl.style.transition='none'; }},{passive:true}); cardEl.addEventListener('touchmove', (e) => { if(isSwiping && e.touches[0].clientY > touchStartY){ cardEl.style.transform=`translateY(${e.touches[0].clientY - touchStartY}px)`; }}); cardEl.addEventListener('touchend', (e) => { if(isSwiping){ isSwiping=false; cardEl.style.transition='transform 0.4s'; if((e.changedTouches[0]?.clientY || 0) - touchStartY > 100) closeCard(); else cardEl.style.transform=''; }});

        window.onload = () => {
            const params = new URLSearchParams(window.location.search); const spotQuery = params.get('spot');
            if(spotQuery) { const s = spots.find(x => x.name === spotQuery); if(s) { setTimeout(() => { map.flyTo([s.lat, s.lng], 16); showCard(s); }, 1000); } }
            applyLanguage(currentLang); fetchWeather();
            if(localStorage.getItem('ruifang_welcomed')) { document.getElementById('splash-screen').style.display = 'none'; document.getElementById('startup-screen').style.display = 'none'; }
        };
    </script>
</body>
</html>
