<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>瑞芳導覽地圖</title>

    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(function(registrations) {
                for(let registration of registrations) { registration.unregister(); }
            });
        }
    </script>

    <meta property="og:title" content="瑞芳導覽地圖" />
    <meta property="og:description" content="探索瑞芳秘境、在地美食與時空旅人路線的專屬智慧地圖！" />
    <meta property="og:type" content="website" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ffffff"> 
    <link rel="apple-touch-icon" href="icon/icon-192.png">
    <link rel="icon" type="image/png" href="icon/icon-192.png">
    
    <link rel="stylesheet" href="style.css?v=500">
</head>
<body id="main-body">

    <div id="splash-screen">
        <div class="logo-anim">瑞</div>
        <h2 class="splash-title-text">瑞芳導覽</h2>
    </div>

    <div id="welcome-screen">
        <div class="welcome-wrapper">
            <div class="logo-static">瑞</div>
            <h1 class="welcome-title" data-i18n="splash_title">瑞芳導覽 App</h1>
            <p class="welcome-desc" data-i18n="splash_desc">致力於提供瑞芳地區最精準的在地導覽，帶領您深度探索山城之美。</p>
            
            <div class="input-group">
                <label data-i18n="lang">語言 / Language</label>
                <select id="lang-select-startup" onchange="applyLanguage(this.value)" class="welcome-select">
                    <option value="zh">繁體中文 (🇹🇼)</option>
                    <option value="en">English (🇺🇸)</option>
                    <option value="ja">日本語 (🇯🇵)</option>
                    <option value="ko">한국어 (🇰🇷)</option>
                    <option value="vi">Tiếng Việt (🇻🇳)</option>
                </select>
            </div>

            <div class="input-group">
                <label data-i18n="feedback_title">測評問卷與聯絡 / Feedback</label>
                <div class="link-box">
                    <a href="https://docs.google.com/forms/d/e/1FAIpQLSfi76mygYPT0XeWDkTVjy1F3NjWTW1qveFKTV2bC5TlJ6yybA/viewform?usp=header" target="_blank"><i class="fas fa-clipboard-list"></i> <span data-i18n="form_link">填寫意見問卷</span></a>
                    <a href="mailto:ruifang689@gmail.com"><i class="fas fa-envelope"></i> <span data-i18n="contact">聯絡開發團隊</span></a>
                </div>
            </div>

            <button class="btn-enter-map" onclick="enterMap()" data-i18n="enter_map">進入地圖</button>
        </div>
    </div>

    <div id="tutorial-overlay">
        <div class="tutorial-box">
            <div id="tut-step-1">
                <h3 data-i18n="tut_step1_title"><i class="fas fa-search"></i> 功能說明 (1/2)</h3>
                <ul>
                    <li>🔍 <b data-i18n="tut_search">搜尋與標籤</b>：上方可快速尋找與篩選景點。</li>
                    <li>📍 <b data-i18n="tut_add">長按新增</b>：地圖長按可新增私房景點。</li>
                    <li>🧭 <b data-i18n="tut_compass">指北針</b>：右下角綠色按鈕，指引方向。</li>
                </ul>
                <div class="tutorial-btns">
                    <button class="btn-fill" style="width: 100%;" onclick="nextTutorial()" data-i18n="tut_next">下一步</button>
                </div>
            </div>
            <div id="tut-step-2" style="display:none;">
                <h3 data-i18n="tut_step2_title"><i class="fas fa-tools"></i> 進階功能 (2/2)</h3>
                <ul>
                    <li>🚗 <b data-i18n="tut_nav">多模式導航</b>：支援步行與開車路線計算。</li>
                    <li>🎬 <b data-i18n="tut_tour">自動導覽</b>：點擊右下角播放鍵自動導覽。</li>
                    <li><span style="color: var(--primary);">●</span> <b data-i18n="tut_share">分享鍵</b>：快速分享景點連結給好友。</li>
                </ul>
                <div class="tutorial-btns">
                    <button class="btn-outline" onclick="prevTutorial()" data-i18n="tut_prev">前一步</button>
                    <button class="btn-fill" onclick="finishTutorial()" data-i18n="tut_finish">開始使用</button>
                </div>
            </div>
        </div>
    </div>

    <div id="weather-box" title="即時天氣"><i class="fas fa-spinner fa-spin"></i><span id="weather-temp">--</span></div>

    <div id="top-ui">
        <div id="search-container" style="width: 100%; position: relative;">
            <input id="search" placeholder="🔍 搜尋或長按新增..." data-i18n="search_ph">
            <i id="search-clear-btn" class="fas fa-times-circle" onclick="clearSearchInput()" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #aaa; cursor: pointer; display: none;"></i>
        </div>
        <div id="category-chips">
            <div class="chip active" onclick="filterSpots('all', this)" data-i18n="chip_all">🌟 全部</div>
            <div class="chip" onclick="filterSpots('美食', this)" data-i18n="chip_food">🍜 美食</div>
            <div class="chip" onclick="filterSpots('歷史', this)" data-i18n="chip_history">🏛️ 歷史</div>
            <div class="chip" onclick="filterSpots('自然', this)" data-i18n="chip_nature">⛰️ 自然</div>
            <div class="chip" onclick="filterSpots('自訂', this)" data-i18n="chip_custom">📍 標記</div>
        </div>
        <div id="map-center-panel"><i class="fas fa-map-marker-alt" style="color:var(--primary)"></i><span id="addr-text" data-i18n="locating">定位中...</span></div>
        <div id="suggest">
            <div class="suggest-header"><span style="font-size:12px; font-weight:bold; color:var(--text-sub);">推薦</span> <i class="fas fa-times" style="cursor:pointer;" onclick="closeSuggest()"></i></div>
            <div id="suggest-content"></div>
        </div>
    </div>

   <div class="map-controls">
        <div class="control-btn" onclick="openSettings()" title="系統設定"><i class="fas fa-cog" style="color: #555;"></i></div>
        <div class="control-btn compass-btn" onclick="resetNorth()" title="指北針"><i class="fas fa-compass" style="color: #27ae60;"></i></div>
        <div class="control-btn route-btn" onclick="openRouteMenu()" title="推薦路線"><i class="fas fa-route" style="color: #8e44ad;"></i></div>
        <div class="control-btn fav-btn" onclick="toggleFavList()" title="我的收藏"><i class="fas fa-folder" style="color: #ff4757;"></i></div>
        <div class="control-btn" id="tour-btn" onclick="toggleGuidedTour()" title="自動導覽"><i class="fas fa-play" style="color: #e84393;"></i></div>
        <div class="control-btn" onclick="goToStation()" title="回到瑞芳中心" style="background:var(--bg-color);"><span class="rui-icon">瑞</span></div>
        <div id="layer-btn" class="control-btn" onclick="toggleLayer()" title="切換底圖"><i class="fas fa-map" style="color: #333;"></i></div>
        <div class="control-btn active" onclick="goToUser()" title="我的位置"><i class="fas fa-location-crosshairs" style="color: var(--primary);"></i></div>
    </div>

    <div id="fav-list-panel"></div>
    <div id="gps-val-text" data-i18n="gps_locating">GPS: 定位中...</div>
    <div id="map"></div>

    <div id="route-info-panel">
        <div class="route-modes">
            <div class="route-mode-btn active" id="mode-driving" onclick="changeNavMode('driving')" title="開車/騎車"><i class="fas fa-car"></i></div>
            <div class="route-mode-btn" id="mode-walking" onclick="changeNavMode('walking')" title="步行"><i class="fas fa-walking"></i></div>
        </div>
        <div class="route-data">
            <span class="route-time" id="route-time">計算中...</span>
            <span class="route-dist" id="route-dist"></span>
        </div>
        <i class="fas fa-times-circle route-close" onclick="closeNav()"></i>
    </div>

    <div id="card">
        <div class="close-bar" onclick="closeCard()"></div>
        <div class="card-header-row">
            <h2 id="title">景點名稱</h2>
            <div class="card-header-icons">
                <i class="fas fa-share-alt" id="card-share-icon" onclick="shareSpot()"></i>
                <i class="fas fa-heart" id="card-fav-icon" onclick="toggleCurrentFav()"></i>
            </div>
        </div>
        <div id="card-tags"></div>
        <img id="img" src="" alt="景點圖片">
        <div class="info-section"><span class="info-label"><i class="fas fa-utensils"></i> <span data-i18n="food">特色</span></span><span class="info-text" id="card-food"></span></div>
        <div class="info-section"><span class="info-label"><i class="fas fa-star"></i> <span data-i18n="highlights">推薦亮點</span></span><span class="info-text" id="card-highlights"></span></div>
        <div class="info-section"><span class="info-label"><i class="fas fa-book-open"></i> <span data-i18n="history">歷史</span></span><span class="info-text" id="card-history"></span></div>
        <div class="info-section"><span class="info-label"><i class="fas fa-bus"></i> <span data-i18n="transport">交通</span></span><span class="info-text" id="card-transport"></span></div>
        <div class="btn-group" id="card-btn-group"></div>
    </div>

    <div id="settings-modal-overlay" class="modal-overlay">
        <div class="modal-box">
            <h2 class="settings-title" data-i18n="settings"><i class="fas fa-cog"></i> 系統設定</h2>
            
            <h3 class="settings-sub" data-i18n="lang"><i class="fas fa-globe"></i> 語言 / Language</h3>
            <select id="lang-select-settings" onchange="applyLanguage(this.value)" class="modal-select">
                <option value="zh">繁體中文 (🇹🇼)</option>
                <option value="en">English (🇺🇸)</option>
                <option value="ja">日本語 (🇯🇵)</option>
                <option value="ko">한국어 (🇰🇷)</option>
                <option value="vi">Tiếng Việt (🇻🇳)</option>
            </select>
        
            <h3 class="settings-sub" data-i18n="theme"><i class="fas fa-palette"></i> 主題顏色</h3>
            <select id="theme-select" onchange="changeTheme(this.value)" class="modal-select">
                <option value="default">系統主題色 (預設)</option>
                <option value="#007bff">活力藍</option>
                <option value="#333333">極簡黑</option>
                <option value="#28a745">自然綠</option>
                <option value="#27ae60">森林綠</option>
                <option value="#f39c12">溫暖橘</option>
                <option value="#e67e22">夕陽橘</option>
                <option value="#8e44ad">神秘紫</option>
                <option value="#e84393">櫻花粉</option>
                <option value="custom">自訂顏色...</option>
            </select>
            <input type="color" id="custom-color-picker" style="display:none; width:100%; margin-top:10px; height:40px; border:none; cursor:pointer;" onchange="applyCustomTheme(this.value, true)">
    
            <div style="margin-top: 15px; border-top: 1px dashed var(--divider-color); padding-top: 15px;">
                <label style="display: flex; align-items: center; gap: 10px; font-weight: bold; font-size: 15px; cursor: pointer; color: #111111;">
                    <input type="checkbox" id="skip-intro-toggle" onchange="toggleSkipIntro(this.checked)" style="width: 18px; height: 18px;">
                    <span data-i18n="skip_intro">啟動時略過開場動畫與說明教學</span>
                </label>
            </div>

            <div id="install-btn-container" style="display:none; margin-top: 15px;">
                <button class="install-pwa-btn" onclick="installPWA()"><i class="fas fa-download"></i> <span data-i18n="install_app">將 App 安裝至桌面</span></button>
            </div>

            <div class="contact-section">
                <h3 class="settings-sub" style="width:100%; margin-bottom:10px;" data-i18n="feedback_title">測評問卷與聯絡</h3>
                <a href="https://docs.google.com/forms/d/e/1FAIpQLSfi76mygYPT0XeWDkTVjy1F3NjWTW1qveFKTV2bC5TlJ6yybA/viewform?usp=header" target="_blank" class="contact-btn"><i class="fas fa-clipboard-list"></i> <span data-i18n="form_link">填寫意見問卷</span></a>
                <a href="mailto:ruifang689@gmail.com" class="contact-btn"><i class="fas fa-envelope"></i> <span data-i18n="contact">聯絡開發團隊</span></a>
                <div class="contact-btn" onclick="shareAppMap()"><i class="fas fa-share-alt"></i> <span data-i18n="share_map_title">推薦地圖給好友</span></div>
            </div>

            <div style="text-align:center; margin-top: 10px;">
                <button onclick="reopenTutorial()" style="background:transparent; border:1px solid #aaa; padding:8px 20px; border-radius:8px; color:#555; font-size:13px; cursor:pointer;">
                    <i class="fas fa-info-circle"></i> <span data-i18n="tut_title">功能說明教學</span>
                </button>
            </div>

            <div class="modal-btns">
                <button class="modal-cancel" onclick="closeSettings()" data-i18n="close">關閉</button>
            </div>
        </div>
    </div>

    <div id="route-select-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 class="modal-title route"><i class="fas fa-route"></i> 推薦行程路線</h3>
            <div class="route-list-container">
                <div class="route-item" onclick="selectRoute('history')"><div class="route-info"><span class="route-name">🏛️ 歷史懷舊線</span><span class="route-desc">瑞芳車站 ➔ 後站老街 ➔ 九份老街 ➔ 黃金博物館</span></div></div>
                <div class="route-item" onclick="selectRoute('nature')"><div class="route-info"><span class="route-name">⛰️ 山海自然線</span><span class="route-desc">瑞芳車站 ➔ 猴硐貓村 ➔ 報時山步道 ➔ 陰陽海</span></div></div>
                <div class="route-item" onclick="selectRoute('food')"><div class="route-info"><span class="route-name">🍜 饕客美食線</span><span class="route-desc">瑞芳美食廣場 ➔ 芋圓 ➔ 礦工便當</span></div></div>
            </div>
            <button class="modal-cancel" style="width: 100%; margin-top: 15px;" onclick="closeRouteMenu()">關閉</button>
        </div>
    </div>

    <div id="fav-manage-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 class="modal-title fav"><i class="fas fa-folder-open"></i> <span data-i18n="manage_fav">管理收藏夾</span></h3>
            <div id="fav-manage-list" style="max-height: 50vh; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; padding-right: 5px;"></div>
            <div class="modal-btns">
                <button class="modal-cancel" onclick="closeFavManage()" data-i18n="close" style="width: 100%;">關閉</button>
            </div>
        </div>
    </div>

    <div id="edit-modal-overlay" class="modal-overlay">
        <div class="modal-box">
            <h3 class="modal-title"><i class="fas fa-edit" style="color: var(--primary);"></i> 編輯自訂標記</h3>
            <input type="text" id="edit-name" class="modal-input" placeholder="地點名稱 (必填)">
            <textarea id="edit-highlights" class="modal-textarea" placeholder="推薦亮點..."></textarea>
            <textarea id="edit-history" class="modal-textarea" placeholder="備註或歷史..."></textarea>
            <label class="modal-file-label"><i class="fas fa-camera"></i> 上傳專屬照片<input type="file" id="edit-image" accept="image/*" style="display:none;"></label>
            <img id="edit-image-preview" src="">
            <div class="modal-btns">
                <button class="modal-cancel" onclick="closeEditModal()">取消</button>
                <button class="modal-save" onclick="saveEditSpot()">儲存</button>
            </div>
        </div>
    </div>

    <div id="custom-spot-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 class="modal-title"><i class="fas fa-map-pin" style="color: var(--primary);"></i> 新增自訂景點</h3>
            <div id="custom-spot-addr" style="font-size: 13px; color: var(--text-sub); margin-bottom: 5px; padding: 12px; background: var(--divider-color); border-radius: 8px; line-height: 1.6; border: 1px solid var(--border-color);">
                📍 載入中...
            </div>
            <input type="text" id="custom-spot-name" class="modal-input" placeholder="請為此秘境命名 (例：我的秘密基地)">
            <div class="modal-btns">
                <button class="modal-cancel" onclick="closeCustomSpotModal()">取消</button>
                <button class="modal-save" onclick="confirmCustomSpot()">儲存景點</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
    
    <script type="module" src="./js/main.js?v=500"></script>

    <script>
        setTimeout(() => {
            const splash = document.getElementById('splash-screen');
            if (splash && splash.style.display !== 'none' && splash.style.opacity !== '0') {
                splash.style.display = 'none';
                const welcome = document.getElementById('welcome-screen');
                if (!localStorage.getItem('ruifang_welcomed') && !localStorage.getItem('ruifang_skip_intro') === 'true' && welcome) {
                    welcome.style.display = 'flex'; welcome.style.opacity = '1';
                }
            }
        }, 3000);
    </script>
</body>
</html>





