<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <title>ç‘èŠ³å°è¦½åœ°åœ–</title>

    <meta property="og:title" content="ç‘èŠ³å°è¦½åœ°åœ–" />
    <meta property="og:description" content="æ¢ç´¢ç‘èŠ³ç§˜å¢ƒã€åœ¨åœ°ç¾é£Ÿèˆ‡æ™‚ç©ºæ—…äººè·¯ç·šçš„å°ˆå±¬æ™ºæ…§åœ°åœ–ï¼" />
    <meta property="og:type" content="website" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* =========================================
           1. åŸºç¤è®Šæ•¸èˆ‡å…¨å±€è¨­å®š
           ========================================= */
        :root { 
            --primary: #007bff;           
            --glass: rgba(255, 255, 255, 0.95); 
            --accent: #e67e22;            
            --danger: #ff4757;            
            --text: #333;                 
            --card-shadow: rgba(0,0,0,0.15); 
        }

        body.dark-mode { 
            --glass: rgba(40, 40, 40, 0.95); 
            --text: #f0f0f0; 
            --card-shadow: rgba(0,0,0,0.4);
        }

        html, body { margin: 0; padding: 0; width: 100vw; height: 100%; height: 100dvh; overflow: hidden; font-family: -apple-system, "Microsoft JhengHei", sans-serif; }
        #map { position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 1; }

        /* =========================================
           2. é ‚éƒ¨ UI å€å¡Š
           ========================================= */
        #top-ui { position: absolute; top: calc(15px + env(safe-area-inset-top, 0px)); left: 50%; transform: translateX(-50%); z-index: 3000; width: 85%; max-width: 380px; display: flex; flex-direction: column; align-items: center; gap: 6px; }
        #search { width: 100%; padding: 12px 20px; border: none; border-radius: 30px; box-shadow: 0 4px 20px var(--card-shadow); outline: none; background: var(--glass); color: var(--text); font-size: 15px; text-align: center; box-sizing: border-box; transition: all 0.3s; }
        #search:focus { box-shadow: 0 4px 25px rgba(0, 123, 255, 0.3); }
        #map-center-panel { width: 100%; color: var(--text); font-size: 13px; font-weight: bold; display: flex; justify-content: center; align-items: center; gap: 6px; pointer-events: none; text-shadow: -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff, 1px 1px 0 #fff, 0 0 5px rgba(255,255,255,0.8); }
        body.dark-mode #map-center-panel { text-shadow: -1px -1px 0 #222, 1px -1px 0 #222, -1px 1px 0 #222, 1px 1px 0 #222, 0 0 5px rgba(0,0,0,0.8); }

        /* =========================================
           3. å¤©æ°£ & å°èˆªé¢æ¿
           ========================================= */
        #weather-box { position: absolute; top: calc(15px + env(safe-area-inset-top, 0px)); right: calc(15px + env(safe-area-inset-right, 0px)); z-index: 3000; width: 50px; height: 50px; background: var(--glass); backdrop-filter: blur(8px); border-radius: 12px; box-shadow: 0 4px 15px var(--card-shadow); border: 1px solid rgba(255,255,255,0.2); color: var(--text); display: flex; flex-direction: column; justify-content: center; align-items: center; }
        #weather-box i { font-size: 20px; margin-bottom: 2px; } #weather-temp { font-size: 12px; font-weight: bold; }
        #route-info-panel { position: absolute; top: calc(85px + env(safe-area-inset-top, 0px)); left: 50%; transform: translateX(-50%); background: var(--glass); backdrop-filter: blur(10px); color: var(--text); padding: 12px 25px; border-radius: 30px; box-shadow: 0 8px 25px rgba(255, 71, 87, 0.3); display: none; align-items: center; gap: 15px; z-index: 3000; border: 2px solid var(--danger); }
        .route-data { display: flex; flex-direction: column; line-height: 1.2; } .route-time { color: var(--danger); font-size: 18px; font-weight: bold; } .route-dist { font-size: 12px; color: #666; font-weight: bold; } .route-close { cursor: pointer; color: #888; font-size: 22px; transition: color 0.2s; } .route-close:hover { color: var(--text); }

        /* =========================================
           4. ä¸‹æ‹‰æ¸…å–® (æœå°‹èˆ‡æ”¶è—)
           ========================================= */
        #suggest, #fav-list-panel { background: var(--glass); border-radius: 18px; margin-top: 5px; overflow-y: auto; max-height: 250px; width: 100%; display: none; box-shadow: 0 10px 25px var(--card-shadow); z-index: 3100; scrollbar-width: none; }
        #fav-list-panel { position: absolute; bottom: calc(150px + env(safe-area-inset-bottom, 0px)); right: calc(70px + env(safe-area-inset-right, 0px)); width: 200px; }
        .list-item { padding: 14px 20px; border-bottom: 1px solid rgba(0,0,0,0.05); cursor: pointer; display: flex; align-items: center; gap: 10px; color: var(--text); justify-content: space-between; font-size: 15px; font-weight: bold; }
        .list-item:active { background: rgba(0,0,0,0.05); } .search-section-title { padding: 12px 20px 6px; font-size: 12px; color: #888; font-weight: bold; background: rgba(0,0,0,0.03); letter-spacing: 1px; }

        /* =========================================
           5. åŸºç¤æ§åˆ¶çµ„ä»¶
           ========================================= */
        .leaflet-bottom.leaflet-right { bottom: calc(20px + env(safe-area-inset-bottom, 0px)) !important; right: calc(15px + env(safe-area-inset-right, 0px)) !important; }
        .leaflet-control-scale { margin: 0 !important; } .leaflet-control-scale-line { background: rgba(255, 255, 255, 0.8) !important; border: 2px solid #333 !important; font-weight: bold; line-height: 1.2; padding: 2px 5px; }
        #gps-val-text { position: absolute; bottom: calc(21px + env(safe-area-inset-bottom, 0px)); right: calc(125px + env(safe-area-inset-right, 0px)); left: auto; z-index: 3000; font-family: monospace; font-size: 12px; font-weight: bold; color: var(--text); pointer-events: none; text-shadow: -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff, 1px 1px 0 #fff, 0 0 5px rgba(255,255,255,0.8); }
        body.dark-mode #gps-val-text { text-shadow: -1px -1px 0 #222, 1px -1px 0 #222, -1px 1px 0 #222, 1px 1px 0 #222, 0 0 5px rgba(0,0,0,0.8); }

        .map-controls { position: absolute; bottom: calc(85px + env(safe-area-inset-bottom, 0px)); right: calc(12px + env(safe-area-inset-right, 0px)); z-index: 3000; display: flex; flex-direction: column; gap: 12px; }
        .control-btn { background: var(--glass); width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px var(--card-shadow); cursor: pointer; color: var(--text); font-size: 20px; border: 1px solid rgba(255,255,255,0.2); transition: transform 0.1s; }
        .control-btn:active { transform: scale(0.9); }
        .route-btn { color: #8e44ad; } .fav-btn { color: var(--danger); } .active { color: var(--primary); border: 2px solid var(--primary); }
        .rui-icon { font-family: "DFKai-sb", "BiauKai", serif; font-weight: 900; font-size: 18px; color: var(--accent); border: 2px solid var(--accent); border-radius: 4px; padding: 1px 3px; line-height: 1; transition: all 0.2s ease; }
        @keyframes stamp-press { 0% { transform: scale(1) rotate(0deg); text-shadow: none; box-shadow: none; } 40% { transform: scale(0.8) rotate(-8deg); color: var(--danger); border-color: var(--danger); text-shadow: 0 0 8px rgba(255, 71, 87, 0.8); box-shadow: 0 0 12px rgba(255, 71, 87, 0.5) inset, 0 0 12px rgba(255, 71, 87, 0.5); } 70% { transform: scale(1.1) rotate(3deg); } 100% { transform: scale(1) rotate(0deg); text-shadow: none; box-shadow: none; } }
        .rui-icon.stamped { animation: stamp-press 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

        /* =========================================
           6. å„å¼å½ˆå‡ºè¦–çª— (Modal) çš„å…±ç”¨èˆ‡å°ˆå±¬è¨­è¨ˆ
           åŒ…å«ï¼šè¿è³“èªªæ˜(Splash)ã€è¨­å®š(Settings)ã€ç·¨è¼¯(Edit)
           ========================================= */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100dvh;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
            z-index: 6000; display: none; align-items: center; justify-content: center;
        }
        @keyframes fadeInScale { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .modal-box {
            background: var(--glass); width: 85%; max-width: 420px; max-height: 85vh; overflow-y: auto;
            border-radius: 20px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: flex; flex-direction: column; gap: 15px; color: var(--text); border: 1px solid rgba(255,255,255,0.2);
            animation: fadeInScale 0.3s ease-out;
            -webkit-overflow-scrolling: touch;
        }
        .modal-box h2 { text-align: center; color: var(--primary); margin: 0 0 5px 0; font-size: 24px; }
        .modal-box h3 { margin: 0; font-size: 18px; color: var(--accent); display: flex; align-items: center; gap: 8px; }
        .modal-box p { margin: 5px 0 15px 0; font-size: 14px; line-height: 1.6; opacity: 0.9; }
        
        .modal-input, .modal-textarea, .modal-select { 
            width: 100%; padding: 12px 15px; border: 1px solid rgba(0,0,0,0.1); 
            border-radius: 12px; box-sizing: border-box; font-size: 15px; 
            background: rgba(255,255,255,0.7); outline: none; font-family: inherit; color: var(--text);
        }
        .modal-input:focus, .modal-textarea:focus, .modal-select:focus { border-color: var(--primary); background: #fff; }
        .modal-textarea { height: 100px; resize: none; }
        
        .modal-file-label { display: block; background: #e8f4fd; color: var(--primary); text-align: center; padding: 12px; border-radius: 12px; cursor: pointer; font-weight: bold; border: 1px dashed var(--primary); transition: background 0.2s; }
        .modal-file-label:active { background: #d0e7fb; }
        #edit-image-preview { width: 100%; height: 140px; object-fit: cover; border-radius: 12px; display: none; margin-top: 5px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        .modal-btns { display: flex; gap: 12px; margin-top: 10px; }
        .modal-btns button { flex: 1; padding: 14px; border: none; border-radius: 12px; font-weight: bold; font-size: 16px; cursor: pointer; color: white; transition: transform 0.1s; }
        .modal-btns button:active { transform: scale(0.95); }
        .modal-save { background: var(--primary); } .modal-cancel { background: #888; }

        /* =========================================
           7. åº•éƒ¨è©³ç´°è³‡è¨Šå¤§å¡ç‰‡
           ========================================= */
        #card { position: absolute; bottom: 0; left: 0; width: 100%; transform: translateY(110%); max-height: 80vh; background: var(--glass); color: var(--text); transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); z-index: 4000; padding: 25px; padding-bottom: calc(25px + env(safe-area-inset-bottom, 0px)); box-sizing: border-box; border-radius: 25px 25px 0 0; box-shadow: 0 -8px 25px var(--card-shadow); overflow-y: auto; will-change: transform; }
        #card.open { transform: translateY(0); } .close-bar { width: 50px; height: 5px; background: #888; border-radius: 10px; margin: -10px auto 15px; cursor: pointer; }
        .card-header-row { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; position: relative; }
        #title { margin: 0; font-size: 26px; line-height: 1.2; padding-right: 70px; }
        .card-header-icons { position: absolute; right: 0; top: 0; display: flex; gap: 15px; align-items: center; margin-top: 4px; }
        .card-header-icons i { font-size: 22px; cursor: pointer; color: #ccc; transition: all 0.2s; }
        #card-share-icon { color: var(--primary) !important; } #card-share-icon:active { transform: scale(0.9); opacity: 0.8; }
        #card-fav-icon.active { color: var(--danger); transform: scale(1.2); }
        #card-tags { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 15px; }
        #img { width: 100%; height: 180px; object-fit: cover; border-radius: 15px; margin-bottom: 15px; background: #eee; }
        .info-section { margin-bottom: 15px; } .info-label { font-weight: bold; color: var(--text); display: block; margin-bottom: 4px; font-size: 15px; border-left: 4px solid var(--primary); padding-left: 10px; line-height: 1.2; } .info-text { color: var(--text); opacity: 0.8; font-size: 14px; line-height: 1.6; display: block; padding-left: 14px; }
        .btn-group { display: flex; gap: 10px; margin-top: 25px; } .btn-group button { flex: 1; padding: 14px; border: none; border-radius: 12px; background: var(--primary); color: white; cursor: pointer; font-weight: bold; font-size: 15px; display: flex; align-items: center; justify-content: center; gap: 6px;} .btn-group button.secondary { background: #555; } .btn-group button.danger { background: var(--danger); } .btn-group button.edit-btn { background: #f39c12; }

        /* =========================================
           8. åœ°åœ–å°åœ–é‡˜ & Popup
           ========================================= */
        .custom-pin-wrap { position: relative; } .gmap-pin { width: 32px; height: 32px; border-radius: 50% 50% 50% 0; position: absolute; transform: rotate(-45deg); left: 50%; top: 50%; margin: -16px 0 0 -16px; box-shadow: -2px 2px 4px rgba(0,0,0,0.4); border: 2px solid #fff; display: flex; align-items: center; justify-content: center; } .gmap-pin i { transform: rotate(45deg); color: #fff; font-size: 14px; }
        .user-pulse-icon { display: flex; justify-content: center; align-items: center; } .user-pulse-icon .dot { width: 14px; height: 14px; background: #007bff; border: 2px solid #fff; border-radius: 50%; z-index: 2; box-shadow: 0 0 8px rgba(0,0,0,0.5); } .user-pulse-icon .pulse { position: absolute; width: 40px; height: 40px; background: rgba(0, 123, 255, 0.6); border-radius: 50%; animation: radar-pulse 1.5s infinite ease-out; z-index: 1; } @keyframes radar-pulse { 0% { transform: scale(0.5); opacity: 1; } 100% { transform: scale(2.5); opacity: 0; } }
        .leaflet-popup-content-wrapper { border-radius: 15px; background: var(--glass); padding: 0; overflow: hidden; } .leaflet-popup-content { margin: 0; width: 260px !important; color: var(--text); } .preview-card { width: 260px; cursor: pointer; } .preview-img { width: 100%; height: 130px; object-fit: cover; } .preview-info { padding: 12px; } .preview-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 5px; } .preview-title { font-weight: bold; font-size: 17px; } .walk-badge { font-size: 11px; background: #e8f4fd; color: #007bff; padding: 3px 8px; border-radius: 12px; font-weight: bold; } .mini-tag { display: inline-block; font-size: 10px; padding: 2px 6px; margin: 2px 2px 0 0; border-radius: 4px; background: rgba(0,123,255,0.1); color: var(--primary); font-weight: bold; } .food-preview { font-size: 13px; color: var(--accent); font-weight: bold; border-top: 1px dashed rgba(0,0,0,0.1); padding-top: 10px; margin-top: 10px; } body.dark-mode .food-preview { border-top: 1px dashed rgba(255,255,255,0.2); }

        /* =========================================
           9. æ‰‹æ©Ÿé©é…
           ========================================= */
        @media (max-width: 768px) and (orientation: portrait) { #top-ui { left: calc(15px + env(safe-area-inset-left, 0px)); transform: none; width: calc(100% - 85px - env(safe-area-inset-right, 0px)); align-items: stretch; } #search { text-align: left; padding-left: 20px; } #map-center-panel { justify-content: flex-start; padding-left: 20px; } #gps-val-text { left: calc(15px + env(safe-area-inset-left, 0px)); right: auto; } }
        @media (max-height: 500px) and (orientation: landscape) { #top-ui { left: calc(15px + env(safe-area-inset-left, 0px)); transform: none; width: 300px; align-items: stretch; } #search { text-align: left; padding-left: 20px; } #map-center-panel { justify-content: flex-start; padding-left: 20px; } #gps-val-text { left: calc(15px + env(safe-area-inset-left, 0px)); right: auto; } .map-controls { flex-direction: row; bottom: calc(15px + env(safe-area-inset-bottom, 0px)); left: 50%; transform: translateX(-50%); right: auto; gap: 10px; } .control-btn { width: 40px; height: 40px; font-size: 16px; } .rui-icon { font-size: 14px; border-width: 1px; padding: 1px 2px; } #fav-list-panel { left: 50%; transform: translateX(-50%); right: auto; bottom: calc(65px + env(safe-area-inset-bottom, 0px)); } }
    </style>
</head>
<body id="main-body">

<div id="weather-box" title="å³æ™‚å¤©æ°£"><i class="fas fa-spinner fa-spin" style="color:#ccc"></i><span id="weather-temp">--</span></div>

<div id="top-ui">
    <input id="search" placeholder="ğŸ” æœå°‹æ™¯é»æˆ–é•·æŒ‰åœ°åœ–æ¨™è¨˜...">
    <div id="map-center-panel"><i class="fas fa-map-marker-alt" style="color:var(--primary)"></i><span id="addr-text" data-i18n="addr_locating">å®šä½ä¸­...</span></div>
    <div id="suggest"></div>
</div>

<div id="route-info-panel">
    <i class="fas fa-car" style="font-size:20px; color:var(--primary);"></i>
    <div class="route-data">
        <span id="route-time" class="route-time">-- åˆ†é˜</span>
        <span id="route-dist" class="route-dist">-- km</span>
    </div>
    <i class="fas fa-times-circle route-close" onclick="closeNav()"></i>
</div>

<div class="map-controls">
    <div class="control-btn" onclick="openSettings()" title="è¨­å®š"><i class="fas fa-cog"></i></div>
    <div class="control-btn compass-btn" onclick="resetNorth()" title="å›åˆ°å…¨æ™¯"><i class="fas fa-compass"></i></div>
    <div class="control-btn route-btn" onclick="drawThemeRoute()" title="æ™‚ç©ºæ—…äººè·¯ç·š"><i class="fas fa-route"></i></div>
    <div class="control-btn fav-btn" onclick="toggleFavList()" title="æˆ‘çš„æ”¶è—"><i class="fas fa-folder-open"></i></div>
    <div class="control-btn station-btn" onclick="goToStation()" title="å›åˆ°ç‘èŠ³ä¸­å¿ƒ"><span class="rui-icon">ç‘</span></div>
    <div class="control-btn" id="layer-btn" onclick="toggleLayer()" title="åˆ‡æ›åº•åœ–"><i class="fas fa-map"></i></div>
    <div class="control-btn active" onclick="goToUser()" title="æˆ‘çš„ä½ç½®"><i class="fas fa-location-crosshairs"></i></div>
</div>

<div id="fav-list-panel"></div>
<div id="gps-val-text" data-i18n="gps_locating">GPS: å®šä½ä¸­...</div>
<div id="map"></div>

<div id="card">
    <div class="close-bar" onclick="closeCard()"></div>
    <div class="card-header-row">
        <h2 id="title"></h2>
        <div class="card-header-icons">
            <i id="card-share-icon" class="fas fa-share-nodes" onclick="shareSpot()" title="åˆ†äº«æ­¤æ™¯é»"></i>
            <i id="card-fav-icon" class="fas fa-heart" onclick="toggleCurrentFav()"></i>
        </div>
    </div>
    <div id="card-tags"></div>
    <img id="img">
    <div class="info-section"><span class="info-label"><i class="fas fa-utensils"></i> <span data-i18n="label_food">åœ¨åœ°é£²é£Ÿ</span></span><span id="card-food" class="info-text"></span></div>
    <div class="info-section"><span class="info-label"><i class="fas fa-star"></i> <span data-i18n="label_highlight">æ¨è–¦äº®é»</span></span><span id="card-highlights" class="info-text"></span></div>
    <div class="info-section"><span class="info-label"><i class="fas fa-history"></i> <span data-i18n="label_history">ç°¡ä»‹æ­·å²</span></span><span id="card-history" class="info-text"></span></div>
    <div class="info-section"><span class="info-label"><i class="fas fa-bus"></i> <span data-i18n="label_transport">äº¤é€šæ–¹å¼</span></span><span id="card-transport" class="info-text"></span></div>
    <div class="btn-group" id="card-btn-group"></div>
</div>

<div id="splash-screen" class="modal-overlay">
    <div class="modal-box">
        <h2 id="splash-title" data-i18n="splash_title">ç‘èŠ³å°è¦½åœ°åœ–</h2>
        
        <h3 id="splash-purpose-title"><i class="fas fa-bullseye"></i> é–‹ç™¼ç›®çš„</h3>
        <p id="splash-purpose-desc" data-i18n="splash_purpose_desc">å°ˆç‚ºæ¢ç´¢ç‘èŠ³ç§˜å¢ƒã€å“åšåœ¨åœ°ç¾é£Ÿèˆ‡é«”é©—ç¤¦æ¥­æ­·å²æ‰€è¨­è¨ˆï¼Œæä¾›ç„¡ç¸«çš„æ™ºæ…§å°è¦½é«”é©—ã€‚</p>
        
        <h3 id="splash-features-title"><i class="fas fa-star"></i> æ ¸å¿ƒåŠŸèƒ½</h3>
        <p id="splash-features-desc" data-i18n="splash_features_desc">âœ¨ æ™¯é»æ¢ç´¢ã€ğŸš— è·¯ç·šå°èˆªã€â¤ï¸ å°ˆå±¬æ”¶è—ã€âœï¸ è‡ªè¨‚æ¨™è¨˜ã€‚</p>
        
        <h3 id="splash-ui-title"><i class="fas fa-mobile-alt"></i> ä»‹é¢èªªæ˜</h3>
        <p id="splash-ui-desc" data-i18n="splash_ui_desc">é»æ“Šåœ°åœ–åœ–é‡˜å¯é è¦½æ™¯é»ï¼›é•·æŒ‰åœ°åœ–å¯æ–°å¢å°ˆå±¬åœ°é»ï¼›å³ä¸‹è§’æŒ‰éˆ•æä¾›åœ–å±¤åˆ‡æ›èˆ‡åŠŸèƒ½æ·å¾‘ã€‚</p>

        <h3 id="splash-lang-title"><i class="fas fa-globe"></i> Language / èªè¨€</h3>
        <select id="splash-lang" class="modal-select" onchange="previewLanguage(this.value)">
            <option value="zh">ç¹é«”ä¸­æ–‡</option>
            <option value="en">English</option>
            <option value="ja">æ—¥æœ¬èª</option>
        </select>

        <div class="modal-btns">
            <button class="modal-save" onclick="closeSplash()" id="start-explore-btn" data-i18n="start_explore">é–‹å§‹æ¢ç´¢</button>
        </div>
    </div>
</div>

<div id="settings-modal-overlay" class="modal-overlay">
    <div class="modal-box">
        <h2 id="settings-title" data-i18n="settings_title"><i class="fas fa-cog"></i> è¨­å®š</h2>
        <h3 id="settings-lang-title"><i class="fas fa-globe"></i> Language / èªè¨€</h3>
        <select id="settings-lang" class="modal-select">
            <option value="zh">ç¹é«”ä¸­æ–‡</option>
            <option value="en">English</option>
            <option value="ja">æ—¥æœ¬èª</option>
        </select>
        <div class="modal-btns">
            <button class="modal-cancel" onclick="closeSettings()" id="settings-cancel" data-i18n="cancel">å–æ¶ˆ</button>
            <button class="modal-save" onclick="saveSettings()" id="settings-save" data-i18n="save">å„²å­˜</button>
        </div>
    </div>
</div>

<div id="edit-modal-overlay" class="modal-overlay">
    <div class="modal-box">
        <h3><i class="fas fa-edit"></i> <span id="edit-modal-title" data-i18n="edit_modal_title">ç·¨è¼¯è‡ªè¨‚æ¨™è¨˜</span></h3>
        <input type="text" id="edit-name" class="modal-input" placeholder="åç¨±å¿…å¡«">
        <input type="text" id="edit-highlights" class="modal-input" placeholder="æ¨è–¦äº®é»">
        <textarea id="edit-history" class="modal-textarea" placeholder="æ­·å²ç°¡ä»‹..."></textarea>
        <label class="modal-file-label"><i class="fas fa-camera"></i> <span id="edit-photo-label" data-i18n="edit_photo">ä¸Šå‚³ç…§ç‰‡</span><input type="file" id="edit-image" accept="image/*" style="display:none;"></label>
        <img id="edit-image-preview">
        <div class="modal-btns">
            <button class="modal-cancel" onclick="closeEditModal()" id="edit-cancel" data-i18n="cancel">å–æ¶ˆ</button>
            <button class="modal-save" onclick="saveEditSpot()" id="edit-save" data-i18n="save">å„²å­˜</button>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<script>
// =========================================
// 0. å¤šåœ‹èªè¨€å­—å…¸ (i18n) & è¨­å®šé‚è¼¯
// =========================================
const translations = {
    'zh': {
        splash_title: "ç‘èŠ³å°è¦½åœ°åœ–", splash_purpose_title: "é–‹ç™¼ç›®çš„", splash_purpose_desc: "å°ˆç‚ºæ¢ç´¢ç‘èŠ³ç§˜å¢ƒã€å“åšåœ¨åœ°ç¾é£Ÿèˆ‡é«”é©—ç¤¦æ¥­æ­·å²æ‰€è¨­è¨ˆï¼Œæä¾›ç„¡ç¸«çš„æ™ºæ…§å°è¦½é«”é©—ã€‚", splash_features_title: "æ ¸å¿ƒåŠŸèƒ½", splash_features_desc: "âœ¨ æ™¯é»æ¢ç´¢ã€ğŸš— è·¯ç·šå°èˆªã€â¤ï¸ å°ˆå±¬æ”¶è—ã€âœï¸ è‡ªè¨‚æ¨™è¨˜ã€‚", splash_ui_title: "ä»‹é¢èªªæ˜", splash_ui_desc: "é»æ“Šåœ°åœ–åœ–é‡˜å¯é è¦½æ™¯é»ï¼›é•·æŒ‰åœ°åœ–å¯æ–°å¢å°ˆå±¬åœ°é»ï¼›å³ä¸‹è§’æŒ‰éˆ•æä¾›åˆ‡æ›èˆ‡æ·å¾‘ã€‚", start_explore: "é–‹å§‹æ¢ç´¢",
        settings_title: "è¨­å®š", cancel: "å–æ¶ˆ", save: "å„²å­˜",
        search_placeholder: "ğŸ” æœå°‹æ™¯é»æˆ–é•·æŒ‰åœ°åœ–æ–°å¢æ¨™è¨˜...", addr_locating: "å®šä½ä¸­...", gps_locating: "GPS: å®šä½ä¸­...", no_favs: "å°šç„¡æ”¶è—æ™¯é»<br>é»æ“Šå¡ç‰‡æ„›å¿ƒåŠ å…¥ï¼",
        label_food: "åœ¨åœ°é£²é£Ÿ", label_highlight: "æ¨è–¦äº®é»", label_history: "ç°¡ä»‹æ­·å²", label_transport: "äº¤é€šæ–¹å¼",
        btn_nav: " å°èˆª", btn_edit: " ç·¨è¼¯", btn_del: " åˆªé™¤", btn_trip: " è¡Œç¨‹è¦åŠƒ",
        edit_modal_title: "ç·¨è¼¯è‡ªè¨‚æ¨™è¨˜", edit_photo: "é¸æ“‡å°é¢ç…§ç‰‡"
    },
    'en': {
        splash_title: "Ruifang Guide Map", splash_purpose_title: "Purpose", splash_purpose_desc: "Designed to explore Ruifang's hidden gems, local food, and mining history with a seamless smart guide experience.", splash_features_title: "Features", splash_features_desc: "âœ¨ Spot Discovery, ğŸš— Navigation, â¤ï¸ Favorites, âœï¸ Custom Markers.", splash_ui_title: "UI Guide", splash_ui_desc: "Click pins to preview spots; Long press map to add custom spots; Use bottom-right buttons for shortcuts.", start_explore: "Start Exploring",
        settings_title: "Settings", cancel: "Cancel", save: "Save",
        search_placeholder: "ğŸ” Search or long press to add...", addr_locating: "Locating...", gps_locating: "GPS: Locating...", no_favs: "No favorites yet.<br>Click heart to add!",
        label_food: "Local Food", label_highlight: "Highlights", label_history: "History", label_transport: "Transport",
        btn_nav: " Navigate", btn_edit: " Edit", btn_del: " Delete", btn_trip: " Plan Trip",
        edit_modal_title: "Edit Marker", edit_photo: "Choose Photo"
    },
    'ja': {
        splash_title: "ãƒ«ã‚¤ãƒ•ã‚¡ãƒ³è¦³å…‰ãƒãƒƒãƒ—", splash_purpose_title: "ç›®çš„", splash_purpose_desc: "ç‘èŠ³ï¼ˆãƒ«ã‚¤ãƒ•ã‚¡ãƒ³ï¼‰ã®ç§˜å¢ƒã€åœ°å…ƒã‚°ãƒ«ãƒ¡ã€é‰±æ¥­ã®æ­´å²ã‚’ã‚·ãƒ¼ãƒ ãƒ¬ã‚¹ã«æ¢ç´¢ã™ã‚‹ãŸã‚ã«è¨­è¨ˆã•ã‚Œã¾ã—ãŸã€‚", splash_features_title: "æ©Ÿèƒ½", splash_features_desc: "âœ¨ ã‚¹ãƒãƒƒãƒˆæ¢ç´¢ã€ğŸš— ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã€â¤ï¸ ãŠæ°—ã«å…¥ã‚Šã€âœï¸ ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ¼ã‚«ãƒ¼", splash_ui_title: "UI ã‚¬ã‚¤ãƒ‰", splash_ui_desc: "ãƒ”ãƒ³ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã€é•·æŠ¼ã—ã§è¿½åŠ ã€å³ä¸‹ã®ãƒœã‚¿ãƒ³ã§æ“ä½œã—ã¾ã™ã€‚", start_explore: "æ¢ç´¢ã‚’å§‹ã‚ã‚‹",
        settings_title: "è¨­å®š", cancel: "ã‚­ãƒ£ãƒ³ã‚»ãƒ«", save: "ä¿å­˜",
        search_placeholder: "ğŸ” æ¤œç´¢ã€ã¾ãŸã¯é•·æŠ¼ã—ã§è¿½åŠ ...", addr_locating: "ä½ç½®å–å¾—ä¸­...", gps_locating: "GPS: å–å¾—ä¸­...", no_favs: "ãŠæ°—ã«å…¥ã‚ŠãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>ãƒãƒ¼ãƒˆã‚’æŠ¼ã—ã¦è¿½åŠ ï¼",
        label_food: "åœ°å…ƒã‚°ãƒ«ãƒ¡", label_highlight: "è¦‹ã©ã“ã‚", label_history: "æ­´å²", label_transport: "ã‚¢ã‚¯ã‚»ã‚¹",
        btn_nav: " ãƒŠãƒ“", btn_edit: " ç·¨é›†", btn_del: " å‰Šé™¤", btn_trip: " ãƒ«ãƒ¼ãƒˆè¨ˆç”»",
        edit_modal_title: "ãƒãƒ¼ã‚«ãƒ¼ç·¨é›†", edit_photo: "å†™çœŸã‚’é¸æŠ"
    }
};

let currentLang = localStorage.getItem('ruifang_lang') || 'zh';

function applyLanguage(lang) {
    currentLang = lang;
    localStorage.setItem('ruifang_lang', lang);
    const t = translations[lang]; if(!t) return;
    
    // Update simple texts
    document.getElementById('search').placeholder = t.search_placeholder;
    document.getElementById('addr-text').innerText = t.addr_locating;
    document.getElementById('gps-val-text').innerText = t.gps_locating;
    
    // Update Elements with data-i18n attribute
    document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (t[key]) {
            if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') { el.placeholder = t[key]; } 
            else { el.innerText = t[key]; }
        }
    });

    // Handle complex innerHTML updates manually to preserve icons
    document.getElementById('splash-purpose-title').innerHTML = `<i class="fas fa-bullseye"></i> ${t.splash_purpose_title}`;
    document.getElementById('splash-features-title').innerHTML = `<i class="fas fa-star"></i> ${t.splash_features_title}`;
    document.getElementById('splash-ui-title').innerHTML = `<i class="fas fa-mobile-alt"></i> ${t.splash_ui_title}`;
    document.getElementById('settings-title').innerHTML = `<i class="fas fa-cog"></i> ${t.settings_title}`;
    
    // Re-render fav list if empty
    if(myFavs.length === 0 && document.getElementById('fav-list-panel').style.display === 'block'){
        document.getElementById('fav-list-panel').innerHTML = `<div style="padding:15px; text-align:center; color:#888; font-size:13px;">${t.no_favs}</div>`;
    }
    
    // Re-render open card buttons if open
    if (document.getElementById('card').classList.contains('open') && targetSpot) {
        renderCardButtons(targetSpot, t);
    }
}

function previewLanguage(lang) { applyLanguage(lang); }
function openSettings() { document.getElementById('settings-lang').value = currentLang; document.getElementById('settings-modal-overlay').style.display = 'flex'; }
function closeSettings() { document.getElementById('settings-modal-overlay').style.display = 'none'; }
function saveSettings() { applyLanguage(document.getElementById('settings-lang').value); closeSettings(); }
function closeSplash() { localStorage.setItem('ruifang_welcomed', 'true'); document.getElementById('splash-screen').style.display = 'none'; }

// =========================================
// 1. å³æ™‚å¤©æ°£ API
// =========================================
async function fetchWeather() {
    try {
        const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=25.108&longitude=121.805&current_weather=true&timezone=Asia%2FTaipei');
        const data = await res.json();
        const temp = Math.round(data.current_weather.temperature);
        const code = data.current_weather.weathercode;
        let iconClass = 'fa-cloud-sun'; let iconColor = '#f39c12'; 
        if(code === 0) { iconClass = 'fa-sun'; iconColor = '#f1c40f'; } else if(code <= 3) { iconClass = 'fa-cloud-sun'; iconColor = '#f39c12'; } else if(code <= 67 || (code >= 80 && code <= 82)) { iconClass = 'fa-cloud-rain'; iconColor = '#3498db'; } 
        document.getElementById('weather-temp').innerText = `${temp}Â°C`;
        const iconEl = document.querySelector('#weather-box i'); iconEl.className = `fas ${iconClass}`; iconEl.style.color = iconColor;
    } catch (e) { document.getElementById('weather-temp').innerText = "--"; }
}

// =========================================
// 2. æ™¯é»è³‡æ–™åº«èˆ‡éš±è—é—œéµå­—
// =========================================
const spots = [
    { name: "ç‘èŠ³", lat: 25.108, lng: 121.805, tags: ["äº¤é€šæ¨ç´", "ç¾é£Ÿ"], keywords: ["ç«è»Šç«™", "é¾é³³è…¿", "èƒ¡æ¤’é¤…", "ç‰›è‚‰éºµ", "å¸‚å€"], highlights: "ç‘èŠ³ç¾é£Ÿå»£å ´", food: "é¾é³³è…¿ã€èƒ¡æ¤’é¤…", history: "é€²å…¥ä¹ä»½èˆ‡å¹³æºªç·šé–€æˆ¶ã€‚", transport: "å°éµç‘èŠ³ç«™" },
    { name: "å››è…³äº­", lat: 25.103, lng: 121.762, tags: ["å¤è¹Ÿ", "å¤é“"], keywords: ["ç ²å°", "æ’éª¨éºµ", "æ­¥é“"], highlights: "å››è…³äº­ç ²å°", food: "æ’éª¨éºµ", history: "é€šå¾€å®œè˜­çš„é‡è¦å¤é“æ“šé»ã€‚", transport: "å°éµå››è…³äº­ç«™" },
    { name: "çŒ´ç¡", lat: 25.086, lng: 121.828, tags: ["è²“æ‘", "æ­·å²"], keywords: ["è²“", "ç…¤ç¤¦", "ç‘ä¸‰", "æ‰“å¡", "å¯æ„›"], highlights: "çŒ´ç¡è²“æ‘ã€ç‘ä¸‰æ•´ç…¤å» ", food: "ç¤¦å·¥éºµ", history: "æ›¾ç‚ºå…¨å°ç…¤ç¤¦ç”¢é‡ç¬¬ä¸€ã€‚", transport: "å°éµçŒ´ç¡ç«™" },
    { name: "ä¹ä»½è€è¡—", lat: 25.1099, lng: 121.8452, tags: ["ç†±é–€", "æ­·å²"], keywords: ["å¤œæ™¯", "é˜¿å¦¹èŒ¶æ¨“", "èŠ‹åœ“", "è‰ä»”ç²¿", "å±±åŸ", "æ‚²æƒ…åŸå¸‚"], highlights: "é˜¿å¦¹èŒ¶æ¨“", food: "é˜¿æŸ‘å§¨èŠ‹åœ“", history: "é»ƒé‡‘å±±åŸï¼Œå»ºç¯‰ä¾å±±è€Œå»ºã€‚", transport: "å®¢é‹ 788 / 965" },
    { name: "æ·±æ¾³", lat: 25.133, lng: 121.824, tags: ["è‡ªç„¶", "æµ·æ™¯éµé“"], keywords: ["è±¡é¼»å²©", "è‡ªè¡Œè»Š", "å°å·ç±³ç²‰", "æµ·é®®"], highlights: "æ·±æ¾³éµé“è‡ªè¡Œè»Š", food: "å°å·ç±³ç²‰", history: "ç¾ä»¥æµ·è•å¥‡å²©èåã€‚", transport: "å…¬è»ŠT99ã€791" },
    { name: "é¼»é ­è§’", lat: 25.12588, lng: 121.92028, tags: ["è‡ªç„¶", "ç§˜å¢ƒ"], keywords: ["ç‡ˆå¡”", "æµ·ç”¢", "çœ‹æµ·", "æ­¥é“"], highlights: "é¼»é ­è§’æ­¥é“", food: "æµ·ç”¢", history: "ç‘èŠ³æ±åŒ—è§’çš„çµ•ç¾å²¬è§’ã€‚", transport: "å®¢é‹ 856 / 886" },
    { name: "é‡‘ç“œçŸ³", lat: 25.10911, lng: 121.85768, tags: ["æ­·å²", "ç¤¦æ¥­"], keywords: ["é»ƒé‡‘åšç‰©é¤¨", "ç¥ç¤¾", "ç¤¦å·¥ä¾¿ç•¶", "æ·˜é‡‘"], highlights: "é»ƒé‡‘åšç‰©é¤¨", food: "ç¤¦å·¥ä¾¿ç•¶", history: "æ˜”æ—¥äºæ´²ç¬¬ä¸€é‡‘ç¤¦å±±ã€‚", transport: "å®¢é‹ 788 / 856" },
    { name: "ç„¡è€³èŒ¶å£ºå±±", lat: 25.10637, lng: 121.86596, tags: ["ç™»å±±", "è‡ªç„¶"], keywords: ["æµ·æ™¯", "èŠ’è‰", "çˆ¬å±±", "èŒ¶å£º"], highlights: "çµ•ç¾æµ·æ™¯", food: "ç„¡", history: "å› å±±å½¢ç‹€ä¼¼ç„¡è€³èŒ¶å£ºå¾—åã€‚", transport: "é‡‘ç“œçŸ³æ­¥è¡Œç™»å±±" },
    { name: "æ°´æ¹³æ´", lat: 25.12248, lng: 121.86033, tags: ["æ­·å²", "æµ·æ™¯"], keywords: ["é™°é™½æµ·", "æ¼æ¸¯"], highlights: "é™°é™½æµ·", food: "å°åƒ", history: "æ¡ç¤¦å·¥æ¥­èˆ‡è‡ªç„¶äº¤ç•Œã€‚", transport: "å®¢é‹ 856 / 886" },
    { name: "åä¸‰å±¤éºå€", lat: 25.11826, lng: 121.86465, tags: ["å¤è¹Ÿ"], keywords: ["å¤©ç©ºä¹‹åŸ", "é»ç‡ˆ", "æ°´æ¹³æ´", "ç…‰éŠ…"], highlights: "å°ç‰ˆå¤©ç©ºä¹‹åŸ", food: "ç„¡", history: "æ˜”æ—¥å¤§å‹é¸ç…‰å» éºå€ã€‚", transport: "é•·ä»ç¤¾å€é™„è¿‘" },
    { name: "ä¸å­äº­", lat: 25.0895, lng: 121.8473, tags: ["ç§˜å¢ƒ", "æ‰“å¡"], keywords: ["å¯‚å¯å…¬è·¯", "102ç¸£é“", "èŠ’è‰", "å¤•é™½"], highlights: "å¯‚å¯å…¬è·¯", food: "ç„¡", history: "åå­—å–è‡ªæç™½è©©å¥ã€‚", transport: "è‡ªè¡Œé–‹è»Š" },
    { name: "å—å­åæ­¥é“", lat: 25.1206, lng: 121.8863, tags: ["ç™»å±±", "è‡ªç„¶"], keywords: ["æµ·æ™¯", "ç„¡æ•µæµ·æ™¯", "é«˜CPå€¼"], highlights: "360åº¦ç„¡æ•µå±±æµ·æ™¯", food: "å—é›…éºµåº—", history: "é«˜CPå€¼æ­¥é“ã€‚", transport: "å…¬è»Š 856" }
];

const themeRouteCoords = [[25.108, 121.805], [25.086, 121.828], [25.0606, 121.8226], [25.1091, 121.8576]];
let userPos = null, currentRoute = null, targetSpot = null;
let myFavs = JSON.parse(localStorage.getItem('ruifang_favs')) || []; 
let savedCustomSpots = JSON.parse(localStorage.getItem('ruifang_custom_spots')) || []; 
let searchHistory = JSON.parse(localStorage.getItem('ruifang_search_history')) || []; 

// =========================================
// 3. åœ°åœ–åˆå§‹åŒ–
// =========================================
const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([25.1032, 121.8224], 14);
const mapLayers = [
    { url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', name: 'è¡—é“', icon: 'fa-map', dark: false },
    { url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', name: 'ç­‰é«˜ç·š', icon: 'fa-mountain', dark: false },
    { url: 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', name: 'å¤œé–“', icon: 'fa-moon', dark: true }
];
let currentLayerIdx = 0, currentTileLayer = L.tileLayer(mapLayers[0].url).addTo(map);
L.control.scale({ metric: true, imperial: false, position: 'bottomright' }).addTo(map);

function toggleLayer() {
    currentLayerIdx = (currentLayerIdx + 1) % mapLayers.length; 
    const c = mapLayers[currentLayerIdx];
    map.removeLayer(currentTileLayer); currentTileLayer = L.tileLayer(c.url).addTo(map);
    document.querySelector('#layer-btn i').className = `fas ${c.icon}`;
    if (c.dark) document.body.classList.add("dark-mode"); else document.body.classList.remove("dark-mode");
}

map.on('click', () => { closeCard(); document.getElementById("suggest").style.display = "none"; });

const userPulseIcon = L.divIcon({ className: 'user-pulse-icon', html: '<div class="pulse"></div><div class="dot"></div>', iconSize: [40, 40], iconAnchor: [20, 20] });
map.locate({setView: false, watch: true}); 
map.on('locationfound', e => {
    userPos = e.latlng; document.getElementById("gps-val-text").innerText = `GPS: ${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)}`;
    if(!window.userMarker) window.userMarker = L.marker(userPos, { icon: userPulseIcon }).addTo(map); else window.userMarker.setLatLng(userPos);
});

map.on('moveend', function() {
    const center = map.getCenter();
    fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${center.lat}&lon=${center.lng}&zoom=18&addressdetails=1&accept-language=zh-TW`)
    .then(res => res.json()).then(data => {
        if (data && data.address) {
            const a = data.address;
            document.getElementById("addr-text").innerText = ((a.city||a.town||a.county||"") + (a.suburb||a.district||"") + (a.village||a.neighbourhood||a.road||"")) || "æ¢ç´¢ç‘èŠ³ä¸­...";
        }
    }).catch(()=>{}); 
});
map.fire('moveend'); 

// =========================================
// 4. åœ–é‡˜èˆ‡æ¨™è¨˜ç”Ÿæˆ
// =========================================
const cluster = L.markerClusterGroup(); map.addLayer(cluster);

function calculateWalk(lat, lng) {
    if(!userPos) return "--";
    const mins = Math.round(map.distance(userPos, [lat, lng]) / 80); 
    return mins < 1 ? "1åˆ†å…§" : `ç´„ ${mins} åˆ†`;
}

const createCustomPin = (tags) => {
    let cls = 'fa-map-marker-alt', col = '#ea4335'; 
    if (tags.includes('ç¾é£Ÿ')) { cls = 'fa-utensils'; col = '#f39c12'; } else if (tags.includes('è²“æ‘')) { cls = 'fa-cat'; col = '#9b59b6'; } else if (tags.includes('è‡ªç„¶') || tags.includes('ç§˜å¢ƒ')) { cls = 'fa-leaf'; col = '#2ecc71'; } else if (tags.includes('æ­·å²')) { cls = 'fa-landmark'; col = '#7f8c8d'; } else if (tags.includes('è‡ªè¨‚')) { cls = 'fa-star'; col = '#f1c40f'; } 
    return L.divIcon({ className: 'custom-pin-wrap', html: `<div class="gmap-pin" style="background-color:${col}"><i class="fas ${cls}"></i></div>`, iconSize: [32,32], iconAnchor: [16,38], popupAnchor: [0,-38] });
};

function addMarkerToMap(s) {
    if (!s.tags.includes('è‡ªè¨‚') && !s.wikiImg) fetch(`https://zh.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(s.name)}`).then(r=>r.json()).then(d=>{s.wikiImg=d.thumbnail?.source;}).catch(()=>{});
    const m = L.marker([s.lat, s.lng], { icon: createCustomPin(s.tags) });
    m.bindPopup(() => {
        const img = s.wikiImg || 'https://via.placeholder.com/260x130/f1c40f/ffffff?text=Custom+Spot';
        const foodIcon = s.tags.includes('è‡ªè¨‚') ? 'fa-star' : 'fa-utensils';
        const foodText = s.tags.includes('è‡ªè¨‚') ? 'è‡ªè¨‚åœ°é»' : `ç¾é£Ÿï¼š${s.food}`;
        return `<div class="preview-card" onclick="openCardByName('${s.name}')"><img class="preview-img" src="${img}"><div class="preview-info"><div class="preview-header"><span class="preview-title">${s.name}</span><span class="walk-badge"><i class="fas fa-walking"></i> ${calculateWalk(s.lat, s.lng)}</span></div><div class="preview-tag-box">${s.tags.map(t=>`<span class="mini-tag">${t}</span>`).join('')}</div><div class="food-preview"><i class="fas ${foodIcon}"></i> ${foodText}</div></div></div>`;
    }, { closeButton: false });
    m.on('mouseover', function() { this.openPopup(); }); m.on('click', (e) => { L.DomEvent.stopPropagation(e); showCard(s); });
    s.markerObj = m; cluster.addLayer(m);
}
spots.forEach(addMarkerToMap);
savedCustomSpots.forEach(s => { spots.push(s); addMarkerToMap(s); });

// =========================================
// 5. æ–°å¢èˆ‡ç·¨è¼¯è‡ªè¨‚æ¨™è¨˜
// =========================================
let currentEditingSpotName = ""; 

map.on('contextmenu', function(e) {
    const spotName = prompt("ğŸ“ æ–°å¢è‡ªè¨‚æ¨™è¨˜\nè«‹ç‚ºåœ°é»å‘½åï¼š", "æˆ‘çš„æ™¯é»");
    if (!spotName) return; 
    const newSpot = { name: spotName, lat: e.latlng.lat, lng: e.latlng.lng, tags: ["è‡ªè¨‚"], highlights: "é»æ“Šä¸‹æ–¹ç·¨è¼¯...", food: "--", history: "è‡ªè¨‚æ¨™è¨˜", transport: "è‡ªè¡Œå‰å¾€", wikiImg: "" };
    spots.push(newSpot); addMarkerToMap(newSpot);
    savedCustomSpots.push(newSpot); localStorage.setItem('ruifang_custom_spots', JSON.stringify(savedCustomSpots));
    showCard(newSpot);
});

function openEditModal(name) {
    currentEditingSpotName = name; const s = spots.find(x => x.name === name);
    document.getElementById('edit-name').value = s.name; document.getElementById('edit-highlights').value = s.highlights; document.getElementById('edit-history').value = s.history;
    document.getElementById('edit-image-preview').style.display = s.wikiImg ? "block" : "none"; document.getElementById('edit-image-preview').src = s.wikiImg || "";
    document.getElementById('edit-modal-overlay').style.display = "flex";
}
function closeEditModal() { document.getElementById('edit-modal-overlay').style.display = "none"; }

document.getElementById('edit-image').addEventListener('change', function(e) {
    const file = e.target.files[0]; if(!file) return; const reader = new FileReader();
    reader.onload = event => {
        const img = new Image();
        img.onload = () => {
            const canvas = document.createElement('canvas'); const scaleSize = 400 / img.width; canvas.width = 400; canvas.height = img.height * scaleSize;
            const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            document.getElementById('edit-image-preview').src = canvas.toDataURL('image/jpeg', 0.7); document.getElementById('edit-image-preview').style.display = "block";
        }; img.src = event.target.result;
    }; reader.readAsDataURL(file);
});

function saveEditSpot() {
    const newName = document.getElementById('edit-name').value.trim(); if(!newName) return alert("åç¨±ä¸èƒ½ç‚ºç©ºï¼");
    const s = spots.find(x => x.name === currentEditingSpotName); const savedIdx = savedCustomSpots.findIndex(x => x.name === currentEditingSpotName);
    s.name = newName; s.highlights = document.getElementById('edit-highlights').value; s.history = document.getElementById('edit-history').value; s.wikiImg = document.getElementById('edit-image-preview').src;
    if(savedIdx > -1) { savedCustomSpots[savedIdx] = s; localStorage.setItem('ruifang_custom_spots', JSON.stringify(savedCustomSpots)); }
    closeEditModal(); showCard(s); 
}

function deleteCustomSpot(name) {
    if(!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${name}ã€ï¼Ÿç„¡æ³•å¾©åŸå–”ï¼`)) return;
    savedCustomSpots = savedCustomSpots.filter(s => s.name !== name); localStorage.setItem('ruifang_custom_spots', JSON.stringify(savedCustomSpots));
    const spotIndex = spots.findIndex(s => s.name === name);
    if (spotIndex > -1) { cluster.removeLayer(spots[spotIndex].markerObj); spots.splice(spotIndex, 1); }
    if (myFavs.includes(name)) { myFavs = myFavs.filter(fav => fav !== name); localStorage.setItem('ruifang_favs', JSON.stringify(myFavs)); renderFavList(); }
    closeCard(); alert('ğŸ—‘ï¸ æ¨™è¨˜å·²åˆªé™¤ï¼');
}

// =========================================
// 6. UI é¢æ¿èˆ‡å°èˆªæ™‚é–“é¡¯ç¤º
// =========================================
function renderCardButtons(s, t) {
    const btnGroup = document.getElementById("card-btn-group");
    if (s.tags.includes('è‡ªè¨‚')) {
        btnGroup.innerHTML = `<button onclick="startNav()" style="flex: 1.2;"><i class="fas fa-location-arrow"></i> ${t.btn_nav}</button><button class="edit-btn" onclick="openEditModal('${s.name}')"><i class="fas fa-edit"></i> ${t.btn_edit}</button><button class="danger" onclick="deleteCustomSpot('${s.name}')"><i class="fas fa-trash-alt"></i> ${t.btn_del}</button>`;
    } else {
        btnGroup.innerHTML = `<button onclick="startNav()"><i class="fas fa-location-arrow"></i> ${t.btn_nav}</button><button class="secondary" onclick="aiTrip()"><i class="fas fa-magic"></i> ${t.btn_trip}</button>`;
    }
}

function showCard(s) {
    targetSpot = s; updateHeartUI(s.name);
    document.getElementById("title").innerText = s.name;
    document.getElementById("img").src = s.wikiImg || 'https://via.placeholder.com/400x200/f1c40f/ffffff?text=Custom+Spot';
    document.getElementById("card-tags").innerHTML = s.tags.map(t => `<span class="mini-tag">${t}</span>`).join('');
    document.getElementById("card-food").innerText = s.food || "--";
    document.getElementById("card-highlights").innerText = s.highlights || "æš«ç„¡ä»‹ç´¹";
    document.getElementById("card-history").innerText = s.history || "ç„¡";
    document.getElementById("card-transport").innerText = s.transport || "è‡ªè¡Œå‰å¾€";
    
    renderCardButtons(s, translations[currentLang]);
    
    document.getElementById("card").classList.add("open"); document.getElementById("card").style.transform = '';
}

function openCardByName(name) { const s = spots.find(x => x.name === name); if(s) showCard(s); }
function closeCard() { document.getElementById("card").classList.remove("open"); document.getElementById("card").style.transform = ''; }
function closeNav() { if(currentRoute) map.removeLayer(currentRoute); document.getElementById('route-info-panel').style.display = 'none'; }

function startNav() {
    if(!userPos || !targetSpot) return alert("è«‹é–‹å•Ÿ GPS å®šä½");
    closeCard(); document.getElementById('route-time').innerText = "è¨ˆç®—ä¸­..."; document.getElementById('route-dist').innerText = ""; document.getElementById('route-info-panel').style.display = 'flex';
    fetch(`https://router.project-osrm.org/route/v1/driving/${userPos.lng},${userPos.lat};${targetSpot.lng},${targetSpot.lat}?overview=full&geometries=geojson`)
    .then(r => r.json()).then(data => {
        if(currentRoute) map.removeLayer(currentRoute);
        const route = data.routes[0]; const coords = route.geometry.coordinates.map(c => [c[1], c[0]]);
        currentRoute = L.polyline(coords, {color: '#007bff', weight: 8}).addTo(map); map.fitBounds(currentRoute.getBounds(), {padding: [80, 80]}); 
        document.getElementById('route-time').innerText = `${Math.round(route.duration / 60)} åˆ†é˜`; document.getElementById('route-dist').innerText = `${(route.distance / 1000).toFixed(1)} km`;
    }).catch(() => { document.getElementById('route-time').innerText = "è¦åŠƒå¤±æ•—"; });
}

// =========================================
// 7. æ™ºæ…§æœå°‹ç³»çµ±
// =========================================
const searchInput = document.getElementById("search"); const sugBox = document.getElementById("suggest");
searchInput.addEventListener('focus', () => { if(!searchInput.value.trim()) renderDefaultSearch(); });

function saveSearchHistory(name) {
    searchHistory = searchHistory.filter(h => h !== name); searchHistory.unshift(name); 
    if(searchHistory.length > 5) searchHistory.pop(); localStorage.setItem('ruifang_search_history', JSON.stringify(searchHistory));
}

function renderDefaultSearch() {
    sugBox.innerHTML = "";
    if(searchHistory.length > 0) {
        sugBox.innerHTML += `<div class="search-section-title">ğŸ•’ æ­·å²æœå°‹</div>`;
        searchHistory.forEach(h => { sugBox.innerHTML += `<div class="list-item" onclick="triggerSearch('${h}')"><span><i class="fas fa-history" style="color:#aaa;"></i> ${h}</span></div>`; });
    }
    sugBox.innerHTML += `<div class="search-section-title">â­ æ¨è–¦æ™¯é»</div>`;
    ["ä¹ä»½è€è¡—", "çŒ´ç¡", "ç„¡è€³èŒ¶å£ºå±±"].forEach(r => { sugBox.innerHTML += `<div class="list-item" onclick="triggerSearch('${r}')"><span><i class="fas fa-fire" style="color:#e74c3c;"></i> ${r}</span></div>`; });
    sugBox.innerHTML += `<div class="search-section-title">ğŸ– åœ¨åœ°å¿…åƒ</div>`;
    sugBox.innerHTML += `<div class="list-item" onclick="triggerSearch('ç‘èŠ³')"><span><i class="fas fa-utensils" style="color:#e67e22;"></i> ç‘èŠ³ç¾é£Ÿå»£å ´</span></div>`;
    sugBox.style.display = "block";
}

function triggerSearch(name) {
    searchInput.value = name; sugBox.style.display = "none";
    const s = spots.find(x => x.name === name);
    if(s) { map.flyTo([s.lat, s.lng], 16); setTimeout(() => showCard(s), 800); }
}

searchInput.oninput = function() {
    const k = this.value.trim(); if(!k) { renderDefaultSearch(); return; }
    sugBox.innerHTML = ""; 
    const matches = spots.filter(s => { return s.name.includes(k) || s.tags.some(t => t.includes(k)) || (s.keywords && s.keywords.some(kw => kw.includes(k))); });
    if(matches.length > 0) {
        sugBox.style.display = "block";
        matches.forEach(s => {
            const div = document.createElement("div"); div.className = "list-item"; div.innerHTML = `<span><i class="fas fa-map-marker-alt" style="color:var(--primary)"></i> ${s.name}</span>`;
            div.onclick = () => { saveSearchHistory(s.name); triggerSearch(s.name); }; sugBox.appendChild(div);
        });
    } else { sugBox.style.display = "none"; }
};

// =========================================
// 8. æ”¶è—èˆ‡åˆ†äº«
// =========================================
function toggleCurrentFav() {
    if(!targetSpot) return; const idx = myFavs.indexOf(targetSpot.name);
    if(idx === -1) myFavs.push(targetSpot.name); else myFavs.splice(idx, 1);
    localStorage.setItem('ruifang_favs', JSON.stringify(myFavs)); updateHeartUI(targetSpot.name);
}
function updateHeartUI(name) { const icon = document.getElementById("card-fav-icon"); if(myFavs.includes(name)) icon.classList.add("active"); else icon.classList.remove("active"); }
function toggleFavList() {
    const p = document.getElementById("fav-list-panel");
    if(p.style.display === "block") { p.style.display = "none"; } else {
        p.innerHTML = ""; const t = translations[currentLang];
        if(myFavs.length === 0) { p.innerHTML = `<div style="padding:15px; text-align:center; color:#888; font-size:13px;">${t.no_favs}</div>`; }
        else { myFavs.forEach(name => { const div = document.createElement("div"); div.className = "list-item"; div.innerHTML = `<span><i class="fas fa-heart" style="color:var(--danger); margin-right:5px;"></i> ${name}</span>`; div.onclick = () => triggerSearch(name); p.appendChild(div); }); }
        p.style.display = "block";
    }
}
function shareSpot() {
    if(!targetSpot) return; const spotUrl = new URL(window.location.href); spotUrl.searchParams.set('spot', targetSpot.name);
    const shareData = { title: `ç‘èŠ³å°è¦½åœ°åœ– - ${targetSpot.name}`, text: `æˆ‘åœ¨ç‘èŠ³åœ°åœ–ä¸Šç™¼ç¾äº†ã€Œ${targetSpot.name}ã€ï¼\nğŸ‘‰ äº®é»ï¼š${targetSpot.highlights}\nè¶•å¿«é»æ“Šé€£çµæŸ¥çœ‹ï¼š`, url: spotUrl.toString() };
    if (navigator.share) navigator.share(shareData).catch(()=>{}); else navigator.clipboard.writeText(`${shareData.text}\n${shareData.url}`).then(() => alert('âœ… å·²è¤‡è£½æ™¯é»è³‡è¨Šèˆ‡é€£çµï¼'));
}

function resetNorth() { map.flyTo([25.1032, 121.8224], 14); } 
function goToUser() { if(userPos) map.flyTo(userPos, 16); } 
function drawThemeRoute() { if(currentRoute) map.removeLayer(currentRoute); currentRoute = L.polyline(themeRouteCoords, { color: '#8e44ad', weight: 6, dashArray: '10, 10' }).addTo(map); map.fitBounds(currentRoute.getBounds(), { padding: [50, 50] }); closeCard(); alert("ğŸš€ æ¨è–¦è·¯ç·šå·²è¼‰å…¥ï¼"); }
function goToStation() { const ruiIcon = document.querySelector('.rui-icon'); if(ruiIcon){ ruiIcon.classList.remove('stamped'); void ruiIcon.offsetWidth; ruiIcon.classList.add('stamped'); } map.flyTo([25.108, 121.805], 16); closeCard(); } 
function aiTrip() { if(!userPos) return alert("ç­‰å¾… GPS å®šä½..."); const sorted = [...spots].sort((a,b) => map.distance(userPos,[a.lat,a.lng]) - map.distance(userPos,[b.lat,b.lng])); alert("ğŸ¤– AI æ¨è–¦ï¼š\n" + sorted.slice(0,5).map((s,i) => `${i+1}. ${s.name}`).join("\n")); }

const cardEl = document.getElementById("card"); let touchStartY = 0, isSwiping = false; 
cardEl.addEventListener('touchstart', (e) => { if(cardEl.scrollTop===0){ touchStartY=e.touches[0].clientY; isSwiping=true; cardEl.style.transition='none'; }},{passive:true});
cardEl.addEventListener('touchmove', (e) => { if(isSwiping && e.touches[0].clientY > touchStartY){ cardEl.style.transform=`translateY(${e.touches[0].clientY - touchStartY}px)`; }});
cardEl.addEventListener('touchend', (e) => { if(isSwiping){ isSwiping=false; cardEl.style.transition='transform 0.4s'; if((e.changedTouches[0]?.clientY || 0) - touchStartY > 100) closeCard(); else cardEl.style.transform=''; }});

// =========================================
// 9. åˆå§‹åŒ–è¨­å®š (App Boot)
// =========================================
window.onload = () => {
    // æª¢æŸ¥æ˜¯å¦æœ‰æ·±åº¦é€£çµ (åˆ†äº«é€£çµ)
    const params = new URLSearchParams(window.location.search);
    const spotQuery = params.get('spot');
    if(spotQuery) {
        const s = spots.find(x => x.name === spotQuery);
        if(s) { setTimeout(() => { map.flyTo([s.lat, s.lng], 16); showCard(s); }, 1000); }
    }

    // å•Ÿå‹•å¤šåœ‹èªè¨€
    applyLanguage(currentLang);
    document.getElementById('splash-lang').value = currentLang;
    document.getElementById('settings-lang').value = currentLang;
    fetchWeather();

    // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡ç™»å…¥ï¼Œé¡¯ç¤ºæ­¡è¿é é¢
    if(!localStorage.getItem('ruifang_welcomed')) {
        document.getElementById('splash-screen').style.display = 'flex';
    }
};
</script>
</body>
</html>
