<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <title>ç‘èŠ³å°è¦½åœ°åœ– App</title>

    <meta property="og:title" content="ç‘èŠ³å°è¦½åœ°åœ–" />
    <meta property="og:description" content="æ¢ç´¢ç‘èŠ³ç§˜å¢ƒã€åœ¨åœ°ç¾é£Ÿèˆ‡æ™‚ç©ºæ—…äººè·¯ç·šçš„å°ˆå±¬æ™ºæ…§åœ°åœ–ï¼" />
    <meta property="og:type" content="website" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#f39c12">
    <link rel="apple-touch-icon" href="./icon-192.png">

    <link rel="stylesheet" href="./style.css">
</head>
<body id="main-body">

    <div id="splash-screen">
        <div class="logo-anim">ç‘</div>
        <h2 class="title-text" style="letter-spacing: 2px;">ç‘èŠ³å°è¦½</h2>
    </div>

    <div id="welcome-screen">
        <div class="content-wrapper">
            <div class="logo-static">ç‘</div>
            <h1 class="title-text" data-i18n="splash_title">ç‘èŠ³å°è¦½ App</h1>
            <p style="text-align: center; color: var(--text-sub); line-height: 1.6; max-width: 300px;" data-i18n="splash_desc">
                è‡´åŠ›æ–¼æä¾›ç‘èŠ³åœ°å€æœ€ç²¾æº–çš„åœ¨åœ°å°è¦½ï¼Œå¸¶é ˜æ‚¨æ·±åº¦æ¢ç´¢å±±åŸä¹‹ç¾ã€‚
            </p>
            
            <div style="margin-top: 20px; width: 100%; max-width: 300px;">
                <label style="font-weight: bold; display: block; margin-bottom: 10px; color: var(--text-main);" data-i18n="lang">èªè¨€ / Language</label>
                <select id="lang-select-startup" onchange="applyLanguage(this.value)" class="modal-select">
                    <option value="zh">ç¹é«”ä¸­æ–‡ (ğŸ‡¹ğŸ‡¼)</option>
                    <option value="en">English (ğŸ‡ºğŸ‡¸)</option>
                    <option value="ja">æ—¥æœ¬èª (ğŸ‡¯ğŸ‡µ)</option>
                    <option value="ko">í•œêµ­ì–´ (ğŸ‡°ğŸ‡·)</option>
                    <option value="vi">Tiáº¿ng Viá»‡t (ğŸ‡»ğŸ‡³)</option>
                </select>
            </div>

            <div class="link-box" style="max-width: 300px;">
                <a href="mailto:ruifang689@gmail.com"><i class="fas fa-envelope"></i> ruifang689@gmail.com</a>
                <a href="https://docs.google.com/forms/d/e/1FAIpQLSfi76mygYPT0XeWDkTVjy1F3NjWTW1qveFKTV2bC5TlJ6yybA/viewform?usp=header" target="_blank"><i class="fas fa-clipboard-list"></i> <span data-i18n="form_link">å¡«å¯«æ„è¦‹å•å·</span></a>
            </div>

            <button class="btn-start" onclick="enterMap()" data-i18n="enter_map">é€²å…¥åœ°åœ–</button>
        </div>
    </div>

    <div id="tutorial-overlay">
        <div class="tutorial-box">
            <div id="tut-step-1">
                <h3 data-i18n="tut_step1_title"><i class="fas fa-search"></i> åŠŸèƒ½èªªæ˜ (1/2)</h3>
                <ul>
                    <li style="margin: 10px 0;">ğŸ” <b data-i18n="tut_search">æœå°‹èˆ‡æ¨™ç±¤</b>ï¼šä¸Šæ–¹å¯å¿«é€Ÿå°‹æ‰¾èˆ‡ç¯©é¸æ™¯é»ã€‚</li>
                    <li style="margin: 10px 0;">ğŸ“ <b data-i18n="tut_add">é•·æŒ‰æ–°å¢</b>ï¼šåœ°åœ–é•·æŒ‰å¯æ–°å¢ç§æˆ¿æ™¯é»ã€‚</li>
                    <li style="margin: 10px 0;">ğŸŒ¡ï¸ <b data-i18n="tut_weather">å¤©æ°£è³‡è¨Š</b>ï¼šå³ä¸Šæ–¹é¡¯ç¤ºå³æ™‚æ°£æº«ã€‚</li>
                </ul>
                <div class="tutorial-btns">
                    <button class="btn-fill" style="width: 100%;" onclick="nextTutorial()" data-i18n="tut_next">ä¸‹ä¸€æ­¥</button>
                </div>
            </div>
            <div id="tut-step-2" style="display:none;">
                <h3 data-i18n="tut_step2_title"><i class="fas fa-tools"></i> å¿«æ·åŠŸèƒ½ (2/2)</h3>
                <ul>
                    <li style="margin: 10px 0;">âš™ï¸ <b data-i18n="tut_settings">è¨­å®š</b>ï¼šå¯åˆ‡æ›ä¸»é¡Œè‰²èˆ‡åˆ†äº«åœ°åœ–ã€‚</li>
                    <li style="margin: 10px 0;">ğŸ§­ <b data-i18n="tut_compass">æŒ‡åŒ—é‡</b>ï¼šç¶ è‰²æŒ‰éˆ•ï¼ŒæŒ‡å¼•æ–¹å‘ã€‚</li>
                    <li style="margin: 10px 0;"><span style="color: var(--primary);">â—</span> <b data-i18n="tut_share">åˆ†äº«éµ</b>ï¼šå¿«é€Ÿåˆ†äº«æ™¯é»é€£çµçµ¦å¥½å‹ã€‚</li>
                </ul>
                <div class="tutorial-btns">
                    <button class="btn-outline" onclick="prevTutorial()" data-i18n="tut_prev">å‰ä¸€æ­¥</button>
                    <button class="btn-fill" onclick="finishTutorial()" data-i18n="tut_finish">é–‹å§‹ä½¿ç”¨</button>
                </div>
            </div>
        </div>
    </div>

    <div id="weather-box" title="å³æ™‚å¤©æ°£"><i class="fas fa-spinner fa-spin" style="color:#ccc"></i><span id="weather-temp">--</span></div>

    <div id="top-ui">
        <input id="search" placeholder="ğŸ” æœå°‹æ™¯é»æˆ–é•·æŒ‰åœ°åœ–æ¨™è¨˜..." data-i18n="search_ph">
        <div id="category-chips">
            <div class="chip active" onclick="filterSpots('all', this)" data-i18n="chip_all">ğŸŒŸ å…¨éƒ¨</div>
            <div class="chip" onclick="filterSpots('ç¾é£Ÿ', this)" data-i18n="chip_food">ğŸœ ç¾é£Ÿ</div>
            <div class="chip" onclick="filterSpots('æ­·å²', this)" data-i18n="chip_history">ğŸ›ï¸ æ­·å²</div>
            <div class="chip" onclick="filterSpots('è‡ªç„¶', this)" data-i18n="chip_nature">â›°ï¸ è‡ªç„¶æ™¯è§€</div>
            <div class="chip" onclick="filterSpots('è‡ªè¨‚', this)" data-i18n="chip_custom">ğŸ“ æˆ‘çš„æ¨™è¨˜</div>
        </div>
        <div id="map-center-panel"><i class="fas fa-map-marker-alt" style="color:var(--primary)"></i><span id="addr-text" data-i18n="locating">å®šä½ä¸­...</span></div>
        <div id="suggest"></div>
    </div>

    <div id="route-info-panel">
        <i class="fas fa-car" style="font-size:20px; color:var(--primary);"></i>
        <div class="route-data"><span id="route-time" class="route-time">-- åˆ†é˜</span><span id="route-dist" class="route-dist">-- km</span></div>
        <i class="fas fa-times-circle route-close" onclick="closeNav()"></i>
    </div>

    <div class="map-controls">
        <div class="control-btn" onclick="openSettings()" title="è¨­å®š"><i class="fas fa-cog"></i></div>
        <div class="control-btn compass-btn" onclick="resetNorth()" title="å›åˆ°å…¨æ™¯"><i class="fas fa-compass"></i></div>
        <div class="control-btn route-btn" onclick="drawThemeRoute()" title="æ™‚ç©ºæ—…äººè·¯ç·š"><i class="fas fa-route"></i></div>
        <div class="control-btn fav-btn" onclick="toggleFavList()" title="æˆ‘çš„æ”¶è—"><i class="fas fa-folder-open"></i></div>
        <div class="control-btn station-btn" onclick="goToStation()" title="å›åˆ°ç‘èŠ³ä¸­å¿ƒ"><span class="rui-icon">ç‘</span></div>
        <div class="control-btn" id="layer-btn" onclick="toggleLayer()" title="åˆ‡æ›åº•åœ–"><i class="fas fa-map"></i></div>
        <div class="control-btn active" onclick="goToUser()" title="æˆ‘çš„ä½ç½®"><i class="fas fa-location-crosshairs" style="color: var(--primary);"></i></div>
    </div>

    <div id="fav-list-panel"></div>
    <div id="gps-val-text" data-i18n="gps_locating">GPS: å®šä½ä¸­...</div>
    <div id="map"></div>

    <div id="card">
        <div class="close-bar" onclick="closeCard()"></div>
        <div class="card-header-row">
            <h2 id="title"></h2>
            <div class="card-header-icons">
                <i id="card-share-icon" class="fas fa-share-nodes" onclick="shareSpot()"></i>
                <i id="card-fav-icon" class="fas fa-heart" onclick="toggleCurrentFav()"></i>
            </div>
        </div>
        <div id="card-tags"></div>
        <img id="img">
        <div class="info-section"><span class="info-label"><i class="fas fa-utensils"></i> <span data-i18n="food">åœ¨åœ°é£²é£Ÿ</span></span><span id="card-food" class="info-text"></span></div>
        <div class="info-section"><span class="info-label"><i class="fas fa-star"></i> <span data-i18n="highlights">æ¨è–¦äº®é»</span></span><span id="card-highlights" class="info-text"></span></div>
        <div class="info-section"><span class="info-label"><i class="fas fa-history"></i> <span data-i18n="history">ç°¡ä»‹æ­·å²</span></span><span id="card-history" class="info-text"></span></div>
        <div class="info-section"><span class="info-label"><i class="fas fa-bus"></i> <span data-i18n="transport">äº¤é€šæ–¹å¼</span></span><span id="card-transport" class="info-text"></span></div>
        <div class="btn-group" id="card-btn-group"></div>
    </div>

    <div id="settings-modal-overlay" class="modal-overlay">
        <div class="modal-box">
            <h2 data-i18n="settings"><i class="fas fa-cog"></i> ç³»çµ±è¨­å®š</h2>
            
            <h3 data-i18n="lang"><i class="fas fa-globe"></i> èªè¨€ / Language</h3>
            <select id="lang-select-settings" onchange="applyLanguage(this.value)" class="modal-select">
                <option value="zh">ç¹é«”ä¸­æ–‡ (ğŸ‡¹ğŸ‡¼)</option>
                <option value="en">English (ğŸ‡ºğŸ‡¸)</option>
                <option value="ja">æ—¥æœ¬èª (ğŸ‡¯ğŸ‡µ)</option>
                <option value="ko">í•œêµ­ì–´ (ğŸ‡°ğŸ‡·)</option>
                <option value="vi">Tiáº¿ng Viá»‡t (ğŸ‡»ğŸ‡³)</option>
            </select>

            <h3 data-i18n="theme"><i class="fas fa-palette"></i> ä¸»é¡Œé¡è‰²</h3>
            <select id="theme-select" onchange="changeTheme(this.value)" class="modal-select">
                <option value="#f39c12">æ©˜è‰² (é è¨­)</option>
                <option value="#007bff">è—è‰²</option>
                <option value="#28a745">ç¶ è‰²</option>
                <option value="#8e44ad">ç´«è‰²</option>
                <option value="#e84393">ç²‰è‰²</option>
                <option value="#333333">é»‘ç™½</option>
                <option value="custom">è‡ªè¨‚é¡è‰²...</option>
            </select>
            <input type="color" id="custom-color-picker" style="display:none; width:100%; margin-top:5px; height: 40px; border:none; border-radius:10px;" onchange="applyCustomTheme(this.value)">

            <button class="modal-save" style="margin-top:10px; background:var(--primary);" onclick="shareAppMap()">
                <i class="fas fa-share-square"></i> <span data-i18n="share_map">åˆ†äº«å°è¦½åœ°åœ–</span>
            </button>
            <button id="install-btn" style="display: none; margin-top: 10px; background-color: var(--success);" class="modal-save" onclick="installPWA()">
                â¬‡ï¸ å°‡ App å®‰è£è‡³æ¡Œé¢
            </button>

            <div class="modal-btns">
                <button class="modal-cancel" onclick="closeSettings()" data-i18n="close">é—œé–‰</button>
            </div>
        </div>
    </div>

    <div id="edit-modal-overlay" class="modal-overlay">
        <div class="modal-box">
            <h3><i class="fas fa-edit"></i> ç·¨è¼¯è‡ªè¨‚æ¨™è¨˜</h3>
            <input type="text" id="edit-name" class="modal-input" placeholder="åç¨±å¿…å¡«">
            <input type="text" id="edit-highlights" class="modal-input" placeholder="æ¨è–¦äº®é»">
            <textarea id="edit-history" class="modal-textarea" placeholder="æ­·å²ç°¡ä»‹..."></textarea>
            <label class="modal-file-label"><i class="fas fa-camera"></i> <span>ä¸Šå‚³ç…§ç‰‡</span><input type="file" id="edit-image" accept="image/*" style="display:none;"></label>
            <img id="edit-image-preview">
            <div class="modal-btns">
                <button class="modal-cancel" onclick="closeEditModal()">å–æ¶ˆ</button>
                <button class="modal-save" onclick="saveEditSpot()">å„²å­˜</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

    <script>
        // =========================================
        // 0. PWA è¨»å†Šèˆ‡å®‰è£
        // =========================================
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').catch(err => console.log('SW æœªè¨»å†Š'));
            });
        }
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault(); deferredPrompt = e;
            const installBtn = document.getElementById('install-btn');
            if(installBtn) installBtn.style.display = 'block';
        });
        function installPWA() {
            if (!deferredPrompt) return;
            document.getElementById('install-btn').style.display = 'none';
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then((choiceResult) => { deferredPrompt = null; });
        }

        // =========================================
        // 1. ä¸‰éšæ®µé€²å…¥å‹•ç·šèˆ‡æ•™å­¸é‚è¼¯
        // =========================================
        function enterMap() {
            document.getElementById('welcome-screen').style.display = 'none';
            document.getElementById('tutorial-overlay').style.display = 'flex';
        }
        function nextTutorial() {
            document.getElementById('tut-step-1').style.display = 'none';
            document.getElementById('tut-step-2').style.display = 'block';
        }
        function prevTutorial() {
            document.getElementById('tut-step-2').style.display = 'none';
            document.getElementById('tut-step-1').style.display = 'block';
        }
        function finishTutorial() {
            document.getElementById('tutorial-overlay').style.display = 'none';
            localStorage.setItem('ruifang_welcomed', 'true');
        }

        // =========================================
        // 2. ä¸»é¡Œè‰²èˆ‡åˆ†äº«åŠŸèƒ½
        // =========================================
        function changeTheme(color) {
            if (color === 'custom') {
                document.getElementById('custom-color-picker').style.display = 'block';
                document.getElementById('custom-color-picker').click();
            } else {
                document.getElementById('custom-color-picker').style.display = 'none';
                applyCustomTheme(color);
            }
        }
        function applyCustomTheme(color) {
            document.documentElement.style.setProperty('--primary', color);
            document.documentElement.style.setProperty('--logo-border', color);
            localStorage.setItem('ruifang_theme', color);
        }
        // åˆ†äº«æ•´å€‹ App ç¶²å€
        function shareAppMap() {
            const shareData = { title: 'ç‘èŠ³å°è¦½åœ°åœ– App', text: 'å¿«ä¾†çœ‹çœ‹é€™å€‹ç‘èŠ³å°ˆå±¬çš„æ™ºæ…§å°è¦½åœ°åœ–ï¼', url: 'https://ruifang689-max.github.io/-/' };
            if (navigator.share) navigator.share(shareData).catch(()=>{}); 
            else { navigator.clipboard.writeText(shareData.url).then(() => alert('âœ… ç¶²å€å·²è¤‡è£½ï¼')); }
        }

        // =========================================
        // 3. å¤šåœ‹èªè¨€å­—å…¸ (å«éŸ“æ–‡ã€è¶Šå—æ–‡)
        // =========================================
        const translations = {
            'zh': {
                splash_title: "ç‘èŠ³å°è¦½ App", splash_desc: "è‡´åŠ›æ–¼æä¾›ç‘èŠ³åœ°å€æœ€ç²¾æº–çš„åœ¨åœ°å°è¦½ï¼Œå¸¶é ˜æ‚¨æ·±åº¦æ¢ç´¢å±±åŸä¹‹ç¾ã€‚", lang: "èªè¨€ / Language", enter_map: "é€²å…¥åœ°åœ–", form_link: "å¡«å¯«æ„è¦‹å•å·",
                tut_step1_title: "åŠŸèƒ½èªªæ˜ (1/2)", tut_search: "æœå°‹èˆ‡æ¨™ç±¤", tut_add: "é•·æŒ‰æ–°å¢", tut_weather: "å¤©æ°£è³‡è¨Š", tut_next: "ä¸‹ä¸€æ­¥",
                tut_step2_title: "å¿«æ·åŠŸèƒ½ (2/2)", tut_settings: "è¨­å®š", tut_compass: "æŒ‡åŒ—é‡", tut_share: "åˆ†äº«éµ", tut_prev: "å‰ä¸€æ­¥", tut_finish: "é–‹å§‹ä½¿ç”¨",
                settings: "ç³»çµ±è¨­å®š", theme: "ä¸»é¡Œé¡è‰²", share_map: "åˆ†äº«å°è¦½åœ°åœ–", close: "é—œé–‰", search_ph: "ğŸ” æœå°‹æ™¯é»æˆ–é•·æŒ‰æ–°å¢...", locating: "å®šä½ä¸­...", 
                food: "åœ¨åœ°é£²é£Ÿ", highlights: "æ¨è–¦äº®é»", history: "ç°¡ä»‹æ­·å²", transport: "äº¤é€šæ–¹å¼", nav: " å°èˆª", ai: " è¡Œç¨‹è¦åŠƒ",
                chip_all: "ğŸŒŸ å…¨éƒ¨", chip_food: "ğŸœ ç¾é£Ÿ", chip_history: "ğŸ›ï¸ æ­·å²", chip_nature: "â›°ï¸ è‡ªç„¶", chip_custom: "ğŸ“ æ¨™è¨˜"
            },
            'en': {
                splash_title: "Ruifang Guide", splash_desc: "The most accurate local guide in Ruifang.", lang: "Language", enter_map: "Enter Map", form_link: "Feedback Form",
                tut_step1_title: "Features (1/2)", tut_search: "Search & Tags", tut_add: "Long Press Add", tut_weather: "Weather", tut_next: "Next",
                tut_step2_title: "Shortcuts (2/2)", tut_settings: "Settings", tut_compass: "Compass", tut_share: "Share", tut_prev: "Back", tut_finish: "Start",
                settings: "Settings", theme: "Theme Color", share_map: "Share Map", close: "Close", search_ph: "ğŸ” Search or long press...", locating: "Locating...", 
                food: "Food", highlights: "Highlights", history: "History", transport: "Transport", nav: " Navigate", ai: " Plan Trip",
                chip_all: "ğŸŒŸ All", chip_food: "ğŸœ Food", chip_history: "ğŸ›ï¸ History", chip_nature: "â›°ï¸ Nature", chip_custom: "ğŸ“ Custom"
            },
            'ja': {
                splash_title: "ç‘èŠ³ã‚¬ã‚¤ãƒ‰", splash_desc: "ç‘èŠ³ã®æ­£ç¢ºãªãƒ­ãƒ¼ã‚«ãƒ«ã‚¬ã‚¤ãƒ‰ã€‚", lang: "è¨€èª", enter_map: "ãƒãƒƒãƒ—ã¸", form_link: "ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ",
                tut_step1_title: "æ©Ÿèƒ½ (1/2)", tut_search: "æ¤œç´¢ã¨ã‚¿ã‚°", tut_add: "é•·æŠ¼ã—ã§è¿½åŠ ", tut_weather: "å¤©æ°—", tut_next: "æ¬¡ã¸",
                tut_step2_title: "ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ (2/2)", tut_settings: "è¨­å®š", tut_compass: "ã‚³ãƒ³ãƒ‘ã‚¹", tut_share: "å…±æœ‰", tut_prev: "æˆ»ã‚‹", tut_finish: "å§‹ã‚ã‚‹",
                settings: "è¨­å®š", theme: "ãƒ†ãƒ¼ãƒè‰²", share_map: "ãƒãƒƒãƒ—ã‚’å…±æœ‰", close: "é–‰ã˜ã‚‹", search_ph: "ğŸ” æ¤œç´¢ã¾ãŸã¯é•·æŠ¼ã—...", locating: "å–å¾—ä¸­...", 
                food: "ã‚°ãƒ«ãƒ¡", highlights: "è¦‹ã©ã“ã‚", history: "æ­´å²", transport: "ã‚¢ã‚¯ã‚»ã‚¹", nav: " ãƒŠãƒ“", ai: " ãƒ«ãƒ¼ãƒˆ",
                chip_all: "ğŸŒŸ å…¨ã¦", chip_food: "ğŸœ é£Ÿäº‹", chip_history: "ğŸ›ï¸ æ­´å²", chip_nature: "â›°ï¸ è‡ªç„¶", chip_custom: "ğŸ“ ã‚«ã‚¹ã‚¿ãƒ "
            },
            'ko': {
                splash_title: "ë£¨ì´íŒ¡ ê°€ì´ë“œ", splash_desc: "ë£¨ì´íŒ¡ ì§€ì—­ì˜ ì •í™•í•œ ë¡œì»¬ ê°€ì´ë“œ.", lang: "ì–¸ì–´ / Language", enter_map: "ì§€ë„ ì…ì¥", form_link: "ì„¤ë¬¸ì¡°ì‚¬",
                tut_step1_title: "ê¸°ëŠ¥ (1/2)", tut_search: "ê²€ìƒ‰ ë° íƒœê·¸", tut_add: "ê¸¸ê²Œ ëˆŒëŸ¬ ì¶”ê°€", tut_weather: "ë‚ ì”¨", tut_next: "ë‹¤ìŒ",
                tut_step2_title: "ë‹¨ì¶•í‚¤ (2/2)", tut_settings: "ì„¤ì •", tut_compass: "ë‚˜ì¹¨ë°˜", tut_share: "ê³µìœ ", tut_prev: "ì´ì „", tut_finish: "ì‹œì‘í•˜ê¸°",
                settings: "ì„¤ì •", theme: "í…Œë§ˆ ìƒ‰ìƒ", share_map: "ì§€ë„ ê³µìœ ", close: "ë‹«ê¸°", search_ph: "ğŸ” ê²€ìƒ‰ ë˜ëŠ” ê¸¸ê²Œ ëˆ„ë¥´ê¸°...", locating: "ìœ„ì¹˜ í™•ì¸ ì¤‘...", 
                food: "ìŒì‹", highlights: "í•˜ì´ë¼ì´íŠ¸", history: "ì—­ì‚¬", transport: "êµí†µ", nav: " ë‚´ë¹„ê²Œì´ì…˜", ai: " ì¶”ì²œ",
                chip_all: "ğŸŒŸ ì „ì²´", chip_food: "ğŸœ ìŒì‹", chip_history: "ğŸ›ï¸ ì—­ì‚¬", chip_nature: "â›°ï¸ ìì—°", chip_custom: "ğŸ“ ë§ˆì»¤"
            },
            'vi': {
                splash_title: "Báº£n Ä‘á»“ Ruifang", splash_desc: "HÆ°á»›ng dáº«n du lá»‹ch Ä‘á»‹a phÆ°Æ¡ng chÃ­nh xÃ¡c nháº¥t.", lang: "NgÃ´n ngá»¯", enter_map: "VÃ o Báº£n Äá»“", form_link: "Báº£ng cÃ¢u há»i",
                tut_step1_title: "Chá»©c nÄƒng (1/2)", tut_search: "TÃ¬m kiáº¿m", tut_add: "Nháº¥n giá»¯ thÃªm", tut_weather: "Thá»i tiáº¿t", tut_next: "Tiáº¿p",
                tut_step2_title: "PhÃ­m táº¯t (2/2)", tut_settings: "CÃ i Ä‘áº·t", tut_compass: "La bÃ n", tut_share: "Chia sáº»", tut_prev: "TrÆ°á»›c", tut_finish: "Báº¯t Ä‘áº§u",
                settings: "CÃ i Ä‘áº·t", theme: "MÃ u chá»§ Ä‘á»", share_map: "Chia sáº» Báº£n Ä‘á»“", close: "ÄÃ³ng", search_ph: "ğŸ” TÃ¬m kiáº¿m...", locating: "Äang Ä‘á»‹nh vá»‹...", 
                food: "áº¨m thá»±c", highlights: "Ná»•i báº­t", history: "Lá»‹ch sá»­", transport: "Di chuyá»ƒn", nav: " Chá»‰ Ä‘Æ°á»ng", ai: " HÃ nh trÃ¬nh",
                chip_all: "ğŸŒŸ Táº¥t cáº£", chip_food: "ğŸœ Ä‚n", chip_history: "ğŸ›ï¸ Lá»‹ch sá»­", chip_nature: "â›°ï¸ Tá»± nhiÃªn", chip_custom: "ğŸ“ ÄÃ£ lÆ°u"
            }
        };

        let currentLang = localStorage.getItem('ruifang_lang') || 'zh';
        function applyLanguage(lang) {
            currentLang = lang; localStorage.setItem('ruifang_lang', lang);
            const t = translations[lang]; if(!t) return;
            
            document.getElementById('search').placeholder = t.search_ph;
            document.getElementById('addr-text').innerText = t.locating;
            
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (t[key]) {
                    if(el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') el.placeholder = t[key];
                    else el.innerHTML = el.innerHTML.replace(/<i class=".*"><\/i>/, match => match + " ") ? el.innerHTML.replace(/(<i class=".*"><\/i>).*/, `$1 ${t[key]}`) : t[key];
                }
            });
            document.getElementById('lang-select-startup').value = lang;
            document.getElementById('lang-select-settings').value = lang;
            if(targetSpot && document.getElementById("card").classList.contains("open")) renderCardButtons(targetSpot, t);
        }

        function openSettings() { document.getElementById('settings-modal-overlay').style.display = 'flex'; }
        function closeSettings() { document.getElementById('settings-modal-overlay').style.display = 'none'; }

        // =========================================
        // 4. å¤©æ°£èˆ‡åœ°åœ–åˆå§‹åŒ–
        // =========================================
        async function fetchWeather() {
            try {
                const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=25.108&longitude=121.805&current_weather=true&timezone=Asia%2FTaipei');
                const data = await res.json();
                const temp = Math.round(data.current_weather.temperature);
                const code = data.current_weather.weathercode;
                let iconClass = 'fa-cloud-sun'; 
                if(code === 0) iconClass = 'fa-sun'; else if(code > 3) iconClass = 'fa-cloud-rain'; 
                document.getElementById('weather-temp').innerText = `${temp}Â°C`;
                document.querySelector('#weather-box i').className = `fas ${iconClass}`; 
            } catch (e) { document.getElementById('weather-temp').innerText = "--"; }
        }

        const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([25.1032, 121.8224], 14);
        const mapLayers = [
            { url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', name: 'è¡—é“', icon: 'fa-map', dark: false },
            { url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', name: 'ç­‰é«˜ç·š', icon: 'fa-mountain', dark: false },
            { url: 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', name: 'å¤œé–“', icon: 'fa-moon', dark: true }
        ];
        let currentLayerIdx = 0, currentTileLayer = L.tileLayer(mapLayers[0].url).addTo(map);
        L.control.scale({ metric: true, imperial: false, position: 'bottomright' }).addTo(map);

        function toggleLayer() {
            currentLayerIdx = (currentLayerIdx + 1) % mapLayers.length; const c = mapLayers[currentLayerIdx];
            map.removeLayer(currentTileLayer); currentTileLayer = L.tileLayer(c.url).addTo(map);
            document.querySelector('#layer-btn i').className = `fas ${c.icon}`;
            if (c.dark) document.body.classList.add("dark-mode"); else document.body.classList.remove("dark-mode");
        }

        map.on('click', () => { closeCard(); document.getElementById("suggest").style.display = "none"; });

        let userPos = null;
        const userPulseIcon = L.divIcon({ className: 'user-pulse-icon', html: '<div class="pulse"></div><div class="dot"></div>', iconSize: [40, 40], iconAnchor: [20, 20] });
        map.locate({setView: false, watch: true}); 
        map.on('locationfound', e => {
            userPos = e.latlng; document.getElementById("gps-val-text").innerText = `GPS: ${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)}`;
            if(!window.userMarker) window.userMarker = L.marker(userPos, { icon: userPulseIcon }).addTo(map); else window.userMarker.setLatLng(userPos);
        });

        map.on('moveend', function() {
            const center = map.getCenter();
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${center.lat}&lon=${center.lng}&zoom=18&addressdetails=1&accept-language=zh-TW`)
            .then(res => res.json()).then(data => {
                if (data && data.address) { const a = data.address; document.getElementById("addr-text").innerText = ((a.city||a.town||a.county||"") + (a.suburb||a.district||"") + (a.village||a.neighbourhood||a.road||"")) || "æ¢ç´¢ç‘èŠ³ä¸­..."; }
            }).catch(()=>{}); 
        });

        // =========================================
        // 5. æ™¯é»èˆ‡ Firebase è¨­å®š
        // =========================================
        const spots = [
            { name: "ç‘èŠ³", lat: 25.108, lng: 121.805, tags: ["äº¤é€š", "ç¾é£Ÿ"], keywords: ["ç«è»Šç«™", "é¾é³³è…¿", "èƒ¡æ¤’é¤…"], highlights: "ç‘èŠ³ç¾é£Ÿå»£å ´", food: "é¾é³³è…¿ã€èƒ¡æ¤’é¤…", history: "é€²å…¥ä¹ä»½èˆ‡å¹³æºªç·šé–€æˆ¶ã€‚", transport: "å°éµç‘èŠ³ç«™" },
            { name: "ç‘èŠ³å¾Œç«™è€è¡—", lat: 25.109, lng: 121.806, tags: ["æ­·å²", "ç¾é£Ÿ"], keywords: ["ä¿é›²èŠ‹åœ“", "è€è¡—"], highlights: "ç‘èŠ³å‰µå§‹èŠ‹åœ“", food: "ä¿é›²èŠ‹åœ“", history: "æ—©æœŸç¤¦å·¥çš„èšé›†åœ°ã€‚", transport: "ç‘èŠ³ç«è»Šç«™å¾Œç«™" },
            { name: "ä¹ä»½è€è¡—", lat: 25.1099, lng: 121.8452, tags: ["æ­·å²", "ç¾é£Ÿ"], keywords: ["é˜¿å¦¹èŒ¶æ¨“", "èŠ‹åœ“", "å±±åŸ"], highlights: "é˜¿å¦¹èŒ¶æ¨“", food: "é˜¿æŸ‘å§¨èŠ‹åœ“", history: "é»ƒé‡‘å±±åŸã€‚", transport: "å®¢é‹ 788/965" },
            { name: "çŒ´ç¡è²“æ‘", lat: 25.086, lng: 121.828, tags: ["æ­·å²"], keywords: ["è²“", "ç‘ä¸‰æ•´ç…¤å» "], highlights: "è²“å’ªç™‚ç™’", food: "ç¤¦å·¥éºµ", history: "å…¨å°ç…¤ç¤¦ç”¢é‡ç¬¬ä¸€ã€‚", transport: "å°éµçŒ´ç¡ç«™" },
            { name: "é‡‘ç“œçŸ³é»ƒé‡‘åšç‰©é¤¨", lat: 25.1091, lng: 121.8576, tags: ["æ­·å²"], keywords: ["é‡‘ç“œçŸ³", "ç¤¦å·¥ä¾¿ç•¶"], highlights: "å¤§é‡‘ç£š", food: "ç¤¦å·¥ä¾¿ç•¶", history: "äºæ´²ç¬¬ä¸€é‡‘ç¤¦å±±ã€‚", transport: "å®¢é‹ 788/856" },
            { name: "ç„¡è€³èŒ¶å£ºå±±", lat: 25.1063, lng: 121.8659, tags: ["è‡ªç„¶"], keywords: ["æµ·æ™¯", "çˆ¬å±±"], highlights: "çµ•ç¾æµ·æ™¯", food: "ç„¡", history: "å±±å½¢ä¼¼ç„¡è€³èŒ¶å£ºã€‚", transport: "é‡‘ç“œçŸ³æ­¥è¡Œç™»å±±" }
        ];

        let targetSpot = null; let currentRoute = null;
        let myFavs = JSON.parse(localStorage.getItem('ruifang_favs')) || []; 
        let savedCustomSpots = JSON.parse(localStorage.getItem('ruifang_custom_spots')) || []; 
        let searchHistory = JSON.parse(localStorage.getItem('ruifang_search_history')) || []; 
        const themeRouteCoords = [[25.108, 121.805], [25.086, 121.828], [25.0606, 121.8226], [25.1091, 121.8576]];

        // å¡«å…¥æ‚¨æä¾›çš„ Firebase è³‡è¨Š
        const firebaseConfig = {
            apiKey: "è«‹è‡³Firebaseå¾Œå°å–å¾— Web API Key", 
            authDomain: "ruifang689-max.firebaseapp.com",
            projectId: "ruifang689-max",
            storageBucket: "ruifang689-max.appspot.com",
            messagingSenderId: "29945788628",
            appId: "è«‹è‡³Firebaseå¾Œå°å–å¾— App ID" 
        };
        let db = null; const userId = "user_default";

        if (firebaseConfig.apiKey !== "è«‹è‡³Firebaseå¾Œå°å–å¾— Web API Key") {
            import("https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js").then(module => {
                const app = module.initializeApp(firebaseConfig);
                import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js").then(fs => { db = fs.getFirestore(app); console.log("Firebase å·²å•Ÿç”¨"); });
            }).catch(e => console.log(e));
        }
        async function saveFavToCloud() {
            if (!db) return; 
            try { const { doc, setDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"); await setDoc(doc(db, "users", userId), { favorites: myFavs }, { merge: true }); } catch(e) {}
        }

        // =========================================
        // 6. åœ–é‡˜ã€å¡ç‰‡èˆ‡åœ°åœ–æ“ä½œ
        // =========================================
        const cluster = L.markerClusterGroup(); map.addLayer(cluster);
        function calculateWalk(lat, lng) { if(!userPos) return "--"; const mins = Math.round(map.distance(userPos, [lat, lng]) / 80); return mins < 1 ? "1åˆ†å…§" : `ç´„ ${mins} åˆ†`; }
        const createCustomPin = (tags) => { let cls = 'fa-map-marker-alt', col = '#ea4335'; if (tags.includes('ç¾é£Ÿ')) { cls = 'fa-utensils'; col = 'var(--primary)'; } else if (tags.includes('æ­·å²')) { cls = 'fa-landmark'; col = '#7f8c8d'; } else if (tags.includes('è‡ªç„¶')) { cls = 'fa-leaf'; col = '#2ecc71'; } else if (tags.includes('è‡ªè¨‚')) { cls = 'fa-star'; col = 'var(--accent)'; } return L.divIcon({ className: 'custom-pin-wrap', html: `<div class="gmap-pin" style="background-color:${col}"><i class="fas ${cls}"></i></div>`, iconSize: [32,32], iconAnchor: [16,38], popupAnchor: [0,-38] }); };

        function addMarkerToMap(s) {
            if (!s.tags.includes('è‡ªè¨‚') && !s.wikiImg) fetch(`https://zh.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(s.name)}`).then(r=>r.json()).then(d=>{s.wikiImg=d.thumbnail?.source;}).catch(()=>{});
            const m = L.marker([s.lat, s.lng], { icon: createCustomPin(s.tags) });
            m.bindPopup(() => {
                const img = s.wikiImg || 'https://via.placeholder.com/260x130/f39c12/ffffff?text=Ruifang';
                return `<div class="preview-card" onclick="openCardByName('${s.name}')"><img class="preview-img" src="${img}"><div class="preview-info"><div class="preview-header"><span class="preview-title">${s.name}</span><span class="walk-badge"><i class="fas fa-walking"></i> ${calculateWalk(s.lat, s.lng)}</span></div><div class="preview-tag-box">${s.tags.map(t=>`<span class="mini-tag">${t}</span>`).join('')}</div></div></div>`;
            }, { closeButton: false });
            m.on('mouseover', function() { this.openPopup(); }); m.on('click', (e) => { L.DomEvent.stopPropagation(e); showCard(s); });
            s.markerObj = m; cluster.addLayer(m);
        }
        spots.forEach(addMarkerToMap); savedCustomSpots.forEach(s => { spots.push(s); addMarkerToMap(s); });

        function filterSpots(category, element) {
            if(element) { document.querySelectorAll('.chip').forEach(c => c.classList.remove('active')); element.classList.add('active'); }
            cluster.clearLayers(); const filteredSpots = category === 'all' ? spots : spots.filter(s => s.tags.includes(category)); filteredSpots.forEach(addMarkerToMap); closeCard();
        }

        map.on('contextmenu', function(e) {
            const spotName = prompt("ğŸ“ æ–°å¢è‡ªè¨‚æ¨™è¨˜\nè«‹ç‚ºåœ°é»å‘½åï¼š", "æˆ‘çš„æ™¯é»");
            if (!spotName) return; 
            const newSpot = { name: spotName, lat: e.latlng.lat, lng: e.latlng.lng, tags: ["è‡ªè¨‚"], highlights: "é»æ“Šä¸‹æ–¹ç·¨è¼¯...", food: "--", history: "è‡ªè¨‚æ¨™è¨˜", transport: "è‡ªè¡Œå‰å¾€", wikiImg: "" };
            spots.push(newSpot); addMarkerToMap(newSpot); savedCustomSpots.push(newSpot); localStorage.setItem('ruifang_custom_spots', JSON.stringify(savedCustomSpots)); showCard(newSpot);
        });

        function renderCardButtons(s, t = translations[currentLang]) {
            const btnGroup = document.getElementById("card-btn-group");
            if (s.tags.includes('è‡ªè¨‚')) { btnGroup.innerHTML = `<button onclick="startNav()" style="flex: 1.2;"><i class="fas fa-location-arrow"></i> ${t.nav}</button><button class="edit-btn" onclick="openEditModal('${s.name}')"><i class="fas fa-edit"></i></button><button class="danger" onclick="deleteCustomSpot('${s.name}')"><i class="fas fa-trash-alt"></i></button>`; } 
            else { btnGroup.innerHTML = `<button onclick="startNav()"><i class="fas fa-location-arrow"></i> ${t.nav}</button><button class="secondary" onclick="aiTrip()"><i class="fas fa-magic"></i> ${t.ai}</button>`; }
        }

        function showCard(s) {
            targetSpot = s; document.getElementById("card-fav-icon").className = myFavs.includes(s.name) ? "fas fa-heart active" : "fas fa-heart";
            document.getElementById("title").innerText = s.name; document.getElementById("img").src = s.wikiImg || 'https://via.placeholder.com/400x200/f39c12/ffffff?text=Ruifang';
            document.getElementById("card-tags").innerHTML = s.tags.map(t => `<span class="mini-tag">${t}</span>`).join('');
            document.getElementById("card-food").innerText = s.food || "--"; document.getElementById("card-highlights").innerText = s.highlights || "æš«ç„¡ä»‹ç´¹";
            document.getElementById("card-history").innerText = s.history || "ç„¡"; document.getElementById("card-transport").innerText = s.transport || "è‡ªè¡Œå‰å¾€";
            renderCardButtons(s); document.getElementById("card").classList.add("open"); document.getElementById("card").style.transform = '';
        }
        function openCardByName(name) { const s = spots.find(x => x.name === name); if(s) showCard(s); }
        function closeCard() { document.getElementById("card").classList.remove("open"); document.getElementById("card").style.transform = ''; }
        function closeNav() { if(currentRoute) map.removeLayer(currentRoute); document.getElementById('route-info-panel').style.display = 'none'; }

        function startNav() {
            if(!userPos || !targetSpot) return alert("è«‹é–‹å•Ÿ GPS å®šä½"); closeCard(); document.getElementById('route-time').innerText = "è¨ˆç®—ä¸­..."; document.getElementById('route-dist').innerText = ""; document.getElementById('route-info-panel').style.display = 'flex';
            fetch(`https://router.project-osrm.org/route/v1/driving/${userPos.lng},${userPos.lat};${targetSpot.lng},${targetSpot.lat}?overview=full&geometries=geojson`)
            .then(r => r.json()).then(data => { if(currentRoute) map.removeLayer(currentRoute); const route = data.routes[0]; const coords = route.geometry.coordinates.map(c => [c[1], c[0]]); currentRoute = L.polyline(coords, {color: 'var(--primary)', weight: 8}).addTo(map); map.fitBounds(currentRoute.getBounds(), {padding: [80, 80]}); document.getElementById('route-time').innerText = `${Math.round(route.duration / 60)} åˆ†é˜`; document.getElementById('route-dist').innerText = `${(route.distance / 1000).toFixed(1)} km`; }).catch(() => { document.getElementById('route-time').innerText = "è¦åŠƒå¤±æ•—"; });
        }

        // =========================================
        // 7. æœå°‹èˆ‡å·¥å…·
        // =========================================
        const searchInput = document.getElementById("search"); const sugBox = document.getElementById("suggest");
        searchInput.addEventListener('focus', () => { if(!searchInput.value.trim()) renderDefaultSearch(); });
        function saveSearchHistory(name) { searchHistory = searchHistory.filter(h => h !== name); searchHistory.unshift(name); if(searchHistory.length > 5) searchHistory.pop(); localStorage.setItem('ruifang_search_history', JSON.stringify(searchHistory)); }
        function renderDefaultSearch() { sugBox.innerHTML = ""; if(searchHistory.length > 0) { sugBox.innerHTML += `<div class="search-section-title">ğŸ•’ æ­·å²æœå°‹</div>`; searchHistory.forEach(h => { sugBox.innerHTML += `<div class="list-item" onclick="triggerSearch('${h}')"><span><i class="fas fa-history" style="color:#aaa;"></i> ${h}</span></div>`; }); } sugBox.innerHTML += `<div class="search-section-title">â­ æ¨è–¦æ™¯é»</div>`; ["ä¹ä»½è€è¡—", "çŒ´ç¡è²“æ‘", "ç„¡è€³èŒ¶å£ºå±±"].forEach(r => { sugBox.innerHTML += `<div class="list-item" onclick="triggerSearch('${r}')"><span><i class="fas fa-fire" style="color:#e74c3c;"></i> ${r}</span></div>`; }); sugBox.style.display = "block"; }
        function triggerSearch(name) { searchInput.value = name; sugBox.style.display = "none"; const s = spots.find(x => x.name === name); if(s) { map.flyTo([s.lat, s.lng], 16); setTimeout(() => showCard(s), 800); } }
        searchInput.oninput = function() { const k = this.value.trim(); if(!k) { renderDefaultSearch(); return; } sugBox.innerHTML = ""; const matches = spots.filter(s => { return s.name.includes(k) || s.tags.some(t => t.includes(k)) || (s.keywords && s.keywords.some(kw => kw.includes(k))); }); if(matches.length > 0) { sugBox.style.display = "block"; matches.forEach(s => { const div = document.createElement("div"); div.className = "list-item"; div.innerHTML = `<span><i class="fas fa-map-marker-alt" style="color:var(--primary)"></i> ${s.name}</span>`; div.onclick = () => { saveSearchHistory(s.name); triggerSearch(s.name); }; sugBox.appendChild(div); }); } else { sugBox.style.display = "none"; } };

        function toggleCurrentFav() { if(!targetSpot) return; const idx = myFavs.indexOf(targetSpot.name); if(idx === -1) myFavs.push(targetSpot.name); else myFavs.splice(idx, 1); localStorage.setItem('ruifang_favs', JSON.stringify(myFavs)); document.getElementById("card-fav-icon").className = myFavs.includes(targetSpot.name) ? "fas fa-heart active" : "fas fa-heart"; saveFavToCloud(); }
        function toggleFavList() { const p = document.getElementById("fav-list-panel"); if(p.style.display === "block") { p.style.display = "none"; } else { p.innerHTML = ""; if(myFavs.length === 0) { p.innerHTML = `<div style="padding:15px; text-align:center; color:#888; font-size:13px;">å°šç„¡æ”¶è—æ™¯é»<br>é»æ“Šå¡ç‰‡æ„›å¿ƒåŠ å…¥ï¼</div>`; } else { myFavs.forEach(name => { const div = document.createElement("div"); div.className = "list-item"; div.innerHTML = `<span><i class="fas fa-heart" style="color:var(--danger); margin-right:5px;"></i> ${name}</span>`; div.onclick = () => triggerSearch(name); p.appendChild(div); }); } p.style.display = "block"; } }
        function shareSpot() { if(!targetSpot) return; const spotUrl = new URL(window.location.href); spotUrl.searchParams.set('spot', targetSpot.name); const shareData = { title: `ç‘èŠ³å°è¦½åœ°åœ– - ${targetSpot.name}`, text: `æˆ‘åœ¨ç‘èŠ³åœ°åœ–ä¸Šç™¼ç¾äº†ã€Œ${targetSpot.name}ã€ï¼\nè¶•å¿«é»æ“Šé€£çµæŸ¥çœ‹ï¼š`, url: spotUrl.toString() }; if (navigator.share) navigator.share(shareData).catch(()=>{}); else navigator.clipboard.writeText(`${shareData.text}\n${shareData.url}`).then(() => alert('âœ… å·²è¤‡è£½æ™¯é»è³‡è¨Šèˆ‡é€£çµï¼')); }
        function resetNorth() { map.flyTo([25.1032, 121.8224], 14); } function goToUser() { if(userPos) map.flyTo(userPos, 16); } function drawThemeRoute() { if(currentRoute) map.removeLayer(currentRoute); currentRoute = L.polyline(themeRouteCoords, { color: '#8e44ad', weight: 6, dashArray: '10, 10' }).addTo(map); map.fitBounds(currentRoute.getBounds(), { padding: [50, 50] }); closeCard(); alert("ğŸš€ æ¨è–¦è·¯ç·šå·²è¼‰å…¥ï¼"); } function goToStation() { map.flyTo([25.108, 121.805], 16); closeCard(); } function aiTrip() { if(!userPos) return alert("ç­‰å¾… GPS å®šä½..."); const sorted = [...spots].sort((a,b) => map.distance(userPos,[a.lat,a.lng]) - map.distance(userPos,[b.lat,b.lng])); alert("ğŸ¤– AI æ¨è–¦æœ€è¿‘æ™¯é»ï¼š\n" + sorted.slice(0,5).map((s,i) => `${i+1}. ${s.name}`).join("\n")); }

        const cardEl = document.getElementById("card"); let touchStartY = 0, isSwiping = false; cardEl.addEventListener('touchstart', (e) => { if(cardEl.scrollTop===0){ touchStartY=e.touches[0].clientY; isSwiping=true; cardEl.style.transition='none'; }},{passive:true}); cardEl.addEventListener('touchmove', (e) => { if(isSwiping && e.touches[0].clientY > touchStartY){ cardEl.style.transform=`translateY(${e.touches[0].clientY - touchStartY}px)`; }}); cardEl.addEventListener('touchend', (e) => { if(isSwiping){ isSwiping=false; cardEl.style.transition='transform 0.4s'; if((e.changedTouches[0]?.clientY || 0) - touchStartY > 100) closeCard(); else cardEl.style.transform=''; }});

        window.onload = () => {
            const params = new URLSearchParams(window.location.search); const spotQuery = params.get('spot');
            if(spotQuery) { const s = spots.find(x => x.name === spotQuery); if(s) { setTimeout(() => { map.flyTo([s.lat, s.lng], 16); showCard(s); }, 1000); } }
            applyLanguage(currentLang); fetchWeather();
            
            // è®€å–å„²å­˜çš„ä¸»é¡Œè‰²
            const savedTheme = localStorage.getItem('ruifang_theme');
            if (savedTheme) applyCustomTheme(savedTheme);

            if(localStorage.getItem('ruifang_welcomed')) { 
                document.getElementById('splash-screen').style.display = 'none'; 
                document.getElementById('welcome-screen').style.display = 'none'; 
            }
        };
    </script>
</body>
</html>
