<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç‘èŠ³å°è¦½åœ°åœ–</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* =========================================
           1. åŸºç¤è®Šæ•¸èˆ‡å…¨å±€è¨­å®š
           ========================================= */
        :root { 
            --primary: #007bff;           /* ä¸»è‰²èª¿ï¼šè—è‰² */
            --glass: rgba(255, 255, 255, 0.95); /* æ¯›ç»ç’ƒèƒŒæ™¯é€æ˜åº¦ */
            --accent: #e67e22;            /* å¼·èª¿è‰²ï¼šæ©˜è‰² (ç”¨æ–¼ç¾é£Ÿæˆ–è»Šç«™) */
            --danger: #ff4757;            /* è­¦å‘Šè‰²/æ„›å¿ƒè‰²ï¼šç´…è‰² */
            --text: #333;                 /* é è¨­å­—é«”é¡è‰²ï¼šæ·±ç° */
            --card-shadow: rgba(0,0,0,0.15); /* çµ±ä¸€çš„é™°å½±æ•ˆæœ */
        }

        /* æ·±è‰²æ¨¡å¼è®Šæ•¸è¦†è“‹ */
        body.dark-mode { 
            --glass: rgba(40, 40, 40, 0.95); 
            --text: #f0f0f0; 
            --card-shadow: rgba(0,0,0,0.4);
        }

        /* æ¶ˆé™¤é è¨­é‚Šè·ï¼Œéš±è—æ»¾å‹•æ¢ï¼Œç¢ºä¿æ»¿ç‰ˆé¡¯ç¤º */
        body { margin: 0; font-family: -apple-system, "Microsoft JhengHei", sans-serif; overflow: hidden; height: 100vh; }
        #map { height: 100vh; width: 100vw; z-index: 1; }

        /* =========================================
           2. é ‚éƒ¨ UI å€å¡Š (æœå°‹æ¬„èˆ‡åœ°é»å ±å¹•)
           ========================================= */
        #top-ui { 
            position: absolute; top: 15px; left: 50%; transform: translateX(-50%); 
            z-index: 3000; width: 85%; max-width: 380px;
            display: flex; flex-direction: column; align-items: center; gap: 8px; /* å…ƒç´ ä¹‹é–“çš„å‚ç›´é–“è· */
        }

        /* æœå°‹è¼¸å…¥æ¡† */
        #search { 
            width: 100%; padding: 12px 20px; border: none; border-radius: 30px; 
            box-shadow: 0 4px 20px var(--card-shadow); outline: none; 
            background: var(--glass); color: var(--text); font-size: 15px; text-align: center;
            box-sizing: border-box;
        }

        /* åœ°é»å ±å¹•æ¡† (ç½®æ–¼æœå°‹æ¬„æ­£ä¸‹æ–¹) */
        #map-center-panel {
            width: 90%; /* æ¯”æœå°‹æ¬„ç¨å¾®çª„ä¸€é»ï¼Œå¢åŠ è¦–è¦ºå±¤æ¬¡ */
            background: var(--glass); backdrop-filter: blur(10px); border-radius: 20px;
            padding: 8px 12px; box-shadow: 0 2px 10px var(--card-shadow);
            border: 1px solid rgba(255, 255, 255, 0.2); color: var(--text);
            display: flex; flex-direction: column; text-align: center; pointer-events: none; /* æ»‘é¼ ç©¿é€ä¸é˜»æ“‹åœ°åœ–æ“ä½œ */
            box-sizing: border-box;
        }
        .status-header { font-size: 11px; color: var(--primary); font-weight: bold; margin-bottom: 2px; }
        .addr-text { font-size: 13px; font-weight: bold; white-space: nowrap; }
        .addr-subtext { font-size: 11px; opacity: 0.7; white-space: nowrap; }

        /* =========================================
           3. å³ä¸Šè§’å¤©æ°£ UI å°æ–¹æ ¼
           ========================================= */
        #weather-box { 
            position: absolute; top: 15px; right: 15px; z-index: 3000;
            width: 50px; height: 50px; /* å°æ­£æ–¹å½¢è¨­è¨ˆ */
            background: var(--glass); backdrop-filter: blur(8px); 
            border-radius: 12px; box-shadow: 0 4px 15px var(--card-shadow); 
            border: 1px solid rgba(255,255,255,0.2); color: var(--text);
            display: flex; flex-direction: column; justify-content: center; align-items: center; /* åœ–æ¡ˆèˆ‡æ–‡å­—å‚ç›´ç½®ä¸­ */
        }
        #weather-box i { font-size: 20px; color: #f39c12; margin-bottom: 2px; }
        #weather-temp { font-size: 12px; font-weight: bold; }

        /* =========================================
           4. æœå°‹å»ºè­°ä¸‹æ‹‰æ¸…å–® & æ”¶è—å¤¾æ¸…å–®
           ========================================= */
        #suggest, #fav-list-panel { 
            background: var(--glass); border-radius: 18px; margin-top: 2px; 
            overflow-y: auto; max-height: 220px; width: 100%; display: none;
            box-shadow: 0 10px 25px var(--card-shadow); z-index: 3100;
            -ms-overflow-style: none; scrollbar-width: none; /* éš±è—åŸç”Ÿæ²è»¸ */
        }
        /* æ”¶è—å¤¾é¢æ¿å®šä½åœ¨å³ä¸‹æ–¹æŒ‰éˆ•æ— */
        #fav-list-panel { position: absolute; bottom: 160px; right: 70px; width: 200px; }
        
        /* æ¸…å–®å…§é …ç›®æ¨£å¼ */
        .list-item { padding: 14px 20px; border-bottom: 1px solid rgba(0,0,0,0.05); cursor: pointer; display: flex; align-items: center; gap: 10px; color: var(--text); justify-content: space-between; }
        .list-item:active { background: rgba(0,0,0,0.05); }
        .list-item i { color: var(--primary); font-size: 14px; }

        /* =========================================
           5. å³ä¸‹æ–¹åŠŸèƒ½æŒ‰éˆ•çµ„
           ========================================= */
        .map-controls { position: absolute; bottom: 100px; right: 12px; z-index: 3000; display: flex; flex-direction: column; gap: 12px; }
        .control-btn { 
            background: var(--glass); width: 50px; height: 50px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            box-shadow: 0 4px 15px var(--card-shadow); cursor: pointer; 
            color: var(--text); font-size: 20px; border: 1px solid rgba(255,255,255,0.2); transition: all 0.3s ease; 
        }
        .control-btn:active { transform: scale(0.9); } /* é»æ“Šç¸®æ”¾å‹•ç•« */
        .route-btn { color: #8e44ad; } /* ç´«è‰²è·¯ç·šæŒ‰éˆ• */
        .fav-btn { color: var(--danger); } /* ç´…è‰²æ”¶è—å¤¾æŒ‰éˆ• */
        .station-btn { color: var(--accent); } /* æ©˜è‰²è»Šç«™æŒ‰éˆ• */
        .compass-btn { color: #2ecc71; } /* ç¶ è‰²å…¨æ™¯æŒ‰éˆ• */
        .active { color: var(--primary); border: 2px solid var(--primary); }

        /* =========================================
           6. GPS åº§æ¨™ç´”æ–‡å­—ç‰ˆ (èˆ‡æ¯”ä¾‹å°ºä¸¦åˆ—)
           ========================================= */
        #gps-val-text {
            position: absolute; bottom: 22px; right: 120px; /* é¿é–‹å³ä¸‹è§’ç´„å¯¬ 100px çš„æ¯”ä¾‹å°º */
            z-index: 3000; font-family: monospace; font-size: 12px; font-weight: bold;
            color: var(--text); text-shadow: 0px 0px 3px rgba(255,255,255,0.8); /* åŠ ä¸Šæ–‡å­—é™°å½±ç¢ºä¿å¯è®€æ€§ */
            pointer-events: none; white-space: nowrap;
        }
        body.dark-mode #gps-val-text { text-shadow: 0px 0px 3px rgba(0,0,0,0.8); }

        /* =========================================
           7. æ‰‹æ©Ÿç‰ˆ UI é˜²è¡çªé©é… (æ ¸å¿ƒå„ªåŒ–å€)
           ========================================= */
        @media (max-width: 480px) {
            /* ç¸®å°é ‚éƒ¨ UI å¯¬åº¦ä¸¦é å·¦å°é½Šï¼Œå‹•æ…‹ä¿ç•™å³å´ 85px ç©ºé–“çµ¦å¤©æ°£æ–¹æ ¼ï¼Œé¿å…é‡ç–Š */
            #top-ui { 
                left: 15px; 
                transform: none; /* è§£é™¤ç½®ä¸­ */
                width: calc(100% - 85px); 
                align-items: stretch; /* è®“æœå°‹æ¬„å’Œå ±å¹•æ¡†è‡ªå‹•å¡«æ»¿é€™å€‹æ–°å¯¬åº¦ */
            }
            /* æ‰‹æ©Ÿä¸Šæœå°‹æ¬„æ–‡å­—é å·¦ï¼Œé¿å…è¢«åˆ‡æ–· */
            #search { text-align: left; padding-left: 20px; } 
            
            /* è®“å ±å¹•æ¡†çš„å¯¬åº¦èˆ‡æœå°‹æ¬„é½Šé½Šå°é½Š */
            #map-center-panel { width: 100%; }
            
            /* ç¢ºä¿æ”¶è—åˆ—è¡¨åœ¨æ‰‹æ©Ÿä¸Šä¸è¢«æ“‹ä½ */
            #fav-list-panel { right: 70px; bottom: 110px; } 
        }

        /* =========================================
           8. åº•éƒ¨è©³ç´°è³‡è¨Šå¤§å¡ç‰‡ (Bottom Sheet)
           ========================================= */
        #card { 
            position: absolute; bottom: 0; left: 0; width: 100%; transform: translateY(110%); /* é è¨­éš±è—è‡³ç•«é¢å¤– */
            max-height: 80vh; background: var(--glass); color: var(--text); 
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); z-index: 4000; 
            padding: 25px; box-sizing: border-box; border-radius: 25px 25px 0 0; 
            box-shadow: 0 -8px 25px var(--card-shadow); overflow-y: auto; 
        }
        #card.open { transform: translateY(0); } /* é–‹å•Ÿå¡ç‰‡æ™‚æ»‘å…¥ç•«é¢ */
        
        /* é ‚éƒ¨ä¸‹æ‹‰æŠŠæ‰‹æŒ‡ç¤ºå™¨ */
        .close-bar { width: 50px; height: 5px; background: #888; border-radius: 10px; margin: -10px auto 15px; cursor: pointer; }
        
        /* å¡ç‰‡æ¨™é¡Œèˆ‡æ„›å¿ƒæŒ‰éˆ•åŒè¡Œ */
        .card-header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        #title { margin: 0; font-size: 26px; }
        #card-fav-icon { font-size: 24px; cursor: pointer; color: #ccc; transition: transform 0.2s; }
        #card-fav-icon.active { color: var(--danger); transform: scale(1.2); }

        #img { width: 100%; height: 180px; object-fit: cover; border-radius: 15px; margin-bottom: 15px; background: #eee; }
        
        /* è³‡è¨Šæ®µè½æ¨™é¡Œèˆ‡å…§æ–‡ */
        .info-label { font-weight: bold; color: var(--text); display: block; margin-top: 15px; font-size: 15px; border-left: 4px solid var(--primary); padding-left: 8px; }
        .info-text { color: var(--text); opacity: 0.9; font-size: 14px; line-height: 1.6; margin-top: 5px; display: block; }
        
        /* å¡ç‰‡åº•éƒ¨åŠŸèƒ½æŒ‰éˆ• */
        .btn-group { display: flex; gap: 10px; margin-top: 25px; }
        button { flex: 1; padding: 14px; border: none; border-radius: 12px; background: var(--primary); color: white; cursor: pointer; font-weight: bold; font-size: 15px; }
        button.secondary { background: #555; }

        /* =========================================
           9. åœ°åœ–æµ®å‹•å°åœ–å¡ (Popup) æ¨£å¼è¦†è“‹
           ========================================= */
        .leaflet-popup-content-wrapper { border-radius: 15px; background: var(--glass); padding: 0; }
        .leaflet-popup-content { margin: 0; width: 260px !important; color: var(--text); }
        .preview-card { width: 260px; cursor: pointer; }
        .preview-img { width: 100%; height: 130px; object-fit: cover; border-radius: 15px 15px 0 0;}
        .preview-info { padding: 12px; }
        .preview-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 5px;}
        .preview-title { font-weight: bold; font-size: 17px; }
        .walk-badge { font-size: 11px; background: #e8f4fd; color: #007bff; padding: 3px 8px; border-radius: 12px; font-weight: bold; }
        .mini-tag { display: inline-block; font-size: 10px; padding: 2px 6px; margin: 2px 2px 0 0; border-radius: 4px; background: rgba(0,123,255,0.1); color: var(--primary); font-weight: bold; }
        .food-preview { font-size: 12px; color: var(--accent); font-weight: bold; border-top: 1px dashed rgba(0,0,0,0.1); padding-top: 8px; margin-top: 8px; }

        /* è¦†è“‹ Leaflet åŸç”Ÿæ¯”ä¾‹å°ºæ¨£å¼ */
        .leaflet-control-scale-line { background: rgba(255, 255, 255, 0.8) !important; border: 2px solid #333 !important; font-weight: bold; }
    </style>
</head>
<body id="main-body">

<div id="weather-box" title="å³æ™‚å¤©æ°£">
    <i class="fas fa-cloud-sun"></i>
    <span id="weather-temp">20Â°C</span>
</div>

<div id="top-ui">
    <input id="search" placeholder="ğŸ” æœå°‹ç‘èŠ³æ™¯é»ã€ç§˜å¢ƒ...">
    <div id="map-center-panel">
        <div class="status-header"><i class="fas fa-crosshairs"></i> ç›®å‰ç•«é¢å€åŸŸ</div>
        <div id="addr-line1" class="addr-text">åµæ¸¬ä¸­...</div>
        <div id="addr-line2" class="addr-subtext">ç§»å‹•åœ°åœ–ä»¥æ›´æ–°</div>
    </div>
    <div id="suggest"></div>
</div>

<div class="map-controls">
    <div class="control-btn compass-btn" onclick="resetNorth()" title="å›åˆ°å…¨æ™¯"><i class="fas fa-compass"></i></div>
    <div class="control-btn route-btn" onclick="drawThemeRoute()" title="æ¨è–¦ï¼šæ™‚ç©ºæ—…äººè·¯ç·š"><i class="fas fa-route"></i></div>
    <div class="control-btn fav-btn" onclick="toggleFavList()" title="æˆ‘çš„æ”¶è—å¤¾"><i class="fas fa-folder-open"></i></div>
    <div class="control-btn station-btn" onclick="goToStation()" title="å›åˆ°ç‘èŠ³ä¸­å¿ƒ"><i class="fas fa-train"></i></div>
    <div class="control-btn" onclick="toggleNight()" title="æ—¥å¤œæ¨¡å¼"><i class="fas fa-moon"></i></div>
    <div class="control-btn active" onclick="goToUser()" title="æˆ‘çš„ä½ç½®"><i class="fas fa-location-crosshairs"></i></div>
</div>

<div id="fav-list-panel">
    <div style="padding:15px; text-align:center; color:#888; font-size:13px;">å°šç„¡æ”¶è—æ™¯é»<br>é»æ“Šå¡ç‰‡æ„›å¿ƒåŠ å…¥ï¼</div>
</div>

<div id="gps-val-text">GPS: å®šä½ä¸­...</div>

<div id="map"></div>

<div id="card">
    <div class="close-bar" onclick="closeCard()"></div>
    
    <div class="card-header-row">
        <h2 id="title"></h2>
        <i id="card-fav-icon" class="fas fa-heart" onclick="toggleCurrentFav()"></i>
    </div>

    <div id="card-tags" style="margin: 0 0 15px 0;"></div>
    <img id="img">
    
    <div class="info-section">
        <span class="info-label"><i class="fas fa-utensils"></i> åœ¨åœ°é£²é£Ÿç‰¹è‰²</span>
        <span id="card-food" class="info-text"></span>
    </div>
    <div class="info-section">
        <span class="info-label"><i class="fas fa-star"></i> æ™¯é»æ¨è–¦èˆ‡äº®é»</span>
        <span id="card-highlights" class="info-text"></span>
    </div>
    <div class="info-section">
        <span class="info-label"><i class="fas fa-history"></i> ç°¡ä»‹èˆ‡æ­·å²</span>
        <span id="card-history" class="info-text"></span>
    </div>
    <div class="info-section">
        <span class="info-label"><i class="fas fa-bus"></i> äº¤é€šæ–¹å¼</span>
        <span id="card-transport" class="info-text"></span>
    </div>

    <div class="btn-group">
        <button onclick="startNav()"><i class="fas fa-paper-plane"></i> é–‹å§‹å°è¦½</button>
        <button class="secondary" onclick="aiTrip()">AI è¡Œç¨‹è¦åŠƒ</button>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<script>
// =========================================
// 1. æ™¯é»è³‡æ–™åº«å®šç¾© (æ•´åˆåŸºç¤æ™¯é»èˆ‡ç§˜å¢ƒ)
// =========================================
const spots = [
    { name: "ç‘èŠ³", lat: 25.108, lng: 121.805, tags: ["äº¤é€šæ¨ç´", "ç¾é£Ÿ"], highlights: "ç‘èŠ³ç¾é£Ÿå»£å ´ã€ç‘èŠ³è€è¡—", food: "é¾é³³è…¿ã€èƒ¡æ¤’é¤…ã€ç‰›è‚‰éºµ", history: "ç‘èŠ³æ›¾å› æ¡ç¤¦è€Œèˆˆï¼Œæ˜¯é€²å…¥ä¹ä»½èˆ‡å¹³æºªç·šé–€æˆ¶ã€‚", transport: "å°éµç‘èŠ³ç«™ã€åœ‹é“å®¢é‹965/1062", heat: 0.6 },
    { name: "å››è…³äº­", lat: 25.103, lng: 121.762, tags: ["ç ²å°", "å¤é“"], highlights: "å››è…³äº­ç ²å°ã€æ©‹é ­æ’éª¨éºµ", food: "æ’éª¨éºµã€å‚³çµ±æ—©é»", history: "æ—©æœŸç‚ºåŸºéš†é€šå¾€å®œè˜­çš„é‡è¦å¤é“æ“šé»ã€‚", transport: "å°éµå››è…³äº­ç«™", heat: 0.4 },
    { name: "çŒ´ç¡", lat: 25.086, lng: 121.828, tags: ["è²“æ‘", "ç…¤ç¤¦"], highlights: "çŒ´ç¡è²“æ‘ã€ç‘ä¸‰æ•´ç…¤å» ", food: "ç¤¦å·¥éºµã€å¤§éºµç™¼", history: "æ›¾ç‚ºå…¨å°ç…¤ç¤¦ç”¢é‡ç¬¬ä¸€ï¼Œç¾ä»¥è²“æ‘èˆ‡å·¥æ¥­éºè·¡èåã€‚", transport: "å°éµå¹³æºªç·šçŒ´ç¡ç«™", heat: 0.9 },
    { name: "ä¹ä»½è€è¡—", lat: 25.1099, lng: 121.8452, tags: ["å¤œæ™¯", "é»ƒé‡‘å±±åŸ"], highlights: "é˜¿å¦¹èŒ¶æ¨“ã€æ˜‡å¹³æˆ²é™¢", food: "é˜¿æŸ‘å§¨èŠ‹åœ“ã€é˜¿è˜­è‰ä»”ç²¿", history: "æ¡é‡‘æ™‚æœŸçš„ç¹è¯å±±åŸï¼Œå»ºç¯‰ä¾å±±è€Œå»ºã€‚", transport: "ç‘èŠ³ç«™è½‰ä¹˜å®¢é‹ 788 / 965", heat: 1.0 },
    { name: "æ·±æ¾³", lat: 25.133, lng: 121.824, tags: ["è±¡é¼»å²©", "æµ·æ™¯éµé“"], highlights: "è±¡é¼»å²©ã€æ·±æ¾³éµé“è‡ªè¡Œè»Š", food: "é¯Šé­šç¾¹ã€å°å·ç±³ç²‰", history: "æ›¾ç‚ºé‡è¦ç…¤ç¤¦è¼¸å‡ºæ¸¯ï¼Œç¾ä»¥æµ·è•å¥‡å²©èåã€‚", transport: "ç‘èŠ³ç«™è½‰å…¬è»ŠT99ã€791", heat: 0.8 },
    { name: "é¼»é ­è§’", lat: 25.12588, lng: 121.92028, tags: ["è‡ªç„¶æ™¯è§€"], food: "æµ·ç”¢", highlights: "é¼»é ­è§’æ­¥é“ã€ç‡ˆå¡”", history: "ç‘èŠ³æ±åŒ—è§’çš„çµ•ç¾å²¬è§’ã€‚", transport: "å®¢é‹ 856 / 886", heat: 0.7 },
    { name: "é‡‘ç“œçŸ³", lat: 25.10911, lng: 121.85768, tags: ["ç¤¦æ¥­"], food: "ç¤¦å·¥ä¾¿ç•¶", highlights: "é»ƒé‡‘åšç‰©é¤¨ã€é»ƒé‡‘ç¥ç¤¾", history: "æ˜”æ—¥äºæ´²ç¬¬ä¸€é‡‘ç¤¦å±±ã€‚", transport: "å®¢é‹ 788 / 856", heat: 0.6 },
    { name: "ç„¡è€³èŒ¶å£ºå±±", lat: 25.10637, lng: 121.86596, tags: ["ç™»å±±"], food: "ç„¡", highlights: "çµ•ç¾æµ·æ™¯", history: "å› å±±å½¢ç‹€ä¼¼ç„¡è€³èŒ¶å£ºè€Œå¾—åã€‚", transport: "é‡‘ç“œçŸ³æ­¥è¡Œç™»å±±", heat: 0.8 },
    { name: "æ°´æ¹³æ´", lat: 25.12248, lng: 121.86033, tags: ["åœ°æ¨™"], food: "å°åƒ", highlights: "é™°é™½æµ·ã€æ°´æ¹³æ´æ¼æ¸¯", history: "æ¡ç¤¦å·¥æ¥­èˆ‡è‡ªç„¶äº¤ç•Œã€‚", transport: "å®¢é‹ 856 / 886", heat: 0.7 },
    { name: "åä¸‰å±¤éºå€", lat: 25.11826, lng: 121.86465, tags: ["å·¥æ¥­éºå€"], food: "ç„¡", highlights: "é»ç‡ˆç¾æ™¯ã€å°ç‰ˆé¾è²åŸ", history: "æ˜”æ—¥å¤§å‹é¸ç…‰å» éºå€ã€‚", transport: "é•·ä»ç¤¾å€é™„è¿‘", heat: 0.9 },
    { name: "é»ƒé‡‘ç€‘å¸ƒ", lat: 25.11713, lng: 121.86148, tags: ["è‡ªç„¶"], food: "ç„¡", highlights: "é‡‘é»ƒå²©çŸ³èˆ‡æ°´æµ", history: "ç¤¦é«”èˆ‡åœ°ä¸‹æ°´ä½œç”¨å½¢æˆã€‚", transport: "å®¢é‹ 856 / 886", heat: 0.9 },
    { name: "ä¸‰è²‚å¶º", lat: 25.06066, lng: 121.82264, tags: ["ç§˜å¢ƒ"], food: "éºµé£Ÿã€æŠ«è–©", highlights: "éµé“æ‹æ”ã€ç€‘å¸ƒç¾¤", history: "å…¨å°å”¯ä¸€æ±½è»Šç„¡æ³•ç›´é”çš„è»Šç«™ã€‚", transport: "å°éµä¸‰è²‚å¶ºç«™", heat: 0.7 },
    { name: "ä¸å­äº­", lat: 25.0895, lng: 121.8473, tags: ["ç§˜å¢ƒ", "æ‰“å¡"], food: "å»ºè­°è‡ªå‚™", highlights: "å¯‚å¯å…¬è·¯ã€æœ€ç¾102ç¸£é“", history: "åå­—å–è‡ªæç™½è©©å¥ã€Œç›¸çœ‹å…©ä¸å­ã€ã€‚", transport: "è‡ªè¡Œé–‹è»Š/è¨ˆç¨‹è»Š", heat: 0.5 },
    { name: "å—å­åæ­¥é“", lat: 25.1206, lng: 121.8863, tags: ["ç™»å±±", "æµ·æ™¯"], food: "å—é›…éºµåº—", highlights: "360åº¦ç„¡æ•µå±±æµ·æ™¯", history: "é«˜åº¦åƒ…196å…¬å°ºå»æ“æœ‰é«˜å±±æ°£å‹¢çš„è¶…é«˜CPå€¼æ­¥é“ã€‚", transport: "å…¬è»Š 856/886", heat: 0.6 }
];

// é è¨­æ—…éŠè·¯ç·šï¼šæ™‚ç©ºæ—…äººç·š
const themeRouteCoords = [[25.108, 121.805], [25.086, 121.828], [25.0606, 121.8226], [25.1091, 121.8576]];

// å…¨åŸŸç‹€æ…‹è®Šæ•¸
let userPos = null, isNight = false, heatLayer = null, currentRoute = null, targetSpot = null;
// è®€å–ç€è¦½å™¨ä¸­çš„æˆ‘çš„æ”¶è—å¤¾è³‡æ–™ï¼Œè‹¥ç„¡å‰‡ç‚ºç©ºé™£åˆ—
let myFavs = JSON.parse(localStorage.getItem('ruifang_favs')) || []; 

// =========================================
// 2. åœ°åœ–åˆå§‹åŒ–è¨­å®š
// =========================================
const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([25.1032, 121.8224], 14);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

// åœ¨å³ä¸‹è§’åŠ å…¥æ¯”ä¾‹å°º (æœƒè‡ªå‹•é¿é–‹ GPS æ–‡å­—)
L.control.scale({ metric: true, imperial: false, position: 'bottomright' }).addTo(map);

// é»æ“Šåœ°åœ–ä»»æ„è™•ï¼Œé—œé–‰è³‡è¨Šå¡åŠä¸‹æ‹‰æ¸…å–®
map.on('click', () => { 
    closeCard(); 
    document.getElementById("suggest").style.display = "none";
    document.getElementById("fav-list-panel").style.display = "none";
});

// =========================================
// 3. å®šä½åŠŸèƒ½èˆ‡é€†åœ°ç†ç·¨ç¢¼ (åœ°å€è½‰æ›)
// =========================================
map.locate({setView: false, watch: true}); // æŒçºŒè¿½è¹¤ä½¿ç”¨è€…ä½ç½®
map.on('locationfound', e => {
    userPos = e.latlng;
    // æ›´æ–°ç´”æ–‡å­— GPS é¡¯ç¤º
    document.getElementById("gps-val-text").innerText = `GPS: ${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)}`;
    
    // ç¹ªè£½æˆ–æ›´æ–°ä½¿ç”¨è€…è—é»
    if(!window.userMarker) window.userMarker = L.circleMarker(userPos, { radius: 8, color: '#fff', fillColor: '#007bff', fillOpacity: 1, weight: 3 }).addTo(map);
    else window.userMarker.setLatLng(userPos);
});

// ç•¶åœ°åœ–åœæ­¢æ‹–æ›³æ™‚ï¼Œå–å¾—ä¸­å¿ƒåº§æ¨™ä¸¦å‘¼å« OpenStreetMap API è½‰æ›ç‚ºçœŸå¯¦åœ°å€
map.on('moveend', function() {
    const center = map.getCenter();
    fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${center.lat}&lon=${center.lng}&zoom=18&addressdetails=1&accept-language=zh-TW`)
    .then(res => res.json()).then(data => {
        if (data && data.address) {
            const a = data.address;
            // çµ„åˆç¸£å¸‚å€åç¨± (ä¾‹ï¼šæ–°åŒ—å¸‚ç‘èŠ³å€)
            document.getElementById("addr-line1").innerText = (a.city||a.town||a.county||"") + (a.suburb||a.district||"");
            // çµ„åˆæ‘é‡Œè·¯æ®µåç¨± (ä¾‹ï¼šæ·±æ¾³é‡Œ)
            document.getElementById("addr-line2").innerText = a.village||a.neighbourhood||a.road||"é™„è¿‘";
        }
    }).catch(()=>{}); // å¿½ç•¥ç¶²è·¯éŒ¯èª¤
});
map.fire('moveend'); // åˆå§‹åŒ–å³åŸ·è¡Œä¸€æ¬¡åœ°å€è«‹æ±‚

// =========================================
// 4. ç”Ÿæˆåœ°åœ–æ¨™è¨˜ (Markers) èˆ‡å¢é›† (Cluster)
// =========================================
const cluster = L.markerClusterGroup();
map.addLayer(cluster);

// è¨ˆç®—è·é›¢ä¸¦è½‰æ›ç‚ºæ­¥è¡Œæ™‚é–“
function calculateWalk(lat, lng) {
    if(!userPos) return "--";
    const mins = Math.round(map.distance(userPos, [lat, lng]) / 80); // ä»¥æ¯åˆ†é˜ 80 å…¬å°ºè¨ˆç®—
    return mins < 1 ? "1åˆ†å…§" : `ç´„ ${mins} åˆ†`;
}

spots.forEach(s => {
    // éåŒæ­¥æŠ“å–ç¶­åŸºç™¾ç§‘ç¬¬ä¸€å¼µåœ–ç‰‡ä½œç‚ºç¸®åœ–
    fetch(`https://zh.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(s.name)}`)
    .then(r => r.json()).then(d => { s.wikiImg = d.thumbnail?.source; });

    const m = L.marker([s.lat, s.lng]);
    // ç¶å®šé»æ“Šæ¨™è¨˜æ™‚å½ˆå‡ºçš„ Popup (æµ®å‹•å°å¡)
    m.bindPopup(() => {
        const img = s.wikiImg || 'https://via.placeholder.com/260x130?text=Ruifang';
        return `
            <div class="preview-card" onclick="openCardByName('${s.name}')">
                <img class="preview-img" src="${img}">
                <div class="preview-info">
                    <div class="preview-header">
                        <span class="preview-title">${s.name}</span>
                        <span class="walk-badge"><i class="fas fa-walking"></i> ${calculateWalk(s.lat, s.lng)}</span>
                    </div>
                    <div>${s.tags.map(t=>`<span class="mini-tag">${t}</span>`).join('')}</div>
                    <div class="food-preview"><i class="fas fa-utensils"></i> ç¾é£Ÿï¼š${s.food}</div>
                </div>
            </div>`;
    }, { closeButton: false });
    
    // æ»‘é¼ ç§»å…¥è‡ªå‹•é–‹å•Ÿé è¦½
    m.on('mouseover', function() { this.openPopup(); });
    // é»æ“Šæ¨™è¨˜ç›´æ¥é–‹å•Ÿåº•éƒ¨è©³ç´°å¤§å¡ç‰‡
    m.on('click', (e) => { L.DomEvent.stopPropagation(e); showCard(s); });
    cluster.addLayer(m);
});

// =========================================
// 5. æ”¶è—å¤¾æ ¸å¿ƒåŠŸèƒ½
// =========================================
// åˆ‡æ›ç•¶å‰æ™¯é»çš„æ”¶è—ç‹€æ…‹
function toggleCurrentFav() {
    if(!targetSpot) return;
    const idx = myFavs.indexOf(targetSpot.name);
    const icon = document.getElementById("card-fav-icon");
    
    if(idx === -1) {
        myFavs.push(targetSpot.name); // ä¸åœ¨æ¸…å–®ä¸­ -> åŠ å…¥
        icon.classList.add("active");
    } else {
        myFavs.splice(idx, 1); // å·²åœ¨æ¸…å–®ä¸­ -> ç§»é™¤
        icon.classList.remove("active");
    }
    localStorage.setItem('ruifang_favs', JSON.stringify(myFavs)); // å­˜æª”è‡³ç€è¦½å™¨
    renderFavList(); // åŒæ­¥æ›´æ–°å³å´ UI åˆ—è¡¨
}

// æ ¹æ“šæ™¯é»åç¨±æ›´æ–°æ„›å¿ƒé¡è‰²
function updateHeartUI(name) {
    const icon = document.getElementById("card-fav-icon");
    if(myFavs.includes(name)) icon.classList.add("active");
    else icon.classList.remove("active");
}

// æ§åˆ¶æ”¶è—æ¸…å–®é¢æ¿çš„é–‹é—œ
function toggleFavList() {
    const p = document.getElementById("fav-list-panel");
    if(p.style.display === "block") { p.style.display = "none"; }
    else { renderFavList(); p.style.display = "block"; }
}

// æ¸²æŸ“æ”¶è—æ¸…å–®å…§çš„ HTML
function renderFavList() {
    const p = document.getElementById("fav-list-panel");
    p.innerHTML = "";
    if(myFavs.length === 0) {
        p.innerHTML = '<div style="padding:15px; text-align:center; color:#888; font-size:13px;">å°šç„¡æ”¶è—æ™¯é»<br>é»æ“Šå¡ç‰‡æ„›å¿ƒåŠ å…¥ï¼</div>';
        return;
    }
    myFavs.forEach(name => {
        const div = document.createElement("div"); div.className = "list-item"; 
        div.innerHTML = `<span><i class="fas fa-heart" style="color:var(--danger); margin-right:5px;"></i> ${name}</span> <i class="fas fa-arrow-right" style="color:#ccc;"></i>`;
        // é»æ“Šæ¸…å–®é …ç›®ï¼Œè‡ªå‹•é£›å‘è©²é»ä¸¦é–‹å•Ÿå¡ç‰‡
        div.onclick = () => {
            const s = spots.find(x => x.name === name);
            if(s) {
                map.flyTo([s.lat, s.lng], 16); p.style.display = "none";
                setTimeout(() => showCard(s), 800);
            }
        };
        p.appendChild(div);
    });
}

// =========================================
// 6. UI é¢æ¿æ§åˆ¶èˆ‡å°èˆª (æ ¸å¿ƒä¿®æ”¹å€)
// =========================================

// å°‡æ™¯é»è³‡æ–™å¡«å…¥å¡ç‰‡ä¸¦å‘ä¸Šæ»‘å‡ºé¡¯ç¤º
function showCard(s) {
    targetSpot = s;
    updateHeartUI(s.name); // ç¢ºèªæ˜¯å¦å·²è¢«æ”¶è—
    document.getElementById("title").innerText = s.name;
    document.getElementById("img").src = s.wikiImg || 'https://via.placeholder.com/400x200?text=No+Image';
    document.getElementById("card-tags").innerHTML = s.tags.map(t=>`<span class="mini-tag" style="font-size:12px;">${t}</span>`).join('');
    document.getElementById("card-food").innerText = s.food;
    document.getElementById("card-highlights").innerText = s.highlights;
    document.getElementById("card-history").innerText = s.history;
    document.getElementById("card-transport").innerText = s.transport;
    document.getElementById("card").classList.add("open"); // åŠ ä¸Š class è§¸ç™¼ CSS å‹•ç•«
}

// é€éåç¨±é–‹å•Ÿå¡ç‰‡ (ç”¨æ–¼æµ®å‹•å°å¡çš„é»æ“Šäº‹ä»¶)
function openCardByName(name) { const s = spots.find(x => x.name === name); if(s) showCard(s); }

// é—œé–‰å¡ç‰‡ï¼ŒåŒæ™‚æ¸…é™¤ç›®å‰åœ°åœ–ä¸Šçš„å°èˆªè—ç·š
function closeCard() { 
    document.getElementById("card").classList.remove("open"); 
    if(currentRoute) { map.removeLayer(currentRoute); currentRoute = null; } 
}

// ç•«å‡ºç³»çµ±é è¨­çš„æ™‚ç©ºæ—…äººè·¯ç·š
function drawThemeRoute() {
    if(currentRoute) map.removeLayer(currentRoute);
    // ä½¿ç”¨ç´«è‰²è™›ç·šä»£è¡¨é è¨­æ¨è–¦è·¯ç·š
    currentRoute = L.polyline(themeRouteCoords, { color: '#8e44ad', weight: 6, opacity: 0.8, dashArray: '10, 10' }).addTo(map);
    map.fitBounds(currentRoute.getBounds(), { padding: [50, 50] }); // ç¸®æ”¾è‡³å®Œç¾åŒ…è¦†è·¯ç·š
    closeCard(); alert("ğŸš€ æ™‚ç©ºæ—…äººç·šå·²è¼‰å…¥ï¼\n(ç‘èŠ³â”çŒ´ç¡â”ä¸‰è²‚å¶ºâ”é‡‘ç“œçŸ³)");
}

// å•Ÿå‹•å¯¦æ™‚å°èˆªè·¯ç·š (ä¿®æ”¹ï¼šé€€å‡ºè³‡è¨Šå¡å¾Œé€²å…¥å°è¦½)
function startNav() {
    if(!userPos || !targetSpot) return alert("è«‹é–‹å•Ÿ GPS å®šä½ä»¥ä¾¿ç‚ºæ‚¨è¦åŠƒè·¯ç·šã€‚");
    
    // 1. é€€å‡ºè³‡è¨Šå¡ï¼Œè£½é€ ã€Œé€²å…¥å°èˆªæ¨¡å¼ã€çš„è¦–è¦ºåˆ‡æ›æ„Ÿ
    document.getElementById("card").classList.remove("open"); 
    
    // 2. è«‹æ±‚ OSRM é–‹æºè·¯ç·š API
    fetch(`https://router.project-osrm.org/route/v1/driving/${userPos.lng},${userPos.lat};${targetSpot.lng},${targetSpot.lat}?overview=full&geometries=geojson`)
    .then(r => r.json()).then(data => {
        // è‹¥åœ°åœ–ä¸Šå·²æœ‰èˆŠè·¯ç·šï¼Œå…ˆç§»é™¤
        if(currentRoute) map.removeLayer(currentRoute);
        // GeoJSON é è¨­ç¶“ç·¯åº¦ç›¸åï¼Œéœ€ä½œ map() è½‰æ›
        const coords = data.routes[0].geometry.coordinates.map(c => [c[1], c[0]]);
        // ç•«å‡ºå¯¦å¿ƒè—è‰²å°èˆªç·š
        currentRoute = L.polyline(coords, {color: '#007bff', weight: 8}).addTo(map);
        // åœ°åœ–è¦–è§’å¹³æ»‘ç¸®æ”¾è‡³æ•´æ¢è·¯ç·š
        map.fitBounds(currentRoute.getBounds(), {padding: [80, 80]}); 
    });
}

// åœ°åœ–è¦–è§’å°å·¥å…·
function resetNorth() { map.flyTo([25.1032, 121.8224], 14); } // é‡å›åˆå§‹è¦–è§’
function goToUser() { if(userPos) map.flyTo(userPos, 16); } // é£›å‘ä½¿ç”¨è€…ä½ç½®
function goToStation() { map.flyTo([25.108, 121.805], 16); closeCard(); } // å›åˆ°ç‘èŠ³ç«è»Šç«™

// æ—¥å¤œæ¨¡å¼åˆ‡æ› (åˆ‡æ› CSS è®Šæ•¸èˆ‡åœ°åœ–åœ–å±¤)
function toggleNight() { 
    isNight = !isNight; 
    document.body.classList.toggle("dark-mode"); 
    const darkMap = 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png';
    const lightMap = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
    L.tileLayer(isNight ? darkMap : lightMap).addTo(map); 
}

// é–‹å•Ÿ/é—œé–‰æ™¯é»ç†±åº¦åœ–
function toggleHeat() { 
    if(heatLayer) { map.removeLayer(heatLayer); heatLayer = null; } 
    else { heatLayer = L.heatLayer(spots.map(s => [s.lat, s.lng, s.heat]), {radius: 35}).addTo(map); } 
}

// AI è¡Œç¨‹è¦åŠƒ (æ ¹æ“šèˆ‡ä½¿ç”¨è€…çš„ç›´ç·šè·é›¢é€²è¡Œæ’åºæ¨è–¦)
function aiTrip() { 
    if(!userPos) return alert("ç­‰å¾… GPS å®šä½..."); 
    const sorted = [...spots].sort((a,b) => map.distance(userPos,[a.lat,a.lng]) - map.distance(userPos,[b.lat,b.lng])); 
    alert("ğŸ¤– æ ¹æ“šæ‚¨ç¾åœ¨ä½ç½®çš„ AI æ¨è–¦ï¼š\n" + sorted.slice(0,5).map((s,i) => `${i+1}. ${s.name}`).join("\n")); 
}

// =========================================
// 7. æœå°‹åˆ—è‡ªå‹•è¯æƒ³åŠŸèƒ½
// =========================================
document.getElementById("search").oninput = function() {
    const k = this.value.trim(), sug = document.getElementById("suggest");
    sug.innerHTML = ""; // æ¸…ç©ºèˆŠå»ºè­°
    if(!k) { sug.style.display = "none"; return; }
    
    // å°‹æ‰¾åŒ…å«é—œéµå­—çš„åå­—æˆ–æ¨™ç±¤
    const matches = spots.filter(s => s.name.includes(k) || s.tags.some(t => t.includes(k)));
    if(matches.length > 0) {
        sug.style.display = "block";
        matches.forEach(s => {
            const div = document.createElement("div"); div.className = "list-item"; 
            div.innerHTML = `<span><i class="fas fa-map-marker-alt"></i> ${s.name}</span>`;
            // é»æ“Šå»ºè­°å¾Œï¼šé£›å‘åœ°é» -> éš±è—ä¸‹æ‹‰æ¡† -> å¡«å…¥æ–‡å­— -> å½ˆå‡ºå¡ç‰‡
            div.onclick = () => { 
                map.flyTo([s.lat, s.lng], 16); sug.style.display = "none"; 
                document.getElementById("search").value = s.name; 
                setTimeout(() => showCard(s), 800); 
            };
            sug.appendChild(div);
        });
    } else { sug.style.display = "none"; }
};
</script>
</body>

</html>
